# pr-01_spec.md — schema v0: core tables + constraints (slice 0)

this pr creates the **slice-0 database schema** exactly as required by `s0_spec.md`.
no business logic, auth, or endpoints in this pr.

---

## goal

add migrations that create the slice-0 tables, enums, constraints, and indexes so later prs can build on a stable schema.

---

## scope

### includes
- postgres enum types:
  - `library_role`
  - `sharing`
  - `media_kind`
  - `processing_status`
- tables:
  - `users`
  - `libraries`
  - `library_users`
  - `media`
  - `library_media`
  - `highlights` (stub)
- all foreign keys, uniques, check constraints, and indexes listed below

### excludes
- any api endpoints
- any application logic / repository code
- any auth
- rls policies
- triggers
- updated_at columns
- conversations/messages tables (not needed for s0 gating tests)

---

## hard decisions (locked)

- enum implementation: **postgres enum types**
- id generation:
  - `users.id` is provided by app (supabase `sub`) — no default
  - all other `id` columns default to `gen_random_uuid()`
- timestamps: `created_at timestamptz not null default now()`
- `libraries.name` is nullable; no uniqueness constraint
- default library constraints:
  - one default library per owner (`(owner_user_id) unique where is_default=true`)
  - non-shareability enforced in service layer later (no triggers)
- highlight anchor constraint:
  - `sharing='library'` requires `anchor_media_id is not null` (db check constraint)
- media_kind uses real values now: `web_article | epub | pdf`
- processing_status minimal values now: `pending | ready_for_reading | failed`
- foreign keys:
  - delete user cascades to their highlights
  - media rows are not deletable in v1: references use RESTRICT/NO ACTION
  - deleting a non-default library (future) cascades to pivot rows

---

## migration files

create exactly one new migration under `apps/api/migrations/versions/`:

- `apps/api/migrations/versions/0001_schema_v0_slice0.py`

it must be reversible (`upgrade()` and `downgrade()`).

---

## schema (authoritative)

### required extensions

enable pgcrypto (for `gen_random_uuid()`):

- `CREATE EXTENSION IF NOT EXISTS pgcrypto;`

(if your postgres image already has it, this is still safe.)

---

### enum types

create these enums:

- `library_role`: `admin`, `member`
- `sharing`: `private`, `library`, `public`
- `media_kind`: `web_article`, `epub`, `pdf`
- `processing_status`: `pending`, `ready_for_reading`, `failed`

notes:
- do not include extra values “for later”
- enum additions happen in later migrations only

---

### table: users

columns:
- `id uuid primary key` (no default)
- `email text null`
- `created_at timestamptz not null default now()`

constraints:
- none beyond pk

indexes:
- none required in s0

---

### table: libraries

columns:
- `id uuid primary key default gen_random_uuid()`
- `owner_user_id uuid not null references users(id) on delete cascade`
- `is_default boolean not null default false`
- `name text null`
- `created_at timestamptz not null default now()`

constraints:
- partial unique index:
  - one default library per owner:
    - unique (owner_user_id) where is_default = true

indexes:
- `idx_libraries_owner_user_id` on (owner_user_id)
- `idx_libraries_is_default` on (is_default)

note:
- we intentionally do NOT enforce “default cannot be shared” at the db layer in v1.

---

### table: library_users

columns:
- `library_id uuid not null references libraries(id) on delete cascade`
- `user_id uuid not null references users(id) on delete cascade`
- `role library_role not null`
- `created_at timestamptz not null default now()`

constraints:
- primary key: `(library_id, user_id)` (enforces membership uniqueness)

indexes:
- `idx_library_users_user_id` on (user_id)
- `idx_library_users_library_id` on (library_id)

notes:
- invariants like “must retain one admin” are enforced in service logic later (no triggers).

---

### table: media

columns:
- `id uuid primary key default gen_random_uuid()`
- `kind media_kind not null`
- `processing_status processing_status not null default 'pending'`
- `created_at timestamptz not null default now()`

constraints:
- none beyond not nulls

indexes:
- `idx_media_kind` on (kind)
- `idx_media_processing_status` on (processing_status)

---

### table: library_media

columns:
- `library_id uuid not null references libraries(id) on delete cascade`
- `media_id uuid not null references media(id) on delete restrict`
- `created_at timestamptz not null default now()`

constraints:
- primary key: `(library_id, media_id)` (enforces unique membership)

indexes:
- `idx_library_media_library_id` on (library_id)
- `idx_library_media_media_id` on (media_id)

---

### table: highlights (stub)

columns:
- `id uuid primary key default gen_random_uuid()`
- `owner_user_id uuid not null references users(id) on delete cascade`
- `sharing sharing not null default 'library'`
- `anchor_media_id uuid null references media(id) on delete restrict`
- `created_at timestamptz not null default now()`

constraints:
- check: `sharing != 'library' OR anchor_media_id IS NOT NULL`

indexes:
- `idx_highlights_owner_user_id` on (owner_user_id)
- `idx_highlights_anchor_media_id` on (anchor_media_id)

notes:
- no uniqueness constraints for offsets in s0 (offset fields do not exist yet)

---

## downgrade behavior

`downgrade()` must drop:
1) tables in reverse dependency order:
   - highlights
   - library_media
   - media
   - library_users
   - libraries
   - users
2) enum types:
   - processing_status
   - media_kind
   - sharing
   - library_role
3) extension `pgcrypto` should NOT be dropped in downgrade (leave it installed).

---

## tests (required in this pr)

add schema-focused integration tests under `apps/api/tests/`:

### file: `apps/api/tests/test_schema_v0.py`

tests (minimum):

1) **tables exist**
- query `information_schema.tables` for:
  - users, libraries, library_users, media, library_media, highlights

2) **enum types exist**
- query `pg_type`/`pg_enum` to confirm enum names and values exactly match

3) **default library uniqueness constraint exists**
- create one user
- insert two libraries with `is_default=true` for same owner
- second insert must fail (unique violation)

4) **library_users pk uniqueness**
- create user + library
- insert membership twice → second must fail

5) **library_media pk uniqueness**
- create library + media
- insert link twice → second must fail

6) **highlight anchor check constraint**
- create user + media
- insert highlight with `sharing='library'` and `anchor_media_id=null` must fail
- insert highlight with `sharing='private'` and `anchor_media_id=null` must succeed

7) **fk behaviors**
- delete user cascades highlights:
  - create user + highlight
  - delete user
  - highlight must be gone
- media delete restricted by library_media:
  - create media linked in library_media
  - attempt to delete media must fail

test notes:
- tests may use raw SQL via sqlalchemy engine/session (no repos yet)
- do not assert on exact postgres error strings; assert class/category (e.g., integrity error)

---

## commands (must pass)

from `apps/api`:

```bash
uv run alembic upgrade head
uv run pytest -q
uv run alembic downgrade -1
uv run alembic upgrade head


⸻

acceptance criteria

pr-01 is complete when:
	•	migration applies cleanly on an empty db
	•	migration downgrades cleanly by one revision
	•	schema tests pass
	•	tables/enums/constraints/indexes match this spec exactly
	•	no application logic or endpoints were added

⸻

guardrails

DO NOT:
	•	add “future” columns
	•	add triggers
	•	add rls policies
	•	add any endpoints
	•	add sqlmodel models (repositories come later)
	•	change the error envelope from pr-00

ONLY this schema work belongs in pr-01.
