# Nexus — PR-01 Spec (L3)

## Backend Platform + DB Schema

This PR establishes the backend foundation for Nexus.
It introduces infrastructure, schema, error semantics, and test scaffolding that **all future PRs depend on**.

This PR must strictly conform to:
- `constitution.md` (v1)
- `s0_spec.md` (L2)
- `s0_roadmap.md` (L3)

No domain logic beyond schema and platform concerns is allowed.

---

## 0. Goals and Non-Goals

### Goals

PR-01 establishes:
- A bootable FastAPI application
- Environment-safe configuration loading
- Canonical API response envelopes
- Database engine, sessions, and transactions
- Alembic migrations for Slice 0 schema
- Deterministic test isolation
- A health endpoint for liveness checks

### Non-Goals

PR-01 explicitly does **not** include:
- Authentication or authorization logic
- Any Supabase/JWKS integration
- Any business/domain services
- Any API routes beyond `/health`
- Any data seeding (fixtures live in tests only)
- Any Next.js or frontend code
- Readiness endpoint (`/ready` deferred to PR-02 when DB is exercised by routes)

---

## 1. Runtime and Tooling (Hard Constraints)

### 1.1 Versions

- **Python:** 3.12 (pin via `.python-version`)
- **PostgreSQL:** 15+
- **Dependency management:** `uv`
- **Web framework:** FastAPI (sync)
- **ASGI server:** uvicorn
- **DB driver:** psycopg (v3, not psycopg2)
- **ORM:** SQLAlchemy 2.x (sync)
- **Migrations:** Alembic
- **Testing:** pytest + httpx (TestClient)
- **Formatting + linting:** ruff (single tool)

No async DB stack is permitted in v1.

### 1.2 Dependency Pinning

- Commit `uv.lock` to the repository.
- Commit `.python-version` containing `3.12`.
- All dependencies specified in `pyproject.toml`.
- CI installs via `uv sync --frozen` (fails if lock is stale).

### 1.3 Allowed Dependencies

PR-01 may only introduce:
- `fastapi`
- `uvicorn[standard]`
- `sqlalchemy[postgresql-psycopg]`
- `alembic`
- `pydantic-settings`
- `ruff` (dev)
- `pytest` (dev)
- `httpx` (dev)

No other runtime or dev dependencies are permitted without explicit justification.

---

## 2. API Versioning Policy

The API is internal to the web application. There is no public API in v1.

- No `/v1/` prefix on routes.
- Breaking changes are permitted with coordinated frontend + backend deploys.
- If a versioned public API is needed later, it will be a separate system boundary.

This choice eliminates "/v1 vs no prefix" bikeshedding. The API contract is enforced by the BFF layer.

---

## 3. Application Structure

```
app/
├── main.py
├── settings.py
├── errors.py
└── db/
    ├── engine.py
    ├── session.py
    └── testing.py
alembic/
├── alembic.ini
├── env.py
└── versions/
    └── 0001_slice0_schema.py
tests/
├── conftest.py
├── test_health.py
├── test_errors.py
└── test_migrations.py
.python-version
pyproject.toml
uv.lock
```

---

## 4. Configuration and Environments

### 4.1 Environment Variable Contract

| Variable | Required | Notes |
|----------|----------|-------|
| `NEXUS_ENV` | optional | defaults to `local` |
| `DATABASE_URL` | always | must be set in all envs |
| `NEXUS_INTERNAL_SECRET` | staging/prod | crash if missing |

Allowed `NEXUS_ENV` values:
- `local`
- `test`
- `staging`
- `prod`

### 4.2 DATABASE_URL Format

The URL must use the psycopg dialect:

```
postgresql+psycopg://user:password@host:port/database
```

Examples:
- Local: `postgresql+psycopg://postgres:postgres@localhost:5432/nexus_dev`
- Test: `postgresql+psycopg://postgres:postgres@localhost:5432/nexus_test`

### 4.3 Settings Enforcement

- Settings are loaded via a single Pydantic `Settings` object.
- In `staging` or `prod`:
  - missing `DATABASE_URL` → crash at startup
  - missing `NEXUS_INTERNAL_SECRET` → crash at startup
- In `local` or `test`:
  - `NEXUS_INTERNAL_SECRET` may be unset

---

## 5. Test Database Provisioning

### 5.1 Local Development

Developers must have PostgreSQL running locally. Options:
1. Native PostgreSQL installation
2. Docker: `docker run -d -p 5432:5432 -e POSTGRES_PASSWORD=postgres postgres:15`
3. Docker Compose (provided in repo)

Before running tests:
```bash
createdb nexus_test  # or via docker exec
```

### 5.2 Default Test DATABASE_URL

If `DATABASE_URL` is not set, tests fail immediately with a clear error. No fallback.

Recommended `.env.test`:
```
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/nexus_test
NEXUS_ENV=test
```

### 5.3 CI Provisioning

CI must start PostgreSQL before tests. Options:
- GitHub Actions: `services.postgres` container
- Docker Compose: `docker compose -f docker-compose.test.yml up -d`

The CI workflow must:
1. Start PostgreSQL
2. Set `DATABASE_URL` in environment
3. Run `alembic upgrade head` (via pytest fixture or explicitly)
4. Run tests

### 5.4 Alembic URL

Alembic reads `DATABASE_URL` from environment in `alembic/env.py`. No separate config.

---

## 6. API Response Envelope (Global)

### Success

```json
{ "data": ... }
```

- Used for all 200 and 201 responses.
- 204 No Content responses return no body.

### Error

```json
{
  "error": {
    "code": "E_...",
    "message": "Human-readable message"
  }
}
```

### Error Handling Rules

- All errors must be enveloped.
- Unexpected exceptions:
  - Are logged server-side
  - Return 500 with code `E_INTERNAL`
  - Never leak stack traces or internal details

---

## 7. Error Codes (Slice 0 Subset)

| Code | HTTP | Description |
|------|------|-------------|
| `E_UNAUTHENTICATED` | 401 | Auth missing or invalid |
| `E_FORBIDDEN` | 403 | Authorization failure |
| `E_INTERNAL_ONLY` | 403 | Missing internal header |
| `E_NOT_FOUND` | 404 | Resource not found |
| `E_INVALID_REQUEST` | 400 | Malformed or invalid request |
| `E_INTERNAL` | 500 | Unhandled server error |

**PR-01 scope:** Define all codes in the enum and error→status mapping. Only `E_INTERNAL` and `E_INVALID_REQUEST` (for malformed JSON) are exercised in PR-01. Other codes are tested in later PRs.

---

## 8. Database Layer

### 8.1 Engine and Sessions

- SQLAlchemy engine created once at startup via `create_engine()`.
- `SessionLocal` via `sessionmaker(autocommit=False, autoflush=False)`.
- Connection pool settings: use SQLAlchemy defaults for now.
- No global sessions; sessions are request-scoped.
- Explicit transactions for all mutations.

### 8.2 get_db() Dependency

Define `get_db()` as a FastAPI dependency in PR-01, even though only `/health` exists (and doesn't use it).

```python
def get_db() -> Generator[Session, None, None]:
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

Routes in future PRs will declare `db: Session = Depends(get_db)`.

### 8.3 transaction() Context Manager

```python
@contextmanager
def transaction(db: Session):
    try:
        yield
        db.commit()
    except Exception:
        db.rollback()
        raise
```

All mutations must be wrapped in `transaction()`. This is enforced by code review.

---

## 9. Test Isolation Strategy

### 9.1 DB Interaction Tests

Tests that query/mutate the database use:
- One DB connection per test
- Outer transaction started before test
- Nested transaction (savepoint) inside test
- Full rollback after test completes

This guarantees:
- Fast tests (no full DB reset)
- No cross-test leakage
- Real transactional behavior

### 9.2 Migration Tests

Migration tests **cannot** use the nested transaction fixture because they mutate the schema.

Migration tests run in a separate pytest file (`test_migrations.py`) and:
- Assume a fresh database or clean state
- Run `alembic upgrade head` explicitly
- Run `alembic downgrade base` explicitly
- Must run serially (not parallelized)

### 9.3 Test Fixture Separation

```python
# conftest.py

@pytest.fixture
def db_session():
    """For tests that need DB access (uses savepoint rollback)."""
    ...

# test_migrations.py does NOT import db_session fixture
# It manages its own connection and runs alembic commands
```

---

## 10. Alembic Migrations (Slice 0 Schema)

### 10.1 Naming Convention

- Revision message: `slice0_schema`
- File name: `0001_slice0_schema.py`
- Future migrations: `0002_<description>.py`, `0003_<description>.py`, etc.

### 10.2 Extensions

Migration must include:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

This enables `gen_random_uuid()`.

### 10.3 Schema Definition (Authoritative)

PR-01 migration creates these tables with **exact** constraints:

#### users

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

#### libraries

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `owner_user_id` | `UUID` | `NOT NULL REFERENCES users(id) ON DELETE CASCADE` |
| `name` | `TEXT` | `NOT NULL CHECK (char_length(name) BETWEEN 1 AND 100)` |
| `is_default` | `BOOLEAN` | `NOT NULL DEFAULT false` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |
| `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Partial unique index:**
```sql
CREATE UNIQUE INDEX uix_libraries_one_default_per_user
ON libraries (owner_user_id)
WHERE is_default = true;
```

#### memberships

| Column | Type | Constraints |
|--------|------|-------------|
| `library_id` | `UUID` | `NOT NULL REFERENCES libraries(id) ON DELETE CASCADE` |
| `user_id` | `UUID` | `NOT NULL REFERENCES users(id) ON DELETE CASCADE` |
| `role` | `TEXT` | `NOT NULL CHECK (role IN ('admin', 'member'))` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Primary key:** `(library_id, user_id)`

#### media

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `kind` | `TEXT` | `NOT NULL CHECK (kind IN ('web_article', 'epub', 'pdf', 'video', 'podcast_episode'))` |
| `title` | `TEXT` | `NOT NULL` |
| `author` | `TEXT` | |
| `canonical_source_url` | `TEXT` | |
| `processing_status` | `TEXT` | `NOT NULL DEFAULT 'pending' CHECK (processing_status IN ('pending', 'processing', 'completed', 'failed'))` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |
| `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

#### fragments

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `media_id` | `UUID` | `NOT NULL REFERENCES media(id) ON DELETE CASCADE` |
| `idx` | `INTEGER` | `NOT NULL` |
| `canonical_text` | `TEXT` | `NOT NULL` |
| `html_sanitized` | `TEXT` | `NOT NULL` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Unique constraint:**
```sql
UNIQUE (media_id, idx)
```

#### library_media

| Column | Type | Constraints |
|--------|------|-------------|
| `library_id` | `UUID` | `NOT NULL REFERENCES libraries(id) ON DELETE CASCADE` |
| `media_id` | `UUID` | `NOT NULL REFERENCES media(id) ON DELETE CASCADE` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Primary key:** `(library_id, media_id)`

### 10.4 Migration Rules

- Migration must apply cleanly to an empty database.
- Migration must be reversible.
- No seed data in migrations.

### 10.5 Rollback Target

PR-01 tests must verify:
- `alembic upgrade head` succeeds
- `alembic downgrade base` succeeds (full rollback to empty)

Future PRs test their own migration up/down without touching earlier revisions.

---

## 11. Health Endpoint

### `GET /health`

**Purpose:** Liveness check only.

**Response:**

```json
{ "data": { "status": "ok" } }
```

- Does not touch the database.
- Does not require authentication.
- Must always return 200 if the process is running.

**Note:** A readiness endpoint (`/ready`) that checks DB connectivity is deferred to PR-02, when routes actually use the database.

---

## 12. Tests (Required)

### 12.1 Unit Tests (`test_errors.py`)

- Error envelope shape is correct
- Every error code maps to correct HTTP status
- Unknown exception → `E_INTERNAL` with 500
- `E_INVALID_REQUEST` returned for malformed JSON body

### 12.2 Migration Tests (`test_migrations.py`)

**Run separately, not under savepoint fixture.**

- `alembic upgrade head` succeeds on empty DB
- `alembic downgrade base` succeeds (full rollback)
- After upgrade, schema constraints enforced:
  - Duplicate default library for same user rejected (partial unique index)
  - Duplicate membership for same (library_id, user_id) rejected
  - Invalid `role` value rejected
  - Invalid `kind` value rejected
  - Invalid `processing_status` value rejected
  - `name` length constraints enforced (1-100 chars)

### 12.3 DB Smoke Test (`test_db.py`)

- Open session via `get_db()`
- Execute `SELECT 1`
- Session closes cleanly

### 12.4 API Test (`test_health.py`)

- `GET /health` returns 200 with `{ "data": { "status": "ok" } }`

---

## 13. Acceptance Criteria

PR-01 is complete when:
- FastAPI app boots successfully
- Settings validation behaves correctly per environment
- All responses are properly enveloped
- `E_INTERNAL` is returned on unhandled exceptions
- `E_INVALID_REQUEST` is returned for malformed JSON
- Alembic migration applies and rolls back cleanly
- All schema constraints match this spec exactly
- Test isolation via transactions works
- Migration tests run separately without savepoint fixture
- All PR-01 tests pass deterministically
- `uv.lock` and `.python-version` are committed
- No domain logic is present
- No TODOs for platform invariants

---

## 14. Explicit Non-Extensibility Clause

PR-01 must **not**:
- Introduce auth middleware
- Introduce request context (`viewer_user_id`)
- Introduce service-layer logic
- Introduce seed data outside tests
- Introduce frontend concerns
- Introduce async DB access
- Introduce dependencies not in the allow-list

Those belong to later PRs.

---

## 15. Exit Condition

When merged:
- Main branch is a stable backend platform
- PR-02 can assume DB + error + test infrastructure exists
- No rework of PR-01 is expected later

**Tag the merge commit:** `slice-0-pr-01-complete`
