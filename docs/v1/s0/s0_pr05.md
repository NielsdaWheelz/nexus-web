# Nexus — PR-05 Spec (L3)
## Next.js BFF + UI Shell + Onboarding

This PR completes Slice 0 by adding the browser layer.
It must not weaken any invariant defined in `constitution.md` or `s0_spec.md`.

FastAPI behavior is assumed correct and complete by the end of PR-04.
This PR may not modify backend semantics, **except**:
- One test-only endpoint (`/__test/echo_headers`) guarded by `NEXUS_ENV=test` (see §9)

---

## 0. Goals and Non-Goals

### Goals
- Enforce the **BFF-only** access model in practice
- Provide a minimal but real UI for Slice 0:
  - auth
  - libraries
  - media viewing
- Prove end-to-end correctness: browser → next.js → fastapi → db
- Enable clean local onboarding for new developers

### Non-Goals
- No highlights, annotations, chat, ingestion UI
- No direct FastAPI access from browser
- No client-side auth tokens
- No iframe document rendering
- No design polish beyond functional UX

---

## 1. Runtime and Deployment Constraints

### Next.js Runtime
- All `/app/api/**/route.ts` handlers **MUST run in Node runtime**
- Explicitly set where ambiguous:

```ts
export const runtime = "nodejs";
```

Edge runtime is forbidden in Slice 0.

### Environment Variables (Server-Only)

The following must **not** be exposed via `NEXT_PUBLIC_*`:
- `FASTAPI_BASE_URL`
- `NEXUS_INTERNAL_SECRET`
- `NEXUS_ENV`

If any are missing in staging or prod, the app must fail fast at startup.

---

## 2. Authentication Model (Frontend)

### Supabase Integration

- Use `@supabase/ssr`
- Session stored in cookies managed by `@supabase/ssr`
- Access tokens:
  - Read server-side only
  - Never returned to the browser via our APIs
  - Never stored in localStorage/sessionStorage
  - Cookies SHOULD be httpOnly where supported; if not possible, tokens must only exist in memory client-side

**Hard rule:** Our code never writes access tokens to localStorage or sessionStorage.

### Auth Flow

- `/login` page:
  - Uses Supabase client directly (client-side auth)
  - Email + password
  - Success → redirect `/libraries`
  - Session cookies refreshed via middleware
- `/logout`:
  - Clears Supabase session
  - Redirect `/login`

### Auth Guard

- **Pages** (except `/login`):
  - If unauthenticated → redirect `/login`
  - Implement via middleware or server component guards
- **API routes** (`/api/*`):
  - If unauthenticated → return 401 `{ error: { code: "E_UNAUTHENTICATED", ... } }`
  - Do NOT redirect from API handlers

**Critical distinction:** Pages redirect; API routes return errors. Don't mix these behaviors.

---

## 3. BFF Proxy (Hard Security Boundary)

### Rule

**The browser has no supported path to call FastAPI directly.**

- All browser → backend traffic goes through Next.js route handlers
- FastAPI rejects requests without `X-Nexus-Internal` header in staging/prod
- Ideally FastAPI is not publicly routable (private network), but this is not guaranteed

We cannot prevent a user from discovering and calling the FastAPI URL, but we ensure it rejects unauthorized requests.

### Route Mirroring

Each FastAPI route has a corresponding Next.js handler with the same path:

| Next.js | FastAPI |
|---------|---------|
| `/api/me` | `/me` |
| `/api/libraries` | `/libraries` |
| `/api/libraries/[id]` | `/libraries/{id}` |
| `/api/libraries/[id]/media` | `/libraries/{id}/media` |
| `/api/libraries/[id]/media/[mediaId]` | `/libraries/{id}/media/{media_id}` |
| `/api/media/[id]` | `/media/{id}` |
| `/api/media/[id]/fragments` | `/media/{id}/fragments` |

No generic catch-all proxy.

### Route Handler Constraints (Strict)

Each `/app/api/**/route.ts` handler:
- MUST be **3–10 lines** of actual logic
- MUST delegate to `proxyToFastAPI()` for all backend communication
- MUST NOT perform custom request shaping beyond path parameters
- MUST NOT add business logic (that belongs in FastAPI)

Example of compliant handler:

```ts
export async function GET(req: Request, { params }: { params: { id: string } }) {
  return proxyToFastAPI(req, `/libraries/${params.id}`);
}
```

---

### Shared Proxy Helper

Create a single helper used by all route handlers:

```ts
async function proxyToFastAPI(
  req: Request,
  path: string,
  options?: { body?: unknown }
): Promise<Response>
```

**Behavior:**
- Extract Supabase access token server-side
- Attach headers:
  - `Authorization: Bearer <access_token>`
  - `X-Nexus-Internal: <secret>`
- Forward:
  - Method
  - JSON body (if present)
- Do **not** forward:
  - Cookies
  - Origin / Referer
  - Host
  - Any `x-forwarded-*` from browser

**Response handling:**
- Pass through: HTTP status, response body (unchanged)
- Pass through headers: `Content-Type`, `Cache-Control`
- Strip headers: `Set-Cookie` (FastAPI should not set cookies)

**Failure Modes:**
- Missing session → return 401 `{ error: { code: "E_UNAUTHENTICATED", ... } }`
- FastAPI error → return exact envelope unchanged

---

## 4. Error Handling Contract (Frontend)

### Fetch Wrapper

All UI code must use a single fetch abstraction:

```ts
apiFetch<T>(path, options) -> Promise<T>
```

**Semantics:**
- `{ data }` → resolve
- `{ error }` → throw `ApiError(code, message, status)`

### Global Handling

- 401 → redirect `/login`
- 404 → render "not found" pane
- 403 → render "forbidden" pane
- Other errors → inline error banner

No ad-hoc error parsing in components.

---

## 5. HTML Rendering Safety

### Rule (Hard)

`dangerouslySetInnerHTML` is allowed in **exactly one place**.

### HtmlRenderer Component

Create: `components/HtmlRenderer.tsx`

- Accepts only `html_sanitized: string`
- Uses `dangerouslySetInnerHTML`
- No other component may use it

**S0 Constraints:**
- Render HTML as-is from `html_sanitized` field
- Do NOT perform additional client-side sanitization or DOM mutation
- Do NOT fetch remote resources (images render as-is from fixture; no proxy rewrite in S0)
- Images in fixture HTML will display if src is reachable; no error handling required

**Future:** S1+ will add image proxy rewriting before rendering.

### Enforcement

- ESLint rule or test that fails CI if `dangerouslySetInnerHTML` appears elsewhere

Annotations, messages, and all user text render as plain text only.

---

## 6. UI Shell Requirements

### Layout Primitives

- Collapsible left navbar
- Tabsbar (top)
- Horizontal panes (desktop)

### Desktop Behavior

- Multiple panes allowed
- Panes horizontally scrollable (overflow container)
- Basic resize handles (no persistence required)

**Pane Sizing (Acceptance Criteria):**

| Property | Value |
|----------|-------|
| Default width | 480px |
| Minimum width | 280px |
| Maximum width | 900px |
| Resize handle hit area | 8px wide, full height |

- Pane widths are not persisted across sessions (S0 scope)
- Resize handles must be visually indicated (cursor change, subtle border)

### Mobile Behavior

- Single-pane mode only
- Opening a library or media replaces the view
- Back button returns to previous view

No attempt to support touch-based resizing.

---

## 7. Pages and Navigation

### Routes

- `/` → redirect `/libraries`
- `/login`
- `/libraries`
- `/libraries/[id]`
- `/media/[id]`

### Library UI (Minimal but Functional)

- Create library
- Rename non-default library
- Delete non-default library (confirmation required)
- List libraries (member only)
- List media in library

### Media View

- Fetch fragments
- Render `html_sanitized` via `HtmlRenderer`
- No highlights, no interactions

### Empty States

- No libraries → prompt to create
- No media → "no media yet"

---

## 8. CSP (Baseline with Nonce Support)

Next.js injects inline scripts for hydration. A naive `script-src 'self'` will break production builds.

### Required CSP Policy

Use **nonce-based CSP**:

```
script-src 'self' 'nonce-{GENERATED_NONCE}'
style-src 'self' 'unsafe-inline'
object-src 'none'
base-uri 'self'
frame-ancestors 'none'
```

### Implementation

- Generate a unique nonce per request (crypto random, base64)
- Pass nonce to Next.js `<Script>` components
- Set CSP header in middleware or `next.config.js` headers

**Forbidden:**
- `'unsafe-eval'` (never)
- `'unsafe-inline'` for scripts (use nonces instead)

### Fallback (If Nonces Are Too Complex for S0)

If nonce implementation is blocked, defer CSP to S1 and document the gap:
- Add a TODO in code
- Do NOT ship `'unsafe-inline'` for scripts as a "temporary" fix

No YouTube/embed allowances needed in Slice 0.

---

## 9. Test Requirements

### Test Categories (Three-Tier)

**Tier 1: Backend Integration (PR-04)**
Already exists — full FastAPI + DB tests. Not duplicated here.

**Tier 2: BFF Smoke Tests (Required, Real Stack)**
End-to-end tests hitting Next.js → FastAPI → DB.

**Tier 3: Frontend Unit Tests (Mocks Allowed)**
Component-level tests with mocked `fetch`. These test UI behavior, not backend integration.

---

### BFF Smoke Tests (Tier 2)

**Minimum 3 required:**

1. Bearer token forwarded correctly to FastAPI
2. `X-Nexus-Internal` header attached by proxy
3. Direct FastAPI call without internal header → 403 (when `NEXUS_ENV=staging`)

**Test-only endpoint exception:**

Add `/__test/echo_headers` to FastAPI:
- Enabled ONLY when `NEXUS_ENV=test`
- Returns request headers as JSON
- Excluded from production builds

This is the **only** backend change permitted in PR-05. Carve-out rationale: cannot verify header attachment end-to-end without an echo endpoint, and mocking defeats the purpose of BFF smoke tests.

---

### Frontend Unit Tests (Tier 3)

These MAY mock `fetch` responses to test UI behavior:

- Navigation: Libraries → library → media
- Auth redirect behavior (unauthenticated → /login)
- Pane renders and resizes (desktop)
- Mobile single-pane rendering
- Error states render correctly (404, 403, generic)

**Rationale:** Full-stack e2e for every UI test is slow and flaky. Backend correctness is proven by PR-04 tests. Frontend tests verify UI logic with mocked API responses.

---

### Forbidden

- Snapshot tests of HTML content (brittle, low value)
- Mocked backend in BFF smoke tests (Tier 2 must hit real stack)
- Direct FastAPI calls from test code (use Next.js routes)

---

## 10. Documentation and Scripts

### Required Files

- `README.md`
  - Local setup
  - Env vars
  - Dev flow
- `CONTRIBUTING.md`
  - Test commands
  - PR checklist
- `scripts/dev-up.sh`
- `scripts/test.sh`
- `scripts/seed_dev.py`

### Seed Script Rules

- Creates fixture media + fragment
- Never runs automatically
- Never included in migrations

---

## 11. Exit Criteria

PR-05 is complete when:
- Browser has no supported path to call FastAPI directly
- FastAPI rejects direct calls without internal header (verified by smoke test)
- Tokens never leave server runtime (never in localStorage/sessionStorage)
- All Slice-0 endpoints reachable via UI
- All BFF smoke tests pass (3 minimum)
- Frontend unit tests pass
- Frontend navigation works end-to-end
- No invariant regressions
- New developer can run app from README alone

**Tag merge commit:** `slice-0-complete`
