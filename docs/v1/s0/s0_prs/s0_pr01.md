# Nexus — PR-01 Spec (L3)

## Backend Platform + DB Schema

This PR establishes the backend foundation for Nexus.
It introduces infrastructure, schema, error semantics, and test scaffolding that **all future PRs depend on**.

This PR must strictly conform to:
- `constitution.md` (v1)
- `s0_spec.md` (L2)
- `s0_roadmap.md` (L3)

No domain logic beyond schema and platform concerns is allowed.

---

## 0. Goals and Non-Goals

### Goals

PR-01 establishes:
- A bootable FastAPI application
- Environment-safe configuration loading
- Canonical API response envelopes
- Database engine, sessions, and transactions
- Alembic migrations for Slice 0 schema
- Deterministic test isolation
- A health endpoint for liveness checks
- Professional monorepo structure with shared Python package

### Non-Goals

PR-01 explicitly does **not** include:
- Authentication or authorization logic
- Any Supabase/JWKS integration
- Any business/domain services
- Any API routes beyond `/health`
- Any data seeding (fixtures live in tests only)
- Any Next.js or frontend code
- Readiness endpoint (`/ready` deferred to PR-02 when DB is exercised by routes)

---

## 1. Runtime and Tooling (Hard Constraints)

### 1.1 Versions

- **Python:** 3.12 (pin via `.python-version` in `python/`)
- **PostgreSQL:** 15+
- **Dependency management:** `uv`
- **Web framework:** FastAPI (sync)
- **ASGI server:** uvicorn
- **DB driver:** psycopg (v3, not psycopg2)
- **ORM:** SQLAlchemy 2.x (sync)
- **Migrations:** Alembic
- **Testing:** pytest + httpx (TestClient)
- **Formatting + linting:** ruff (single tool)

No async DB stack is permitted in v1.

### 1.2 Dependency Pinning

- Commit `uv.lock` to the repository (in `python/`).
- Commit `.python-version` containing `3.12` (in `python/`).
- All dependencies specified in `python/pyproject.toml`.
- CI installs via `uv sync --frozen` (fails if lock is stale).

### 1.3 Allowed Dependencies

PR-01 may only introduce:
- `fastapi`
- `uvicorn[standard]`
- `sqlalchemy[postgresql-psycopg]`
- `alembic`
- `pydantic-settings`
- `ruff` (dev)
- `pytest` (dev)
- `httpx` (dev)

No other runtime or dev dependencies are permitted without explicit justification.

---

## 2. API Versioning Policy

The API is internal to the web application. There is no public API in v1.

- No `/v1/` prefix on routes.
- Breaking changes are permitted with coordinated frontend + backend deploys.
- If a versioned public API is needed later, it will be a separate system boundary.

This choice eliminates "/v1 vs no prefix" bikeshedding. The API contract is enforced by the BFF layer.

---

## 3. Project Structure

### 3.1 Monorepo Layout

```
nexus/
├── apps/                        # Application entrypoints (thin launchers)
│   ├── api/                     # FastAPI server
│   │   └── main.py             # Imports from nexus, runs uvicorn
│   ├── web/                     # Next.js BFF + frontend (PR-05+)
│   └── worker/                  # Celery worker (future)
│       └── main.py             # Placeholder
│
├── python/                      # Shared Python package
│   ├── nexus/                   # THE package
│   │   ├── __init__.py
│   │   ├── config.py           # Pydantic settings
│   │   ├── errors.py           # Error code definitions
│   │   ├── responses.py        # Response envelope helpers
│   │   ├── app.py              # FastAPI app creation
│   │   ├── api/                # HTTP layer
│   │   │   ├── __init__.py
│   │   │   ├── deps.py         # FastAPI dependencies
│   │   │   └── routes/         # Route handlers
│   │   │       ├── __init__.py
│   │   │       └── health.py
│   │   └── db/                 # Database layer
│   │       ├── __init__.py
│   │       ├── engine.py
│   │       └── session.py
│   ├── tests/                   # Python tests
│   │   ├── __init__.py
│   │   ├── conftest.py
│   │   ├── utils/
│   │   │   └── db.py           # Test isolation utilities
│   │   ├── test_health.py
│   │   ├── test_errors.py
│   │   ├── test_db.py
│   │   └── test_migrations.py
│   ├── pyproject.toml
│   ├── uv.lock
│   ├── .python-version
│   └── README.md
│
├── migrations/                  # Database migrations
│   ├── alembic/
│   │   ├── env.py
│   │   ├── script.py.mako
│   │   └── versions/
│   │       └── 0001_slice0_schema.py
│   └── alembic.ini
│
├── docker/                      # Docker configs
│   ├── docker-compose.yml       # Local dev services
│   └── Dockerfile.api
│
├── scripts/                     # Development scripts
│   ├── agency_setup.sh
│   ├── agency_verify.sh
│   └── agency_archive.sh
│
├── docs/                        # Documentation
├── Makefile
├── README.md
└── .gitignore
```

### 3.2 Architecture Rationale

- **`python/nexus/`** is the single Python package imported by both API and worker
- **`apps/`** contains thin launchers - no code duplication between api/worker
- **`migrations/`** lives at root level, runs against the nexus package
- Tests target `python/nexus/` cleanly without starting web apps
- Import boundaries enforced: services don't import routers

---

## 4. Configuration and Environments

### 4.1 Environment Variable Contract

| Variable | Required | Notes |
|----------|----------|-------|
| `NEXUS_ENV` | optional | defaults to `local` |
| `DATABASE_URL` | always | must be set in all envs |
| `NEXUS_INTERNAL_SECRET` | staging/prod | crash if missing |

Allowed `NEXUS_ENV` values:
- `local`
- `test`
- `staging`
- `prod`

### 4.2 DATABASE_URL Format

The URL must use the psycopg dialect:

```
postgresql+psycopg://user:password@host:port/database
```

Examples:
- Local: `postgresql+psycopg://postgres:postgres@localhost:5432/nexus_dev`
- Test: `postgresql+psycopg://postgres:postgres@localhost:5432/nexus_test`

### 4.3 Settings Enforcement

- Settings are loaded via `nexus.config.Settings`.
- In `staging` or `prod`:
  - missing `DATABASE_URL` → crash at startup
  - missing `NEXUS_INTERNAL_SECRET` → crash at startup
- In `local` or `test`:
  - `NEXUS_INTERNAL_SECRET` may be unset

---

## 5. Test Database Provisioning

### 5.1 Local Development

Developers use Docker Compose for services:

```bash
cd docker
docker compose up -d
```

This starts PostgreSQL and Redis. Create test database:

```bash
docker exec nexus-postgres createdb -U postgres nexus_test
```

### 5.2 Default Test DATABASE_URL

If `DATABASE_URL` is not set, tests fail immediately with a clear error. No fallback.

### 5.3 CI Provisioning

CI must start PostgreSQL before tests. Options:
- GitHub Actions: `services.postgres` container
- Docker Compose: `docker compose -f docker/docker-compose.yml up -d`

The CI workflow must:
1. Start PostgreSQL
2. Set `DATABASE_URL` in environment
3. Run `alembic upgrade head` (via pytest fixture or explicitly)
4. Run tests

### 5.4 Alembic URL

Alembic reads `DATABASE_URL` from environment in `migrations/alembic/env.py`. No separate config.

---

## 6. API Response Envelope (Global)

### Success

```json
{ "data": ... }
```

- Used for all 200 and 201 responses.
- 204 No Content responses return no body.

### Error

```json
{
  "error": {
    "code": "E_...",
    "message": "Human-readable message"
  }
}
```

### Error Handling Rules

- All errors must be enveloped.
- Unexpected exceptions:
  - Are logged server-side
  - Return 500 with code `E_INTERNAL`
  - Never leak stack traces or internal details

---

## 7. Error Codes (Complete Slice 0 Set)

PR-01 defines **all** error codes for Slice 0 in the enum and error→status mapping. This ensures the error infrastructure is complete before domain logic is added.

| Code | HTTP | Description |
|------|------|-------------|
| `E_UNAUTHENTICATED` | 401 | Auth missing or invalid |
| `E_FORBIDDEN` | 403 | Authorization failure |
| `E_INTERNAL_ONLY` | 403 | Missing internal header |
| `E_DEFAULT_LIBRARY_FORBIDDEN` | 403 | Cannot delete/rename default library |
| `E_LAST_ADMIN_FORBIDDEN` | 403 | Cannot remove/demote last admin |
| `E_NOT_FOUND` | 404 | Generic resource not found |
| `E_LIBRARY_NOT_FOUND` | 404 | Library not found or not a member |
| `E_MEDIA_NOT_FOUND` | 404 | Media not found or not readable |
| `E_INVALID_REQUEST` | 400 | Malformed request body |
| `E_NAME_INVALID` | 400 | Name empty, too long, or invalid |
| `E_AUTH_UNAVAILABLE` | 503 | JWKS/auth infrastructure unavailable |
| `E_INTERNAL` | 500 | Unhandled server error |

**PR-01 scope:** Define all codes. Only `E_INTERNAL` and `E_INVALID_REQUEST` (for malformed JSON) are exercised in PR-01. Other codes are tested in later PRs.

---

## 8. Database Layer

### 8.1 Engine and Sessions

- SQLAlchemy engine created once at startup via `create_engine()`.
- Session factory via `sessionmaker(autocommit=False, autoflush=False)`.
- Connection pool settings: use SQLAlchemy defaults for now.
- No global sessions; sessions are request-scoped.
- Explicit transactions for all mutations.

### 8.2 get_db() Dependency

Defined in `nexus.api.deps`:

```python
def get_db() -> Generator[Session, None, None]:
    SessionLocal = get_session_factory()
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

Routes in future PRs will declare `db: Session = Depends(get_db)`.

### 8.3 transaction() Context Manager

Defined in `nexus.db.session`:

```python
@contextmanager
def transaction(db: Session):
    try:
        yield
        db.commit()
    except Exception:
        db.rollback()
        raise
```

All mutations must be wrapped in `transaction()`. This is enforced by code review.

---

## 9. Test Isolation Strategy

### 9.1 DB Interaction Tests

Tests that query/mutate the database use:
- One DB connection per test
- Outer transaction started before test
- Nested transaction (savepoint) inside test
- Full rollback after test completes

Test utilities live in `python/tests/utils/db.py`.

This guarantees:
- Fast tests (no full DB reset)
- No cross-test leakage
- Real transactional behavior

### 9.2 Migration Tests

Migration tests **cannot** use the nested transaction fixture because they mutate the schema.

Migration tests run in a separate pytest file (`test_migrations.py`) and:
- Assume a fresh database or clean state
- Run `alembic upgrade head` explicitly
- Run `alembic downgrade base` explicitly
- Must run serially (not parallelized)

### 9.3 Test Fixture Separation

```python
# tests/conftest.py

@pytest.fixture
def db_session():
    """For tests that need DB access (uses savepoint rollback)."""
    ...

# tests/test_migrations.py does NOT import db_session fixture
# It manages its own connection and runs alembic commands
```

---

## 10. Alembic Migrations (Slice 0 Schema)

### 10.1 Naming Convention

- Revision message: `slice0_schema`
- File name: `0001_slice0_schema.py`
- Future migrations: `0002_<description>.py`, `0003_<description>.py`, etc.

### 10.2 Extensions

Migration must include:

```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto;
```

This enables `gen_random_uuid()`.

### 10.3 Schema Definition (Authoritative)

PR-01 migration creates these tables with **exact** constraints:

#### users

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

#### libraries

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `owner_user_id` | `UUID` | `NOT NULL REFERENCES users(id) ON DELETE CASCADE` |
| `name` | `TEXT` | `NOT NULL CHECK (char_length(name) BETWEEN 1 AND 100)` |
| `is_default` | `BOOLEAN` | `NOT NULL DEFAULT false` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |
| `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Partial unique index:**
```sql
CREATE UNIQUE INDEX uix_libraries_one_default_per_user
ON libraries (owner_user_id)
WHERE is_default = true;
```

#### memberships

| Column | Type | Constraints |
|--------|------|-------------|
| `library_id` | `UUID` | `NOT NULL REFERENCES libraries(id) ON DELETE CASCADE` |
| `user_id` | `UUID` | `NOT NULL REFERENCES users(id) ON DELETE CASCADE` |
| `role` | `TEXT` | `NOT NULL CHECK (role IN ('admin', 'member'))` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Primary key:** `(library_id, user_id)`

#### media

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `kind` | `TEXT` | `NOT NULL CHECK (kind IN ('web_article', 'epub', 'pdf', 'video', 'podcast_episode'))` |
| `title` | `TEXT` | `NOT NULL` |
| `canonical_source_url` | `TEXT` | |
| `processing_status` | `TEXT` | `NOT NULL DEFAULT 'pending' CHECK (processing_status IN ('pending', 'extracting', 'ready_for_reading', 'embedding', 'ready', 'failed'))` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |
| `updated_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Note:** `author` is not included in S0. Metadata extraction (including authors) is added in S2.

#### fragments

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | `PRIMARY KEY DEFAULT gen_random_uuid()` |
| `media_id` | `UUID` | `NOT NULL REFERENCES media(id) ON DELETE CASCADE` |
| `idx` | `INTEGER` | `NOT NULL` |
| `canonical_text` | `TEXT` | `NOT NULL` |
| `html_sanitized` | `TEXT` | `NOT NULL` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Unique constraint:**
```sql
UNIQUE (media_id, idx)
```

#### library_media

| Column | Type | Constraints |
|--------|------|-------------|
| `library_id` | `UUID` | `NOT NULL REFERENCES libraries(id) ON DELETE CASCADE` |
| `media_id` | `UUID` | `NOT NULL REFERENCES media(id) ON DELETE CASCADE` |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL DEFAULT now()` |

**Primary key:** `(library_id, media_id)`

### 10.4 Migration Rules

- Migration must apply cleanly to an empty database.
- Migration must be reversible.
- No seed data in migrations.

### 10.5 Rollback Target

PR-01 tests must verify:
- `alembic upgrade head` succeeds
- `alembic downgrade base` succeeds (full rollback to empty)

Future PRs test their own migration up/down without touching earlier revisions.

---

## 11. Health Endpoint

### `GET /health`

**Purpose:** Liveness check only.

**Response:**

```json
{ "data": { "status": "ok" } }
```

- Does not touch the database.
- Does not require authentication.
- Must always return 200 if the process is running.

**Note:** A readiness endpoint (`/ready`) that checks DB connectivity is deferred to PR-02, when routes actually use the database.

---

## 12. Tests (Required)

### 12.1 Unit Tests (`test_errors.py`)

- Error envelope shape is correct
- Every error code maps to correct HTTP status
- Unknown exception → `E_INTERNAL` with 500
- `E_INVALID_REQUEST` returned for malformed JSON body

### 12.2 Migration Tests (`test_migrations.py`)

**Run separately, not under savepoint fixture.**

- `alembic upgrade head` succeeds on empty DB
- `alembic downgrade base` succeeds (full rollback)
- After upgrade, schema constraints enforced:
  - Duplicate default library for same user rejected (partial unique index)
  - Duplicate membership for same (library_id, user_id) rejected
  - Invalid `role` value rejected
  - Invalid `kind` value rejected
  - Invalid `processing_status` value rejected
  - `name` length constraints enforced (1-100 chars)

### 12.3 DB Smoke Test (`test_db.py`)

- Open session via `db_session` fixture
- Execute `SELECT 1`
- Session closes cleanly

### 12.4 API Test (`test_health.py`)

- `GET /health` returns 200 with `{ "data": { "status": "ok" } }`

---

## 13. Acceptance Criteria

PR-01 is complete when:
- FastAPI app boots successfully
- Settings validation behaves correctly per environment
- All responses are properly enveloped
- `E_INTERNAL` is returned on unhandled exceptions
- `E_INVALID_REQUEST` is returned for malformed JSON
- Alembic migration applies and rolls back cleanly
- All schema constraints match this spec exactly
- Test isolation via transactions works
- Migration tests run separately without savepoint fixture
- All PR-01 tests pass deterministically
- `uv.lock` and `.python-version` are committed (in `python/`)
- No domain logic is present
- No TODOs for platform invariants
- Monorepo structure with shared Python package in place

---

## 14. Explicit Non-Extensibility Clause

PR-01 must **not**:
- Introduce auth middleware
- Introduce request context (`viewer_user_id`)
- Introduce service-layer logic
- Introduce seed data outside tests
- Introduce frontend concerns
- Introduce async DB access
- Introduce dependencies not in the allow-list

Those belong to later PRs.

---

## 15. Scripts and Commands

### Setup

```bash
./scripts/agency_setup.sh
```

Or manually:

```bash
cd docker && docker compose up -d
cd python && uv sync --all-extras
cd migrations && DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/nexus_dev \
  uv run --project ../python alembic upgrade head
```

### Verify

```bash
./scripts/agency_verify.sh
```

Or manually:

```bash
cd python
uv run ruff check .
uv run ruff format --check .
DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/nexus_test \
  uv run pytest -v
```

### Start API Server

```bash
make api
```

Or manually:

```bash
cd apps/api
PYTHONPATH=$PWD/../../python DATABASE_URL=postgresql+psycopg://postgres:postgres@localhost:5432/nexus_dev \
  uv run --project ../../python uvicorn main:app --reload
```

---

## 16. Exit Condition

When merged:
- Main branch is a stable backend platform
- PR-02 can assume DB + error + test infrastructure exists
- No rework of PR-01 is expected later

**Tag the merge commit:** `slice-0-pr-01-complete`
