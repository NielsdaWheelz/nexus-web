# pr-00_spec.md — repo + test harness skeleton

this pr establishes the **non-negotiable project scaffold** for nexus.
all future prs must conform to the structure, tooling, and conventions introduced here.

no product logic ships in this pr.

---

## goal

create a runnable fastapi service and an integration test harness such that:
- the app boots deterministically in dev and test
- integration tests can hit real http endpoints
- database migrations can be applied and rolled back
- error handling is centralized and uniform

this pr defines the “shape of the codebase.”

---

## scope

### includes
- repository layout (apps/api)
- dependency management (uv + pyproject)
- fastapi app bootstrap
- config system
- database wiring (sync sqlalchemy)
- migrations framework (alembic)
- error envelope + exception handling
- integration test harness:
  - testcontainers postgres
  - in-process http client
- minimal health endpoint

### excludes
- supabase jwks verification
- auth middleware (except placeholder)
- user bootstrap
- any real business endpoints
- any schema beyond placeholder migration
- frontend code (apps/web may exist but empty)

---

## repository layout (hard constraint)

repo/
├─ apps/
│  ├─ api/
│  │  ├─ app/
│  │  │  ├─ main.py
│  │  │  ├─ core/
│  │  │  │  ├─ config.py
│  │  │  │  ├─ errors.py
│  │  │  │  └─ logging.py
│  │  │  ├─ db/
│  │  │  │  ├─ engine.py
│  │  │  │  ├─ session.py
│  │  │  │  └─ base.py
│  │  │  ├─ api/
│  │  │  │  └─ health.py
│  │  │  └─ init.py
│  │  ├─ migrations/
│  │  │  ├─ env.py
│  │  │  └─ versions/
│  │  ├─ tests/
│  │  │  ├─ conftest.py
│  │  │  └─ test_health.py
│  │  ├─ pyproject.toml
│  │  └─ README.md
├─ .gitignore
└─ README.md

notes:
- all backend code lives under `apps/api`
- no “src/” indirection
- tests live alongside the api they test

---

## dependency management

- tool: **uv**
- dependencies declared in `apps/api/pyproject.toml`
- lockfile committed

required runtime deps (minimum):
- fastapi
- uvicorn
- sqlalchemy (sync)
- psycopg2-binary (or equivalent)
- pydantic
- alembic

required dev/test deps:
- pytest
- httpx
- testcontainers
- ruff

no poetry, no requirements.txt.

---

## python + tooling standards

- python: **3.12**
- formatter + linter: **ruff**
- formatting and linting must pass in this pr

no mypy in pr-00.

---

## configuration system

### config loading
- pydantic settings model in `app/core/config.py`
- config is loaded once at startup
- environment variables only (no dotenv magic in prod)

minimum config fields:

```python
ENV: Literal["dev", "test", "prod"]
DATABASE_URL: str

placeholders allowed (not yet used):
	•	SUPABASE_JWKS_URL
	•	SUPABASE_JWT_ISSUER
	•	SUPABASE_JWT_AUDIENCE
	•	TEST_AUTH_SECRET

env semantics
	•	ENV=test enables test-only behaviors in later prs
	•	no behavior branching on ENV=dev vs prod in this pr

⸻

database setup

engine
	•	sync sqlalchemy engine
	•	engine created once at startup
	•	sessions are request-scoped

files:
	•	app/db/engine.py — engine creation
	•	app/db/session.py — get_db() dependency
	•	app/db/base.py — declarative base

migrations
	•	alembic initialized under apps/api/migrations
	•	alembic env wired to DATABASE_URL
	•	placeholder initial migration exists (empty)

no models required yet, but alembic must run successfully.

⸻

fastapi app bootstrap

app creation
	•	entrypoint: app/main.py
	•	app factory pattern is allowed but not required
	•	lifespan events supported (needed later for jwks)

middleware
	•	global exception handler installed
	•	no auth middleware yet (stub allowed)

required endpoint
	•	GET /health
	•	returns { "data": { "status": "ok" } }
	•	no auth
	•	used by tests

⸻

error handling (hard constraint)

envelope

all errors must be rendered as:

{
  "error": {
    "code": "E_...",
    "message": "human readable"
  }
}

mechanism
	•	define a custom ApiError exception:
	•	fields: code, status_code, message
	•	register a global exception handler that converts ApiError → envelope
	•	unhandled exceptions:
	•	return 500 E_INTERNAL
	•	do not leak stack traces in response

no endpoint may manually build error responses.

⸻

logging (minimal)
	•	structured logging via standard logging module
	•	log level configurable via env (default INFO)
	•	no request/response body logging
	•	no secrets logged

⸻

integration test harness

test database
	•	postgres via testcontainers
	•	container started once per test session
	•	migrations applied before tests run
	•	database cleaned between tests:
	•	either truncate all tables
	•	or wrap each test in a transaction + rollback

choice must be documented in conftest.py.

test client
	•	use httpx in-process client against fastapi app
	•	do NOT spawn uvicorn subprocess
	•	lifespan events must run

required test
	•	test_health.py:
	•	boots app
	•	hits /health
	•	asserts 200 + {data:{status:"ok"}}

no auth bypass in this pr.

⸻

commands (must work)

from apps/api:

uv sync
uv run alembic upgrade head
uv run pytest
uv run uvicorn app.main:app

all commands must succeed locally.

⸻

acceptance criteria

this pr is complete when:
	•	repository layout matches spec
	•	app boots and serves /health
	•	alembic migrations run cleanly
	•	pytest passes using testcontainers
	•	error envelope is enforced via exception handler
	•	ruff passes

no later pr may:
	•	change repo layout
	•	introduce a different db engine style
	•	bypass the error envelope
	•	add a second config system

merge this before touching auth, schema, or visibility.
