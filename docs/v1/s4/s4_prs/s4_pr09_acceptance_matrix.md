# s4 pr-09 acceptance matrix

canonical scenario coverage for s4 spec §10 scenarios 1–15.

| # | scenario | contract summary | automated test(s) | status |
|---|----------|-----------------|-------------------|--------|
| 1 | invite + immediate access | invite accept → membership + media readable immediately before backfill | `test_libraries.py::test_accept_invite_happy_path_returns_200`, `test_libraries.py::test_accept_invite_grants_immediate_media_access_before_backfill_worker` | pass |
| 2 | strict revocation | membership/share revoke → reads denied immediately | `test_visibility_helpers.py::test_get_conversation_for_visible_read_or_404_denies_after_share_revoked`, `test_visibility_helpers.py::test_get_conversation_for_visible_read_or_404_denies_after_viewer_membership_revoked`, `test_visibility_helpers.py::test_get_conversation_for_visible_read_or_404_denies_after_owner_membership_revoked`, `test_visibility_helpers.py::test_get_highlight_for_visible_read_or_404_denies_after_intersection_revoked`, `test_permissions.py::test_can_read_media_false_for_default_closure_after_membership_revocation`, `test_highlights.py::test_get_highlight_shared_reader_revoked_membership_masked_404`, `test_search.py::test_search_annotations_hidden_after_membership_revocation` | pass |
| 3 | default library invite forbidden | POST invite to default library → 403 | `test_libraries.py::test_create_invite_default_library_forbidden`, `test_libraries.py::test_accept_invite_default_library_forbidden_defense` | pass |
| 4 | default library conversation share forbidden | PUT shares with default library → 403 | `test_shares.py::test_put_conversation_shares_default_library_forbidden`, `test_shares.py::test_set_sharing_mode_default_library_forbidden`, `test_shares.py::test_add_share_default_library_forbidden`, `test_shares.py::test_set_shares_default_library_forbidden` | pass |
| 5 | admin cannot delete container | non-owner admin DELETE library → 403 E_OWNER_REQUIRED | `test_libraries.py::test_delete_library_non_owner_admin_returns_owner_required` | pass |
| 6 | owner transfer then exit | transfer ownership → previous owner can be demoted/removed | `test_libraries.py::test_transfer_then_previous_owner_exit_path_allowed` | pass |
| 7 | shared conversation read | shared reader sees conversation + messages; write denied | `test_conversations.py::test_get_conversation_shared_reader_succeeds`, `test_conversations.py::test_list_messages_shared_reader_succeeds`, `test_visibility_helpers.py::test_get_conversation_for_visible_read_or_404_allows_library_shared_non_owner` | pass |
| 8 | shared highlights visible | shared reader sees highlight with author_user_id; cannot mutate | `test_web_article_highlight_e2e.py::TestSharedHighlightVisibility::test_shared_reader_can_list_and_get_highlights_but_cannot_mutate`, `test_highlights.py::test_list_highlights_mine_only_false_returns_visible_shared`, `test_highlights.py::test_get_highlight_shared_reader_visible_success` | pass |
| 8b | highlight list default mine-only | GET highlights without mine_only → viewer-only; mine_only=false → shared visible | `test_highlights.py::test_list_highlights_mine_only_false_returns_visible_shared`, `test_highlights.py::test_get_highlight_shared_reader_revoked_membership_masked_404` | pass |
| 9 | invite idempotency | re-accept already accepted → 200 no-op | `test_libraries.py::test_accept_invite_idempotent_when_already_accepted` | pass |
| 10 | revoke idempotency | re-revoke already revoked → 204 | `test_libraries.py::test_revoke_invite_idempotent_when_already_revoked` | pass |
| 11 | conversation list deterministic ordering | scope=all → updated_at DESC, id DESC; tie-break deterministic | `test_conversations.py::test_list_conversations_ordering`, `test_conversations.py::test_list_conversations_scope_all_order_is_updated_at_desc_id_desc` | pass |
| 12 | default-library remove under active closure edge | remove intrinsic → closure keeps row; revoke membership → gc | `test_libraries.py::test_remove_media_from_default_removes_intrinsic_but_keeps_row_when_closure_exists`, `test_libraries.py::test_remove_media_from_default_row_is_gc_after_closure_removed`, `test_libraries.py::test_remove_from_non_default_gcs_default_when_no_intrinsic`, `test_permissions.py::test_can_read_media_false_for_default_closure_after_membership_revocation`, `test_search.py::test_search_does_not_return_stale_default_library_rows_without_intrinsic_or_closure` | pass |
| 13 | shared conversation search scope | shared reader search scope=conversation:C → messages returned | `test_search.py::test_scope_conversation_shared_reader_allowed_by_read_visibility` | pass |
| 14 | shared annotation search visibility | shared annotation visible via highlight visibility predicate | `test_search.py::test_search_annotations_include_shared_visible_results`, `test_search.py::test_search_annotations_hidden_after_membership_revocation` | pass |
| 15 | library-scope message search constrained | scope=library:L1 → only messages from convs shared to L1 | `test_search.py::test_scope_library_message_search_includes_only_target_shared_conversations`, `test_search.py::test_scope_library_message_search_excludes_visible_but_unshared_conversations` | pass |
