# pr-02: canonical visibility auth kernel + helper split (rollout-safe)

## goal
land a single internal visibility/auth kernel for s4 (media + conversation + highlight) with rollout-safe default-library intrinsic write-through, without changing public endpoint contracts in this pr.

## context
- `docs/v1/s4/s4_spec.md` section 5 defines canonical visibility predicates:
  - media visibility is provenance-based (`non-default membership` OR `default intrinsic` OR `active default closure edge`).
  - conversation visibility is owner/public/library-share with active owner+viewer membership in the shared library.
  - highlight/annotation visibility requires media visibility plus library intersection between viewer and author on anchor media.
- `docs/v1/s4/s4_roadmap.md` defines pr-02 as internal auth-kernel work; public conversation/highlight behavior switches happen in pr-06/pr-07.
- pr-01 has already landed:
  - `default_library_intrinsics`
  - `default_library_closure_edges`
  - `default_library_backfill_jobs`
- current codebase gaps:
  - `python/nexus/auth/permissions.py` still authorizes media via plain `library_media + memberships` join, including default-library rows with no intrinsic/closure justification.
  - `python/nexus/services/conversations.py` has ambiguous owner-only helper `get_conversation_for_viewer_or_404`.
  - `python/nexus/services/highlights.py` has ambiguous owner-only helper `get_highlight_for_viewer_or_404`.
  - default-library writer paths (`upload`, `from_url`, dedupe attach, library add/remove) do not maintain `default_library_intrinsics`, which would break reads if `can_read_media` flips without write-through.

## dependencies
- pr-01 must be merged (`0007` migration and s4 tables available).

---

## deliverables

### `python/nexus/auth/permissions.py`
- rewrite `can_read_media(session: Session, viewer_user_id: UUID, media_id: UUID) -> bool` to s4 provenance semantics:
  - true iff any of:
    - non-default path: exists non-default library `l` with membership `(l, viewer)` and `library_media(l, media)`.
    - default intrinsic path: viewer owns default library `d` and row exists in `default_library_intrinsics(d, media)`.
    - default closure path: viewer owns default library `d`, row exists in `default_library_closure_edges(d, media, source_library_id)`, and viewer currently has membership in `source_library_id`.
  - explicit rule: raw `(default_library_id, media_id)` presence in `library_media` is not sufficient.
  - existence masking preserved: return `False` for not found/not visible.
- rewrite `can_read_media_bulk(...) -> dict[UUID, bool]` to match the same s4 provenance semantics while preserving existing contract:
  - one select query for non-empty input.
  - return mapping for all input ids.
  - unreadable/nonexistent ids map to `False`.
- add canonical read predicates (bool-only, no http errors):
  - `can_read_conversation(session: Session, viewer_user_id: UUID, conversation_id: UUID) -> bool`
  - `can_read_highlight(session: Session, viewer_user_id: UUID, highlight_id: UUID) -> bool`
- `can_read_conversation` semantics:
  - true iff viewer is owner, or conversation is public, or conversation is library-shared and there exists share library where both viewer and owner are current members.
- `can_read_highlight` semantics:
  - true iff viewer can read anchor media (via `can_read_media`) and there exists a library containing that media where both viewer and highlight author are members.
- keep `is_library_admin`, `is_library_member`, `is_admin_of_any_containing_library` behavior unchanged.
- do not import routes/services into this module.

### `python/nexus/services/conversations.py`
- replace ambiguous helper with explicit split:
  - `get_conversation_for_visible_read_or_404(db: Session, viewer_id: UUID, conversation_id: UUID) -> Conversation`
  - `get_conversation_for_owner_write_or_404(db: Session, viewer_id: UUID, conversation_id: UUID) -> Conversation`
- `get_conversation_for_visible_read_or_404` uses `can_read_conversation(...)`.
- `get_conversation_for_owner_write_or_404` enforces owner-only mutation gate.
- both helpers preserve masked `404 E_CONVERSATION_NOT_FOUND`.
- update in-file call sites used by existing write/list/get/message service functions to explicit helper names.
- no external contract changes in this pr:
  - no `scope` behavior changes.
  - no pagination/order changes.
  - no response shape/fields changes.

### `python/nexus/services/highlights.py`
- replace ambiguous helper with explicit split:
  - `get_highlight_for_visible_read_or_404(db: Session, viewer_id: UUID, highlight_id: UUID) -> Highlight`
  - `get_highlight_for_author_write_or_404(db: Session, viewer_id: UUID, highlight_id: UUID) -> Highlight`
- `get_highlight_for_visible_read_or_404` uses `can_read_highlight(...)`.
- `get_highlight_for_author_write_or_404` enforces author-only mutation gate.
- both helpers preserve masked `404 E_MEDIA_NOT_FOUND`.
- update in-file call sites to explicit helper names.
- no external contract changes in this pr:
  - no `mine_only` query behavior changes.
  - no response shape/fields changes.

### `python/nexus/services/search.py`
- minimal helper-coupling cleanup only:
  - replace imports/call-sites that reference deprecated ambiguous conversation helper names with explicit helper names introduced in this pr.
  - keep current owner-only scope-auth behavior in pr-02 (behavior change deferred to pr-08).
- no query, ranking, scope, or response-shape changes.

### `python/nexus/services/upload.py`
- rollout-safety: make default-library writes intrinsic-aware in same transaction.
- in `init_upload(...)`:
  - after determining viewer default library and inserting `library_media`, idempotently upsert `(default_library_id, media_id)` into `default_library_intrinsics`.
- in `_ensure_in_default_library(...)`:
  - ensure both `library_media` and `default_library_intrinsics` rows exist (idempotent).
  - keep function no-op semantics for already-present rows.
- no api contract changes.

### `python/nexus/services/libraries.py`
- rollout-safety for explicit default-library add/remove:
  - in `add_media_to_library(...)`:
    - when target `library_id` is default (`is_default=true`), idempotently upsert intrinsic row `(library_id, media_id)` in same transaction.
    - keep existing non-default closure/materialization behavior unchanged in this pr.
  - in `remove_media_from_library(...)`:
    - when removing from default library, delete matching intrinsic row `(library_id, media_id)` in same transaction as default `library_media` removal.
- do not implement s4 closure-edge/backfill worker logic here (pr-05).

### `python/nexus/tasks/ingest_web_article.py`
- in `_handle_duplicate(...)`, when attaching winner media to actor default library:
  - idempotently upsert corresponding intrinsic row `(default_library_id, winner_media_id)` in the same transaction before loser delete commit.
- preserve current dedupe outcome contract (winner attached, loser deleted).

### `python/tests/test_permissions.py`
- update/add tests for s4 media provenance semantics.
- explicitly rewrite legacy assumptions in existing tests:
  - `TestCanReadMedia.test_can_read_media_true_for_member`
  - `TestCanReadMedia.test_can_read_media_true_for_admin`
  - `TestCanReadMediaBulk.test_can_read_media_bulk_mixed`
  - these tests must no longer rely on default-library `library_media` rows alone; they must use non-default membership path or explicitly seed intrinsic/closure provenance.
- add/update tests (exact names):
  - `TestCanReadMedia.test_can_read_media_false_for_default_library_media_without_intrinsic_or_closure`
  - `TestCanReadMedia.test_can_read_media_true_for_default_intrinsic`
  - `TestCanReadMedia.test_can_read_media_true_for_default_closure_with_active_source_membership`
  - `TestCanReadMedia.test_can_read_media_false_for_default_closure_after_membership_revocation`
  - `TestCanReadMediaBulk.test_can_read_media_bulk_mixed_s4_paths`
- preserve existing non-leak behavior assertions.

### `python/tests/test_visibility_helpers.py` (new)
- add service/predicate-level tests for helper split and strict revocation.
- required tests:
  - `test_get_conversation_for_visible_read_or_404_allows_owner`
  - `test_get_conversation_for_visible_read_or_404_allows_public_non_owner`
  - `test_get_conversation_for_visible_read_or_404_allows_library_shared_non_owner`
  - `test_get_conversation_for_visible_read_or_404_denies_after_share_revoked`
  - `test_get_conversation_for_visible_read_or_404_denies_after_viewer_membership_revoked`
  - `test_get_conversation_for_visible_read_or_404_denies_after_owner_membership_revoked`
  - `test_get_highlight_for_visible_read_or_404_requires_media_visibility_and_library_intersection`
  - `test_get_highlight_for_visible_read_or_404_denies_after_intersection_revoked`
  - `test_owner_and_author_write_helpers_remain_masked_404`

### `python/tests/test_libraries.py`
- add tests for default-library intrinsic write-through:
  - `TestDefaultLibraryClosure.test_add_media_to_default_library_creates_intrinsic`
  - `TestDefaultLibraryClosure.test_remove_media_from_default_library_removes_intrinsic`

### `python/tests/test_upload.py`
- add rollout-safety tests:
  - `TestUploadInit.test_upload_init_creates_default_intrinsic`
  - `TestConfirmIngest.test_ingest_duplicate_detection_preserves_winner_default_intrinsic`

### `python/tests/test_from_url.py`
- add rollout-safety test:
  - `TestFromUrlSuccess.test_media_attached_to_default_library_creates_intrinsic`

### `python/tests/test_search.py`
- update local test helper `create_test_media(...)` fixture seeding so default-library seeded media includes matching intrinsic row.
- no behavior assertion changes.

### `python/tests/test_send_message.py`
- update local test helper `create_test_media(...)` fixture seeding:
  - when seeding into a default library, also seed matching intrinsic row.
- no endpoint contract assertion changes.

---

## acceptance tests

### file: `python/tests/test_permissions.py`

**test: `TestCanReadMedia.test_can_read_media_false_for_default_library_media_without_intrinsic_or_closure`**
- input: viewer default library contains `(d, m)` in `library_media` only; no intrinsic row; no closure edge.
- output: `can_read_media(...) is False`.

**test: `TestCanReadMedia.test_can_read_media_true_for_default_intrinsic`**
- input: viewer owns default `d`; rows exist in `library_media(d,m)` and `default_library_intrinsics(d,m)`.
- output: `can_read_media(...) is True`.

**test: `TestCanReadMedia.test_can_read_media_true_for_default_closure_with_active_source_membership`**
- input: viewer default `d`; closure edge `(d,m,source_l)` exists; viewer is currently member of `source_l`.
- output: `can_read_media(...) is True`.

**test: `TestCanReadMedia.test_can_read_media_false_for_default_closure_after_membership_revocation`**
- input: same as prior test, then delete viewer membership in `source_l` and re-check in fresh read.
- output: `can_read_media(...) is False` immediately after commit.

**test: `TestCanReadMediaBulk.test_can_read_media_bulk_mixed_s4_paths`**
- input: mixed ids across non-default path, intrinsic path, closure path, and unreadable id.
- output: mapping contains all ids with correct booleans.

### file: `python/tests/test_visibility_helpers.py`

**test: `test_get_conversation_for_visible_read_or_404_allows_owner`**
- input: viewer is conversation owner.
- output: helper returns conversation.

**test: `test_get_conversation_for_visible_read_or_404_allows_public_non_owner`**
- input: non-owner viewer requests `sharing='public'` conversation.
- output: helper returns conversation.

**test: `test_get_conversation_for_visible_read_or_404_allows_library_shared_non_owner`**
- input: conversation shared to non-default library `l`; owner and viewer are members of `l`; viewer is not owner.
- output: helper returns conversation (no error).

**test: `test_get_conversation_for_visible_read_or_404_denies_after_share_revoked`**
- input: start from visible shared conversation; delete matching `conversation_shares` row.
- output: helper raises `NotFoundError(E_CONVERSATION_NOT_FOUND)` on subsequent read.

**test: `test_get_conversation_for_visible_read_or_404_denies_after_viewer_membership_revoked`**
- input: start from visible shared conversation; revoke viewer membership from shared library.
- output: helper raises `NotFoundError(E_CONVERSATION_NOT_FOUND)` on subsequent read.

**test: `test_get_conversation_for_visible_read_or_404_denies_after_owner_membership_revoked`**
- input: start from visible shared conversation; remove owner membership from shared library while share row remains.
- output: helper raises `NotFoundError(E_CONVERSATION_NOT_FOUND)`.

**test: `test_get_highlight_for_visible_read_or_404_requires_media_visibility_and_library_intersection`**
- input: highlight authored by user `a`; viewer `b` has media visibility and shared library intersection on anchor media.
- output: helper returns highlight (no error).

**test: `test_get_highlight_for_visible_read_or_404_denies_after_intersection_revoked`**
- input: start from visible highlight; revoke intersection membership.
- output: helper raises `NotFoundError(E_MEDIA_NOT_FOUND)` on subsequent read.

**test: `test_owner_and_author_write_helpers_remain_masked_404`**
- input: non-owner/non-author invokes owner/author write helpers.
- output: masked `NotFoundError` with unchanged codes.

### file: `python/tests/test_libraries.py`

**test: `TestDefaultLibraryClosure.test_add_media_to_default_library_creates_intrinsic`**
- input: add media to viewer default library via library service endpoint.
- output: row exists in `default_library_intrinsics(default_library_id, media_id)`.

**test: `TestDefaultLibraryClosure.test_remove_media_from_default_library_removes_intrinsic`**
- input: media exists in default library + intrinsic; remove from default library.
- output: intrinsic row removed for that pair.

### file: `python/tests/test_upload.py`

**test: `TestUploadInit.test_upload_init_creates_default_intrinsic`**
- input: `POST /media/upload/init` by authenticated user.
- output: created media is present in both `library_media(default, media)` and `default_library_intrinsics(default, media)`.

**test: `TestConfirmIngest.test_ingest_duplicate_detection_preserves_winner_default_intrinsic`**
- input: duplicate ingest where loser maps to existing winner.
- output: winner remains/gets present in actor default intrinsic table after dedupe.

### file: `python/tests/test_from_url.py`

**test: `TestFromUrlSuccess.test_media_attached_to_default_library_creates_intrinsic`**
- input: `POST /media/from_url` success path.
- output: created media has both default `library_media` and `default_library_intrinsics` rows.

### compatibility regression checks (existing tests must stay green)
- `python/tests/test_conversations.py` owner-only route behavior remains unchanged in pr-02.
- `python/tests/test_highlights.py` owner/author-only route behavior remains unchanged in pr-02.
- `python/tests/test_search.py` existing scope and response-shape assertions unchanged.
- `python/tests/test_send_message.py` owner-only conversation write checks unchanged.

---

## non-goals
- does not expose new public conversation or highlight read behavior (that is pr-06/pr-07).
- does not add invite/member/ownership-transfer endpoints (pr-03/pr-04).
- does not implement closure-edge materialization/backfill worker/requeue behavior (pr-05).
- does not change search behavior or scope-auth semantics in this pr (handled in pr-08).
- does not change search query semantics/ranking/scope behavior or response envelope (pr-08 owns behavior alignment).
- does not add schema/migration changes.

---

## constraints
- only modify files listed in deliverables.
- no fallback auth path that treats default `library_media` rows as readable without intrinsic/active closure justification.
- all intrinsic write-through updates must occur in the same db transaction as corresponding default-library `library_media` writes.
- all new writes must be idempotent (`ON CONFLICT DO NOTHING` or equivalent safe upsert behavior).
- preserve existing api envelopes and endpoint signatures in this pr.
- any `python/nexus/services/search.py` changes are limited to helper-name/call-site decoupling; behavior must stay byte-for-byte equivalent.
- do not add new third-party dependencies.

---

## boundaries (for ai implementers)

**do**:
- implement exact canonical predicates in `auth/permissions.py`.
- split ambiguous conversation/highlight helpers into explicit visible-read vs write-authority helpers.
- add rollout-safe intrinsic write-through on default-library writer paths in this pr.
- add strict-revocation tests at predicate/helper level.
- keep existing public route behavior unchanged.

**do not**:
- add or modify fastapi routes or next.js bff routes.
- add temporary legacy-read fallback branches in `can_read_media`.
- change conversation/highlight/search response schemas.
- implement closure/backfill worker/state-machine logic.
- perform opportunistic refactors outside listed files.

---

## checklist
- [ ] `can_read_media` and `can_read_media_bulk` enforce s4 provenance semantics.
- [ ] canonical `can_read_conversation` and `can_read_highlight` predicates are added.
- [ ] conversation service has explicit `visible-read` and `owner-write` helpers; ambiguous helper removed.
- [ ] highlight service has explicit `visible-read` and `author-write` helpers; ambiguous helper removed.
- [ ] no public endpoint behavior/schema change is introduced in pr-02.
- [ ] `python/nexus/services/search.py` is decoupled from deprecated helper naming with no behavior change.
- [ ] default-library intrinsic write-through is applied in `upload`, `libraries`, and ingest dedupe attach paths.
- [ ] strict revocation is covered by helper/predicate-level tests, including share-row revocation and membership revocation.
- [ ] conversation visible-read helper tests cover owner, public, and library-shared branches.
- [ ] fixture helpers in `test_search.py` and `test_send_message.py` are updated for intrinsic-aware default-library seeding.
- [ ] new/updated tests in `test_permissions.py`, `test_visibility_helpers.py`, `test_libraries.py`, `test_upload.py`, and `test_from_url.py` pass.
- [ ] compatibility regression checks for conversations/highlights/search/send-message remain green.
