# pr-01: s4 schema + error/type contract

## goal
land the full s4 storage and error/type contract in one mergeable pr, with explicit migration transform tests from `0006 -> 0007`, without changing endpoint behavior.

## context
- current alembic head is `0006` in `migrations/alembic/versions/0006_pr09_provider_request_id.py`.
- `python/nexus/db/models.py` does not yet define:
  - `library_invitations`
  - `default_library_intrinsics`
  - `default_library_closure_edges`
  - `default_library_backfill_jobs`
- `python/nexus/errors.py` is the single source of truth for api error enums and status mapping.
- `python/tests/test_migrations.py` already has migration lifecycle coverage, but not explicit `upgrade 0006 -> 0007` data-transform assertions.
- current default-library closure behavior is legacy service logic in `python/nexus/services/libraries.py`; this pr only introduces schema/contracts used by later prs.

## dependencies
- none (build directly on current `main`/head at migration revision `0006`).

---

## deliverables

### `migrations/alembic/versions/0007_slice4_library_sharing.py`
- create migration with exact identifiers:
  - `revision: str = "0007"`
  - `down_revision: str | None = "0006"`
- in `upgrade()` create tables exactly per s4 spec:
  - `library_invitations`
  - `default_library_intrinsics`
  - `default_library_closure_edges`
  - `default_library_backfill_jobs`
- apply constraints/indexes from s4 spec, including:
  - invitation checks:
    - `ck_library_invitations_role`
    - `ck_library_invitations_status`
    - `ck_library_invitations_not_self`
    - `ck_library_invitations_responded_at`
  - invitation indexes:
    - `uix_library_invitations_pending_once` (partial unique)
    - `idx_library_invitations_library_status_created`
    - `idx_library_invitations_invitee_status_created`
  - closure/intrinsic/backfill supporting indexes:
    - `idx_default_library_intrinsics_media`
    - `idx_default_library_closure_edges_source`
    - `idx_default_library_closure_edges_default_media`
    - `idx_default_library_backfill_jobs_status_updated`
  - existing-table supporting indexes:
    - `idx_memberships_user_library_role`
    - `idx_library_media_media_library`
    - `idx_conversation_shares_library_conversation`
- add `default_library_backfill_jobs.finished_at` state integrity check:
  - constraint name: `ck_default_library_backfill_jobs_finished_at_state`
  - `pending|running` requires `finished_at IS NULL`
  - `completed|failed` requires `finished_at IS NOT NULL`
- implement deterministic seed transform in `upgrade()`:
  1. hard-fail precheck for any membership in non-default library where member has no default library.
  2. seed closure edges from non-default membership + non-default `library_media`.
  3. seed intrinsics for existing default-library `library_media` rows that have no seeded closure edge.
  4. do not seed `default_library_backfill_jobs`.
- precheck failure contract:
  - raise runtime error with message containing `S4_0007_MISSING_DEFAULT_LIBRARY`.
  - include offending `user_id` and `library_id` in message text.
- seed idempotency contract:
  - use deterministic set-based inserts with `ON CONFLICT DO NOTHING`.
- in `downgrade()` drop objects in strict reverse dependency order and drop all indexes created in `upgrade()`.

### `python/nexus/db/models.py`
- add typed python enums (no postgres enum migration in this pr):
  - `LibraryInvitationRole(str, PyEnum)` with `admin|member`
  - `LibraryInvitationStatus(str, PyEnum)` with `pending|accepted|declined|revoked`
  - `DefaultLibraryBackfillJobStatus(str, PyEnum)` with `pending|running|completed|failed`
- add orm classes (minimal relationship surface only; no speculative helpers):
  - `LibraryInvitation`
  - `DefaultLibraryIntrinsic`
  - `DefaultLibraryClosureEdge`
  - `DefaultLibraryBackfillJob`
- map role/status columns as `Text` with `CheckConstraint` names matching migration.
- ensure table names and pk/fk columns exactly match migration contract.
- do not add service logic in model file.

### `python/nexus/db/__init__.py`
- export new enums/classes added in `python/nexus/db/models.py` via both import list and `__all__`.

### `python/nexus/errors.py`
- add s4 error codes to `ApiErrorCode`:
  - `E_USER_NOT_FOUND`
  - `E_INVITE_NOT_FOUND`
  - `E_INVITE_ALREADY_EXISTS`
  - `E_INVITE_MEMBER_EXISTS`
  - `E_INVITE_NOT_PENDING`
  - `E_OWNER_REQUIRED`
  - `E_OWNER_EXIT_FORBIDDEN`
  - `E_OWNERSHIP_TRANSFER_INVALID`
  - `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`
- add corresponding `ERROR_CODE_TO_STATUS` mappings:
  - 404: `E_USER_NOT_FOUND`, `E_INVITE_NOT_FOUND`
  - 409: `E_INVITE_ALREADY_EXISTS`, `E_INVITE_MEMBER_EXISTS`, `E_INVITE_NOT_PENDING`, `E_OWNERSHIP_TRANSFER_INVALID`
  - 403: `E_OWNER_REQUIRED`, `E_OWNER_EXIT_FORBIDDEN`, `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`

### `python/nexus/schemas/library.py`
- add typed aliases for library invite/member state, using `Literal`:
  - `LibraryRole = Literal["admin", "member"]`
  - `LibraryInvitationStatusValue = Literal["pending", "accepted", "declined", "revoked"]`
- add response schemas:
  - `LibraryMemberOut`
    - `user_id: UUID`
    - `role: LibraryRole`
    - `is_owner: bool`
    - `created_at: datetime`
  - `LibraryInvitationOut`
    - `id: UUID`
    - `library_id: UUID`
    - `inviter_user_id: UUID`
    - `invitee_user_id: UUID`
    - `role: LibraryRole`
    - `status: LibraryInvitationStatusValue`
    - `created_at: datetime`
    - `responded_at: datetime | None`
- update module `__all__` to include these new schema names.

### `python/nexus/schemas/__init__.py`
- re-export `LibraryMemberOut` and `LibraryInvitationOut`.

### `python/tests/test_errors.py`
- extend `TestErrorCodeToStatus.test_error_code_maps_to_correct_status` parametrization with all new s4 error codes and expected statuses.
- keep existing tests untouched; only additive assertions.

### `python/tests/test_migrations.py`
- add explicit s4 migration tests (new class `TestS4Migration0007`).
- required helper (module-local): `run_alembic_command("upgrade 0006")` path usage for targeted upgrade.
- migration test isolation rule (mandatory):
  - each s4 test must self-manage migration state (`downgrade base -> upgrade 0006 -> fixture -> upgrade target`) and cleanup.
  - do not rely on `migrated_engine` fixture for s4 tests.
- add required tests:

**test: `test_upgrade_0006_to_0007_seeds_edges_and_intrinsics`**
- input:
  - start at `0006`.
  - fixture rows:
    - user `u1` with default library `d1`.
    - non-default library `l1` where `u1` is member.
    - media `m_edge` linked to `l1`.
    - `library_media(d1, m_edge)` also present (overlap case).
    - media `m_intrinsic_only` linked only to `d1`.
  - upgrade to `0007`.
- output:
  - closure edge row exists for `(d1, m_edge, l1)`.
  - intrinsic row exists for `(d1, m_intrinsic_only)`.
  - intrinsic row does not exist for `(d1, m_edge)`.
  - `default_library_backfill_jobs` row count remains `0`.

**test: `test_upgrade_0006_to_0007_fails_when_member_has_no_default_library`**
- input:
  - start at `0006`.
  - fixture rows:
    - user `u_owner` owns non-default library `l1`.
    - user `u_member` is member of `l1`.
    - user `u_member` has no default library row.
    - media `m1` in `l1`.
  - run `upgrade 0007`.
- output:
  - alembic command fails (`returncode != 0`).
  - stderr or stdout contains `S4_0007_MISSING_DEFAULT_LIBRARY`.

**test: `test_upgrade_0006_to_0007_seed_is_idempotent_after_downgrade_round_trip`**
- input:
  - build same fixture as first seed test at `0006`.
  - upgrade to `0007`, snapshot seeded rows in closure/intrinsic tables.
  - downgrade back to `0006`.
  - upgrade again to `0007`.
- output:
  - primary-key tuple sets are identical to first upgrade:
    - closure edges compared as `(default_library_id, media_id, source_library_id)`
    - intrinsics compared as `(default_library_id, media_id)`
  - do not assert timestamp equality.

**test: `test_0007_supporting_indexes_exist`**
- input:
  - upgrade to `head`.
  - query `pg_indexes` by expected index names.
- output:
  - all expected `0007` index names exist, including the three existing-table supporting indexes.

**test: `test_library_invitations_pending_unique_partial_index`**
- input:
  - upgrade to `head`.
  - insert fixture users/library.
  - insert one `pending` invite for `(library_id, invitee_user_id)`.
  - attempt second `pending` invite for same pair.
- output:
  - second insert fails due to `uix_library_invitations_pending_once`.

**test: `test_library_invitations_responded_at_check_constraint`**
- input:
  - upgrade to `head`.
  - insert fixture users/library.
  - attempt inserts:
    - `status='pending'` with non-null `responded_at`
    - `status='accepted'` with null `responded_at`
    - valid terminal state with non-null `responded_at`
- output:
  - first two inserts fail with integrity error on `ck_library_invitations_responded_at`.
  - valid terminal insert succeeds.

**test: `test_library_invitations_not_self_check_constraint`**
- input:
  - upgrade to `head`.
  - insert fixture user/library.
  - attempt invite row where `inviter_user_id == invitee_user_id`.
- output:
  - insert fails with integrity error on `ck_library_invitations_not_self`.

**test: `test_default_library_backfill_jobs_finished_at_state_constraint`**
- input:
  - upgrade to `head`.
  - insert valid fk fixture rows for `default_library_backfill_jobs`.
  - attempt inserts:
    - `status='pending'` with non-null `finished_at`
    - `status='completed'` with null `finished_at`
    - `status='completed'` with non-null `finished_at`
- output:
  - first two inserts fail with integrity error on the new finished-at check constraint.
  - third insert succeeds.

---

## acceptance tests

### file: `python/tests/test_errors.py`

**test: `TestErrorCodeToStatus.test_error_code_maps_to_correct_status`**
- input: each new s4 error code enum.
- output: status equals contract in deliverables.

### file: `python/tests/test_migrations.py`

**test: `TestS4Migration0007.test_upgrade_0006_to_0007_seeds_edges_and_intrinsics`**
- input: legacy `0006` fixture with overlapping default/non-default media memberships.
- output: exact seeded closure/intrinsic rows as specified.

**test: `TestS4Migration0007.test_upgrade_0006_to_0007_fails_when_member_has_no_default_library`**
- input: `0006` fixture with non-default membership and missing member default library.
- output: upgrade fails with sentinel string `S4_0007_MISSING_DEFAULT_LIBRARY`.

**test: `TestS4Migration0007.test_upgrade_0006_to_0007_seed_is_idempotent_after_downgrade_round_trip`**
- input: same deterministic fixture upgraded twice with an intermediate downgrade.
- output: identical primary-key tuple sets (timestamps ignored).

**test: `TestS4Migration0007.test_0007_supporting_indexes_exist`**
- input: migrated head database.
- output: expected index names present in `pg_indexes`.

**test: `TestS4Migration0007.test_library_invitations_pending_unique_partial_index`**
- input: duplicate pending invite inserts for same `(library_id, invitee_user_id)`.
- output: second insert rejected by `uix_library_invitations_pending_once`.

**test: `TestS4Migration0007.test_library_invitations_responded_at_check_constraint`**
- input: invalid and valid `(status, responded_at)` combinations.
- output: invalid pairs rejected, valid pair accepted.

**test: `TestS4Migration0007.test_library_invitations_not_self_check_constraint`**
- input: self-invite row (`inviter_user_id == invitee_user_id`).
- output: insert rejected by `ck_library_invitations_not_self`.

**test: `TestS4Migration0007.test_default_library_backfill_jobs_finished_at_state_constraint`**
- input: three insert attempts across valid/invalid status+finished_at pairs.
- output: invalid pairs rejected, valid pair accepted.

---

## non-goals
- does not add or change any fastapi route handlers.
- does not add invitation/member/transfer endpoint behavior.
- does not modify authorization predicates (`can_read_media`, conversation/highlight visibility).
- does not implement closure maintenance worker/requeue execution behavior.
- does not change `GET /search` response shape or query behavior.

---

## constraints
- only modify files listed in deliverables.
- migration must be explicit/manual; no alembic autogenerate usage.
- do not add new third-party dependencies.
- preserve backward compatibility for existing endpoint payloads; additive schema/types only.
- db representation for new role/status fields remains text + check constraints (no postgres enum type creation in this pr).
- keep model/table/constraint/index names identical between migration and orm declarations.

---

## boundaries (for ai implementers)

**do**:
- implement exactly the new schema/error/type contracts listed.
- add explicit targeted migration tests for `0006 -> 0007`.
- include `python/nexus/db/__init__.py` and `python/nexus/schemas/__init__.py` export updates.
- keep seed logic deterministic and fail-fast on inconsistent legacy membership/default-library state.

**do not**:
- touch service authorization logic.
- add endpoint handlers, request models, or transport behavior.
- introduce background tasks, celery wiring, or internal routes.
- refactor unrelated model/service files.
- weaken migration error handling by silently skipping broken legacy rows.

---

## checklist
- [ ] migration file `0007_slice4_library_sharing.py` added with correct revision chain.
- [ ] all four s4 tables/constraints/indexes are created and downgraded cleanly.
- [ ] deterministic seed transform implemented with hard-fail sentinel `S4_0007_MISSING_DEFAULT_LIBRARY`.
- [ ] `python/nexus/db/models.py` includes new enums + orm classes.
- [ ] `python/nexus/db/__init__.py` exports new enums/classes.
- [ ] `python/nexus/errors.py` includes all new s4 codes and status mappings.
- [ ] `python/nexus/schemas/library.py` includes `LibraryMemberOut` and `LibraryInvitationOut`.
- [ ] `python/nexus/schemas/__init__.py` re-exports new schema types.
- [ ] `python/tests/test_errors.py` updated for all new mappings.
- [ ] `python/tests/test_migrations.py` includes explicit `0006 -> 0007` transform/idempotency/failure/index/constraint tests.
- [ ] `python/tests/test_migrations.py` s4 tests are self-isolated and do not depend on `migrated_engine`.
- [ ] `make test-migrations-no-services` passes.
- [ ] `cd python && NEXUS_ENV=test uv run pytest -v tests/test_errors.py` passes.
