# pr-03: library governance (owner boundary + members + transfer)

## goal
land s4 library governance for library containers: owner-only container delete for non-default libraries, admin member-management endpoints, and owner-initiated ownership transfer, with strict owner-exit constraints and masked visibility semantics.

## context
- `docs/v1/s4/s4_roadmap.md` defines pr-03 scope:
  - owner-only delete (remove old multi-member delete rule)
  - member management endpoints
  - ownership transfer endpoint
- current backend still enforces legacy delete behavior (`admin` + single-member-only) in `python/nexus/services/libraries.py`.
- current backend does not expose member-management or ownership-transfer routes in `python/nexus/api/routes/libraries.py`.
- s4 error codes needed for governance are already present in `python/nexus/errors.py`:
  - `E_OWNER_REQUIRED`
  - `E_OWNER_EXIT_FORBIDDEN`
  - `E_LAST_ADMIN_FORBIDDEN`
  - `E_OWNERSHIP_TRANSFER_INVALID`
  - `E_DEFAULT_LIBRARY_FORBIDDEN`
- current bff has `GET /api/libraries/[id]` proxy but backend route parity is missing; pr-03 must close this mismatch.
- `LibraryMemberOut` already exists in `python/nexus/schemas/library.py`; member/transfer request schemas do not.

## dependencies
- pr-01 must be merged (s4 schema/types/errors baseline).
- pr-02 must be merged (canonical visibility helpers and revocation behavior baseline).

---

## deliverables

### `python/nexus/schemas/library.py`
- add request models for new governance endpoints:
  - `UpdateLibraryMemberRequest`
    - `role: LibraryRole`
  - `TransferLibraryOwnershipRequest`
    - `new_owner_user_id: UUID`
- keep existing `LibraryRole` contract (`admin | member`).
- update module `__all__` with both new request schema names.

### `python/nexus/schemas/__init__.py`
- re-export:
  - `UpdateLibraryMemberRequest`
  - `TransferLibraryOwnershipRequest`

### `python/nexus/services/libraries.py`
- replace legacy container-delete policy:
  - remove single-member restriction.
  - require current owner for non-default library delete.
  - non-owner admin delete returns `403 E_OWNER_REQUIRED`.
  - keep masked `404 E_LIBRARY_NOT_FOUND` for non-members.
  - keep `403 E_DEFAULT_LIBRARY_FORBIDDEN` for default library delete.
- add service functions:
  - `list_library_members(db: Session, viewer_id: UUID, library_id: UUID, limit: int = 100) -> list[LibraryMemberOut]`
  - `update_library_member_role(db: Session, viewer_id: UUID, library_id: UUID, target_user_id: UUID, role: LibraryRole) -> LibraryMemberOut`
  - `remove_library_member(db: Session, viewer_id: UUID, library_id: UUID, target_user_id: UUID) -> None`
  - `transfer_library_ownership(db: Session, viewer_id: UUID, library_id: UUID, new_owner_user_id: UUID) -> LibraryOut`
- member endpoint semantics:
  - auth:
    - caller must be library member with `admin` role for all member routes.
    - non-member is masked `404 E_LIBRARY_NOT_FOUND`.
    - non-admin member gets `403 E_FORBIDDEN`.
  - `GET members`:
    - allowed for default and non-default libraries.
    - ordering: owner first, then `admin`, then `member`, then `created_at ASC, user_id ASC`.
    - limit contract: default `100`, clamp max `200`, reject non-positive with existing invalid-request path.
  - `PATCH member role`:
    - default library forbidden (`403 E_DEFAULT_LIBRARY_FORBIDDEN`).
    - target member missing -> `404 E_NOT_FOUND`.
    - idempotent when requested role equals current role.
    - any attempt to change owner membership role (self or by another admin) -> `403 E_OWNER_EXIT_FORBIDDEN`.
    - demoting the last admin -> `403 E_LAST_ADMIN_FORBIDDEN`.
  - `DELETE member`:
    - default library forbidden (`403 E_DEFAULT_LIBRARY_FORBIDDEN`).
    - idempotent: missing target member returns `204`.
    - any attempt to remove owner membership (self or by another admin) -> `403 E_OWNER_EXIT_FORBIDDEN`.
    - removing the last admin -> `403 E_LAST_ADMIN_FORBIDDEN`.
- ownership transfer semantics:
  - non-member caller is masked `404 E_LIBRARY_NOT_FOUND`.
  - route is owner-only (`403 E_OWNER_REQUIRED` for non-owner members/admins).
  - default library forbidden (`403 E_DEFAULT_LIBRARY_FORBIDDEN`).
  - idempotent when `new_owner_user_id == current owner` (`200` unchanged).
  - transfer target must already be member; otherwise `409 E_OWNERSHIP_TRANSFER_INVALID`.
  - unknown/non-member targets are both treated as `409 E_OWNERSHIP_TRANSFER_INVALID` (no user-existence oracle).
  - transaction and locking contract:
    1. lock library row (`FOR UPDATE`).
    2. lock membership rows for the library before evaluating owner/last-admin checks.
    3. validate/repair owner-admin invariant for current owner if dirty.
    4. validate caller ownership from `libraries.owner_user_id`.
    5. validate target membership.
    6. ensure target membership role is `admin`.
    7. update `libraries.owner_user_id`.
    8. ensure previous owner membership remains `admin`.
    9. update `libraries.updated_at` when owner actually changes.
  - no acceptance handshake; ownership pointer changes in one transaction.
- invariant repair requirement (mvp hardening):
  - mutation paths touching ownership/member governance must repair owner-admin invariant when encountered:
    - owner must have membership row.
    - owner membership role must be `admin`.
  - repair occurs in the same transaction as the triggering mutation.
- explicit deferral:
  - do not add closure-edge cleanup/materialization/backfill side effects in this pr (pr-05 owns full closure maintenance).
  - do not change rename/media admin authorization semantics in this pr.

### `python/nexus/api/routes/libraries.py`
- add missing read parity route:
  - `GET /libraries/{library_id}` -> existing `libraries_service.get_library(...)`.
- add new governance routes:
  - `GET /libraries/{library_id}/members`
  - `PATCH /libraries/{library_id}/members/{user_id}`
  - `DELETE /libraries/{library_id}/members/{user_id}`
  - `POST /libraries/{library_id}/transfer-ownership`
- route discipline:
  - transport-only, single service call per route, return envelope via `success_response(...)`.
  - `GET /libraries/{library_id}/members` uses query `limit` (`default=100`, `ge=1`), with service-level clamp to `200`.
  - `PATCH /libraries/{library_id}/members/{user_id}` request body is `UpdateLibraryMemberRequest`.
  - `POST /libraries/{library_id}/transfer-ownership` request body is `TransferLibraryOwnershipRequest`.
  - `DELETE` routes return empty `204`.

### `apps/web/src/app/api/libraries/**` (bff proxy routes)
- add proxy routes for new public governance endpoints:
  - `apps/web/src/app/api/libraries/[id]/members/route.ts`
    - `GET`
  - `apps/web/src/app/api/libraries/[id]/members/[userId]/route.ts`
    - `PATCH`
    - `DELETE`
  - `apps/web/src/app/api/libraries/[id]/transfer-ownership/route.ts`
    - `POST`
- each route:
  - `runtime = "nodejs"`
  - direct `proxyToFastAPI(...)` passthrough
  - no domain logic/auth logic

### `apps/web/src/app/(authenticated)/libraries/page.tsx`
- mvp ux correctness patch:
  - hide delete button for non-owner admins.
  - keep backend as final authority (`403 E_OWNER_REQUIRED` still enforced).
- implementation constraint:
  - derive current viewer id from existing `/api/me` contract; do not introduce new backend fields for this pr.
- no broader ui redesign/refactor in this pr.

### `python/tests/test_libraries.py`
- extend integration coverage for all pr-03 contracts.
- add test group for `GET /libraries/{library_id}` parity route:
  - `test_get_library_success_for_member`
  - `test_get_library_masked_not_found_for_non_member`
- update delete tests:
  - remove/replace legacy assumptions tied to single-member delete restriction.
  - required:
    - `test_delete_library_owner_can_delete_multi_member_non_default`
    - `test_delete_library_non_owner_admin_returns_owner_required`
    - `test_delete_library_default_forbidden` (retain)
    - `test_delete_library_non_member_masked_not_found` (explicit)
- add member-route tests:
  - `GET members`:
    - `test_list_members_admin_success_order_owner_admin_member`
    - `test_list_members_limit_and_clamp`
    - `test_list_members_non_admin_member_forbidden`
    - `test_list_members_non_member_masked_not_found`
    - `test_list_members_default_library_allowed`
  - `PATCH member role`:
    - `test_patch_member_role_promote_success`
    - `test_patch_member_role_idempotent_no_change`
    - `test_patch_member_role_non_admin_member_forbidden`
    - `test_patch_member_role_non_member_masked_not_found`
    - `test_patch_member_role_target_missing_not_found`
    - `test_patch_member_role_owner_self_demotion_forbidden_owner_exit`
    - `test_patch_member_role_owner_target_forbidden_owner_exit`
    - `test_patch_member_role_last_admin_forbidden`
    - `test_patch_member_role_default_library_forbidden`
  - `DELETE member`:
    - `test_delete_member_success`
    - `test_delete_member_absent_is_idempotent_204`
    - `test_delete_member_non_admin_member_forbidden`
    - `test_delete_member_non_member_masked_not_found`
    - `test_delete_member_owner_self_removal_forbidden_owner_exit`
    - `test_delete_member_owner_target_forbidden_owner_exit`
    - `test_delete_member_last_admin_forbidden`
    - `test_delete_member_default_library_forbidden`
- add ownership-transfer tests:
  - `test_transfer_ownership_success_promotes_target_to_admin_and_preserves_previous_owner_admin`
  - `test_transfer_ownership_idempotent_when_target_is_current_owner`
  - `test_transfer_ownership_non_owner_admin_owner_required`
  - `test_transfer_ownership_non_owner_member_owner_required`
  - `test_transfer_ownership_non_member_masked_not_found`
  - `test_transfer_ownership_default_library_forbidden`
  - `test_transfer_ownership_target_non_member_invalid`
  - `test_transfer_ownership_updates_updated_at_on_actual_change`
  - `test_transfer_then_previous_owner_exit_path_allowed`
- add invariant-hardening test:
  - `test_governance_mutation_repairs_owner_admin_invariant`
    - construct dirty fixture (owner membership missing or non-admin), execute governance mutation, assert invariant restored.

### `python/tests/test_errors.py`
- no new enum additions expected.
- keep mapping assertions green for governance codes used by pr-03 flows.

---

## acceptance tests

### file: `python/tests/test_libraries.py`

**test: `test_delete_library_non_owner_admin_returns_owner_required`**
- input: viewer is admin but not owner of non-default library.
- output: `403 E_OWNER_REQUIRED`.

**test: `test_delete_library_owner_can_delete_multi_member_non_default`**
- input: owner deletes non-default library with multiple members.
- output: `204`; library row removed; cascade behavior unchanged.

**test: `test_list_members_admin_success_order_owner_admin_member`**
- input: owner + one admin + one member in library.
- output: `200`; order is owner first, then admin, then member.

**test: `test_patch_member_role_non_admin_member_forbidden`**
- input: caller is member (not admin/owner) and attempts role mutation.
- output: `403 E_FORBIDDEN`.

**test: `test_patch_member_role_non_member_masked_not_found`**
- input: caller is not a library member and attempts role mutation.
- output: `404 E_LIBRARY_NOT_FOUND`.

**test: `test_patch_member_role_owner_target_forbidden_owner_exit`**
- input: caller attempts to demote owner via member-role endpoint.
- output: `403 E_OWNER_EXIT_FORBIDDEN`.

**test: `test_patch_member_role_default_library_forbidden`**
- input: admin/owner attempts role mutation in default library.
- output: `403 E_DEFAULT_LIBRARY_FORBIDDEN`.

**test: `test_delete_member_absent_is_idempotent_204`**
- input: caller deletes non-existent membership target in non-default library.
- output: `204` with no side effects.

**test: `test_delete_member_last_admin_forbidden`**
- input: attempt to remove/demote final admin membership.
- output: `403 E_LAST_ADMIN_FORBIDDEN`.

**test: `test_delete_member_non_member_masked_not_found`**
- input: caller is not a member and attempts member delete.
- output: `404 E_LIBRARY_NOT_FOUND`.

**test: `test_transfer_ownership_success_promotes_target_to_admin_and_preserves_previous_owner_admin`**
- input: owner transfers to existing member with role `member`.
- output:
  - `200`
  - library owner pointer updated
  - target role `admin`
  - previous owner role `admin`

**test: `test_transfer_ownership_target_non_member_invalid`**
- input: owner transfers to user id that is not an existing library member.
- output: `409 E_OWNERSHIP_TRANSFER_INVALID`.

**test: `test_transfer_ownership_non_owner_member_owner_required`**
- input: caller is a member of library but not owner and attempts ownership transfer.
- output: `403 E_OWNER_REQUIRED`.

**test: `test_transfer_ownership_non_member_masked_not_found`**
- input: caller is not a library member and attempts ownership transfer.
- output: `404 E_LIBRARY_NOT_FOUND`.

**test: `test_transfer_ownership_default_library_forbidden`**
- input: owner attempts ownership transfer on default library.
- output: `403 E_DEFAULT_LIBRARY_FORBIDDEN`.

**test: `test_transfer_ownership_updates_updated_at_on_actual_change`**
- input: successful ownership transfer to a different target member.
- output: `libraries.updated_at` is strictly newer after transfer commit.

**test: `test_transfer_then_previous_owner_exit_path_allowed`**
- input: owner transfers ownership, then previous owner is demoted/removed via member endpoint.
- output: follow-up exit mutation succeeds (no `E_OWNER_EXIT_FORBIDDEN`).

**test: `test_governance_mutation_repairs_owner_admin_invariant`**
- input: intentionally corrupted owner-membership state, then governance mutation.
- output: owner membership exists and is `admin` after commit.

---

## non-goals
- does not implement invitation lifecycle endpoints (`pr-04`).
- does not implement closure-edge/backfill worker or requeue behavior (`pr-05`).
- does not change conversation/highlight/search endpoint contracts.
- does not add schema migrations.
- does not introduce full library-membership ui/ux management screens.

---

## constraints
- only modify files listed in deliverables.
- route handlers remain transport-only (no domain sql/business logic in routes).
- masking policy remains strict:
  - non-visible/non-member library operations -> masked `404 E_LIBRARY_NOT_FOUND`.
  - visible-but-insufficient capability -> `403`.
  - invalid state transitions/preconditions -> `409`.
- owner-only actions must use `E_OWNER_REQUIRED`, not generic `E_FORBIDDEN`.
- owner exit attempts through member mutation paths must use `E_OWNER_EXIT_FORBIDDEN`.
- last-admin protection must be race-safe under concurrent requests.
- non-member access to admin/member/transfer routes must remain masked `404 E_LIBRARY_NOT_FOUND`.
- do not regress existing rename/add-media/remove-media admin behavior.
- no new third-party dependencies.

---

## boundaries (for ai implementers)

**do**:
- enforce owner/admin boundary exactly as specified.
- add member and transfer endpoints with explicit error-code semantics.
- fix backend parity for `GET /libraries/{id}`.
- add bff proxy routes for all new endpoints.
- include integration tests for every governance branch listed.
- include minimal owner-only delete ui guard on libraries list page.

**do not**:
- implement invite acceptance/decline/revoke flows.
- implement closure/backfill materialization side effects.
- weaken error masking by returning existence-leaking distinctions.
- introduce opportunistic large frontend refactors.
- change unrelated endpoint response schemas.

---

## checklist
- [ ] legacy delete single-member prohibition is removed.
- [ ] non-owner admin delete returns `403 E_OWNER_REQUIRED`.
- [ ] `GET /libraries/{library_id}` backend route is implemented and covered.
- [ ] member endpoints (`GET/PATCH/DELETE`) are implemented with exact auth + error semantics.
- [ ] ownership transfer endpoint is implemented with exact auth + idempotency + error semantics.
- [ ] default-library membership mutation is forbidden (`PATCH/DELETE members`, transfer ownership).
- [ ] owner non-removable/non-demotable-before-transfer enforced via `E_OWNER_EXIT_FORBIDDEN`.
- [ ] last-admin protection enforced via `E_LAST_ADMIN_FORBIDDEN`.
- [ ] non-member access to member/transfer routes is masked `404 E_LIBRARY_NOT_FOUND`.
- [ ] governance mutations repair owner-admin invariant if dirty state is encountered.
- [ ] next.js bff proxy routes exist for all new governance endpoints.
- [ ] libraries list ui hides delete affordance for non-owner admins.
- [ ] `python/tests/test_libraries.py` includes full governance matrix and passes.
