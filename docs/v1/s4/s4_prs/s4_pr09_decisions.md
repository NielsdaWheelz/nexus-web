# s4 pr-09 decisions

## status
working ledger for behavior decisions required by `s4_pr09.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | pr-09 can easily become a refactor bucket and violate l3 ownership boundaries. | keep pr-09 hardening-only: allow only minimal blocking drift fixes required to satisfy acceptance/compatibility/helper audits. | absorb feature churn from earlier prs into pr-09 for convenience. | preserves slice decomposition and prevents late-stage scope smuggling. | audit tests must fail before any behavior patch is allowed in pr-09. | slice owner + pr-09 implementer | if change is feature-level, stop and reassign to owner pr docs first. | locked |
| d-002 | scenario coverage evidence is fragmented across many test modules and can rot in pr-body-only notes. | add committed matrix file (`s4_pr09_acceptance_matrix.md`) as source of truth for scenario 1-15 -> tests mapping. | rely only on temporary pr description text with no in-repo artifact. | makes scenario coverage durable and reviewable post-merge. | matrix row completion requires at least one exact automated test reference per scenario. | pr-09 implementer | if matrix conflicts with tests, tests win and matrix must be corrected before merge. | locked |
| d-003 | scenario 11 ordering contract for `scope=all` is not explicitly asserted today. | add one minimal integration test in `test_conversations.py` for `updated_at DESC, id DESC` ordering on mixed visibility rows. | treat existing cursor-stability test as sufficient; defer ordering assertion to future slice. | closes explicit acceptance gap without changing public contract. | add `test_list_conversations_scope_all_order_is_updated_at_desc_id_desc`. | pr-09 implementer | if test exposes behavior bug, patch smallest code path necessary and document as blocking drift fix. | locked |
| d-004 | compatibility audit can be flaky and ambiguous if only end-to-end tests are used. | use static/introspection checks for limits/schema contracts plus existing runtime `/search` shape test as compatibility proof. | add only runtime tests; add only static checks with no runtime proof. | strengthens compatibility guarantees with low flake risk. | add `test_s4_compatibility_audit.py` and keep `test_search_response_shape_remains_results_page` as runtime gate. | pr-09 implementer | if introspection is brittle, tighten assertions but keep deterministic checks. | locked |
| d-005 | helper-retirement can silently regress if not enforced. | add static helper-retirement audit tests for deprecated symbol absence, split-helper presence, and search read-path helper usage. | manual grep-only review; large runtime refactor in pr-09. | enforces canonical helper boundary at slice end. | add `test_s4_helper_retirement_audit.py` with explicit failure conditions. | pr-09 implementer | if matcher false-positives, switch to AST-level checks; do not remove audit coverage. | locked |
| d-006 | drift discovered in pr-09 needs clear triage to avoid ownership confusion. | enforce two-lane triage: blocking drift fixed minimally in pr-09; non-blocking feature churn reassigned to owner prs with roadmap and handoff updates. | fix all drift in pr-09 regardless of ownership; ignore drift and ship. | keeps accountability with the owning contract layer/pr. | add/update handoff + roadmap pointers whenever reassignment occurs. | slice owner + pr-09 implementer | if ownership is ambiguous, resolve at roadmap level before implementation changes. | locked |
| d-007 | final handoff state can remain implicit and be lost after merge. | add `s4_pr09_handoff.md` with final per-pr l4 inputs (files, invariants, tests, non-goals) and deferred churn section. | leave handoff as chat history only. | freezes implementation boundaries for downstream execution and maintenance. | doc gate in pr checklist; no merge until handoff note is complete. | pr-09 implementer | if no deferred churn exists, record `none` explicitly. | locked |
| d-008 | legacy share service functions (`set_sharing_mode`/`add_share`/`set_shares`) still allow default-library targets, violating s4 invariant outside route-owned owner APIs. | patch these legacy service entry points in pr-09 to forbid default-library targets with `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`, and update service-layer tests accordingly. | ignore legacy path and rely only on route-level prohibition; defer to a future refactor pr. | closes cross-surface invariant hole for conversation-share default-library prohibition. | add `test_set_sharing_mode_default_library_forbidden`, `test_add_share_default_library_forbidden`, and `test_set_shares_default_library_forbidden` in `test_shares.py`. | pr-09 implementer | if patch scope grows beyond prohibition guard, stop and keep minimal invariant closure only. | locked |
| d-009 | drift triage reassignment lane is process-oriented and cannot be fully proven by runtime tests. | split enforcement: automated tests gate blocking technical drift; docs gate enforces owner-pr reassignment evidence (`deferred churn` section + roadmap pointers). | claim reassignment discipline is fully test-covered; leave reassignment implicit. | keeps technical and process controls explicit without fake test guarantees. | keep automated audit suites plus explicit doc review checklist gate for reassignment artifacts. | slice owner + pr-09 implementer | if reassignment occurs without doc evidence, pr is not merge-ready. | locked |
| d-010 | stale module docstrings in conversation/highlight services still describe pre-s4 owner-only read semantics. | update module/header docstrings in pr-09 as behavior-neutral hardening to match merged s4 semantics. | leave stale docs unchanged; defer to optional cleanup. | reduces handoff/maintenance error risk without contract changes. | no behavior tests required; ensure no runtime changes accompany docstring edits. | pr-09 implementer | if wording ambiguity appears, copy exact l2/l3 invariant phrasing. | locked |
