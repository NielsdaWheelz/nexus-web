# s4 pr-06 decisions

## status
working ledger for behavior decisions required by `s4_pr06.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | pr boundary drift risk | keep pr-06 scope to conversation shared-read/list scope, conversation share routes, `ConversationOut` additive fields, and bff share proxy parity. | absorb highlight/search or closure/backfill changes in same pr. | preserves single-owner l3 decomposition and prevents overlap with pr-07/pr-08. | traceability excludes out-of-scope surfaces; explicit non-goals remain enforced. | slice owner + pr-06 implementer | if scope pressure appears, patch l3/l2 first. | locked |
| d-002 | `scope=shared` semantics can drift between teams | define `shared` as all visible conversations not owned by viewer (public + library-shared). | `shared` means library-shared-only. | keeps canonical set identity: `all = mine âˆª shared`. | add tests proving public non-owned conversations appear in `scope=shared` and owned conversations do not. | pr-06 implementer | if product later needs narrower view, introduce explicit new scope token. | locked |
| d-003 | owner-gated share endpoints need explicit capability-vs-visibility error split | share routes return masked `404 E_CONVERSATION_NOT_FOUND` for non-visible conversation and `403 E_OWNER_REQUIRED` for visible non-owner. | mask both cases as `404`; return generic `403 E_FORBIDDEN` for non-owner. | aligns with l2 masking policy and owner capability semantics. | add tests for both branches: non-visible masked 404 and visible non-owner 403 owner-required. | pr-06 implementer | if endpoint-level policy changes, update l2/l3 before implementation changes. | locked |
| d-004 | duplicate `library_ids` in `PUT /shares` create avoidable conflict noise | normalize payload as set by deduping duplicate library ids before validation/write. | reject duplicates as invalid request. | preserves idempotent desired-state semantics for replacement endpoint. | add explicit duplicate-input test asserting one resulting share row. | pr-06 implementer | keep dedupe in service layer even if client dedupes earlier. | locked |
| d-005 | partial share replacement on mixed-valid targets causes ambiguous state | validate all target libraries first and apply replacement atomically (all-or-nothing). | best-effort partial update with per-target errors. | avoids split-brain share sets and retry reconciliation issues. | add atomicity test ensuring failed request leaves prior share set unchanged. | pr-06 implementer | on validation failure, no writes are committed. | locked |
| d-006 | `GET /shares` without explicit ordering is nondeterministic | enforce deterministic order `library_id ASC`. | rely on natural table order; order by `created_at` only. | stabilizes response ordering and prevents nondeterministic diffs. | add ordering assertion test in share list endpoint coverage. | pr-06 implementer | if product needs alternate ordering, add explicit sort contract later. | locked |
| d-007 | conversation visibility logic can fork in list/read endpoints | list/get/messages consume canonical conversation visibility helper(s); no ad-hoc duplicate read-auth SQL path in conversation services/routes. | inline independent visibility SQL in list path; route-level ad-hoc checks. | keeps conversation auth consistent and reduces drift into pr-08 search alignment. | add structural/behavior tests proving scope results match canonical visibility branches. | pr-06 implementer | extend canonical helper layer first if current helper shape is insufficient. | locked |
| d-008 | mixed transaction ownership in shares service risks partial state and hidden commits | share helpers called by routes do not own commits/rollbacks; orchestration boundary owns transaction lifecycle. | keep current commit-inside-helper pattern for route-facing functions. | ensures atomic replacement + predictable rollback semantics for multi-step operations. | add tests around failure paths to verify no partial write leakage. | pr-06 implementer | temporary wrappers allowed only during refactor and must be removed pre-merge. | locked |
| d-009 | `ConversationOut` additive fields can be applied inconsistently across endpoints | `owner_user_id` and `is_owner` must be emitted from one constructor path (`conversation_to_out`) used by read/list and send-message flows. | patch fields in each endpoint independently. | preserves additive schema invariant and avoids payload divergence. | add send-message and read/list response assertions for new fields. | pr-06 implementer | if a legacy path bypasses helper, patch to helper before merge. | locked |
| d-010 | new share endpoints can drift on response shape between GET and PUT | define `ConversationSharesOut` and require both owner share routes to return that exact schema. | route-specific ad-hoc dict payloads with inconsistent fields/order. | keeps share endpoint contracts deterministic and easier to consume/test. | add endpoint tests asserting response schema fields for both GET and PUT. | pr-06 implementer | if shape evolves later, patch l2/l3/l4 and client adapters together. | locked |
| d-011 | scope-all/shared pagination can break if visibility filtering is applied after limiting | apply visibility predicate in SQL before cursor comparison and `LIMIT`; forbid post-limit filtering for list scopes. | fetch rows then filter in python; cursor over unfiltered set. | preserves invariant 13 (`updated_at DESC, id DESC`) with no skip/dup under mixed visibility. | add mixed-visibility pagination tests that fail on post-limit filtering behavior. | pr-06 implementer | if canonical helper cannot express SQL predicate, extend helper layer before route/service changes. | locked |
| d-012 | invalid `scope` handling can leak framework-dependent status codes | validate conversation `scope` in app logic and return `400 E_INVALID_REQUEST` for any token outside exact `mine|all|shared`; never emit `422` for this contract. | rely on framework enum/query validation and accept 422 transport behavior. | hardens deterministic API contract and avoids framework-coupled status drift. | add tests asserting invalid scope returns `400 E_INVALID_REQUEST` and explicitly not `422`. | pr-06 implementer | if request parsing is refactored, keep contract tests and explicit validation path. | locked |
