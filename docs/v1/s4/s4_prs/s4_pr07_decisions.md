# s4 pr-07 decisions

## status
working ledger for behavior decisions required by `s4_pr07.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | pr boundary drift risk | keep pr-07 scope to highlight shared-read (`mine_only` list mode + shared point-read), additive `HighlightOut` fields, and unchanged author-only mutation semantics. | absorb search alignment or non-highlight auth refactors into this pr. | preserves l3 single-owner decomposition and avoids overlap with pr-08. | traceability excludes search and non-highlight surfaces; non-goals remain explicit. | slice owner + pr-07 implementer | if scope pressure appears, patch l3/l2 first. | locked |
| d-002 | `mine_only` query parsing can leak framework-dependent `422` responses and broad bool coercions | parse `mine_only` explicitly at app layer: default omitted->`true`; accept only case-sensitive tokens `true|false`; any other token returns `400 E_INVALID_REQUEST`. | rely on framework bool parser (`422` for some values, coercion for others); silently accept mixed tokens (`1`, `on`, `TRUE`). | hardens deterministic transport contract for highlight list endpoint and avoids framework-coupled behavior drift. accepted compatibility tradeoff: legacy non-canonical bool tokens are intentionally rejected in s4 pr-07. | add invalid-input tests asserting `400 E_INVALID_REQUEST` and explicitly asserting not `422`, including `TRUE` and `1`. | pr-07 implementer | if route parsing changes later, keep explicit validation branch and contract tests. | locked |
| d-003 | point-read and list-read highlight visibility can drift if they use separate auth logic | add canonical highlight-visibility helper surface in `permissions.py` with both: (a) sql predicate builder for list queries, and (b) exists/boolean wrapper for point reads; require both `can_read_highlight(...)` and list-read path to consume that surface. | keep duplicated sql in service; use per-row python calls to `can_read_highlight(...)` after broad fetch. | enforces one read-auth predicate for highlight visibility and removes n+1/list drift risk. | add tests proving list/get behavior match canonical visibility matrix including revoked-membership branch. | pr-07 implementer | if helper surface is insufficient, extend canonical helper API first; do not merge duplicate read-auth paths. | locked |
| d-004 | additive `HighlightOut` fields can drift across endpoints if only patched on read routes | emit `author_user_id` and `is_owner` on every endpoint returning `HighlightOut` (create/list/get/update) via one constructor path. | add fields to list/get only; construct fields separately per endpoint. | preserves additive schema uniformity and avoids client shape branching per endpoint. | add assertions across create/list/get/update payloads for both fields and viewer-local `is_owner` value. | pr-07 implementer | if contract changes later, patch l2/l3/l4 and all endpoint assertions together. | locked |
| d-005 | list ordering can be nondeterministic when `start_offset` and `created_at` tie | enforce deterministic tie-break ordering: `start_offset ASC, created_at ASC, id ASC`. | keep only `start_offset ASC, created_at ASC` and accept planner-dependent tie order. | preserves existing ordering semantics while eliminating tie instability/flaky pagination assumptions. | add explicit tie-case test asserting `id ASC` ordering for equal primary sort keys. | pr-07 implementer | if l2 later prescribes a different tie-break field, update spec + tests together. | locked |
