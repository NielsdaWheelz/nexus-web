# pr-07: highlight shared-read contract

## goal
expose shared highlight reads while preserving author-only mutation.

## context
- `docs/v1/s4/s4_roadmap.md` assigns pr-07 ownership for highlight shared-read behavior and `HighlightOut` additive fields.
- `docs/v1/s4/s4_spec.md` section 6.7 defines `mine_only` query behavior and author-only mutation invariants.
- `docs/v1/s4/s4_spec.md` section 3.6 defines additive `HighlightOut` fields: `author_user_id`, `is_owner`.
- merged baseline still has gaps:
  - `python/nexus/api/routes/highlights.py` has no `mine_only` query contract on list endpoint.
  - `python/nexus/services/highlights.py` list path still filters `Highlight.user_id == viewer_id`.
  - `python/nexus/auth/permissions.py` has only point-read `can_read_highlight(...)`; no reusable sql predicate path for list visibility.
  - `python/nexus/schemas/highlights.py` lacks `author_user_id` and `is_owner`.

## dependencies
- pr-02

---

## deliverables

### `python/nexus/schemas/highlights.py`
- add additive `HighlightOut` fields:
  - `author_user_id: UUID`
  - `is_owner: bool`
- preserve all existing fields and optional `annotation` shape.

### `python/nexus/auth/permissions.py`
- add canonical highlight-visibility sql helper(s) reusable by both point-read and list-read paths.
- helper api must include both surfaces:
  - a sql-expression/predicate builder usable inside list queries.
  - an exists/boolean wrapper used by `can_read_highlight(...)`.
- helper semantics must match s4 section 5.2 exactly:
  - viewer can read anchor media via s4 provenance.
  - viewer and highlight author share membership in at least one library containing anchor media.
- `can_read_highlight(...)` must consume canonical helper(s) rather than maintain an independent ad-hoc path.
- forbid python-loop visibility checks for list-read mode.

### `python/nexus/services/highlights.py`
- extend list service contract to support `mine_only`:
  - `mine_only=true`: author = viewer only.
  - `mine_only=false`: include all visible highlights under canonical predicate.
- update list query to apply visibility in sql using canonical helper(s), not post-query python filtering.
- preserve existing list ordering contract and make ties deterministic:
  - `ORDER BY start_offset ASC, created_at ASC, id ASC`
  - (`id ASC` is tie-break only; existing user-visible ordering semantics remain unchanged).
- update highlight response constructor path to emit additive fields:
  - `author_user_id = highlight.user_id`
  - `is_owner = (highlight.user_id == viewer_id)`
- additive fields must be present for every endpoint returning `HighlightOut`:
  - create
  - list
  - get
  - update
- keep `GET /highlights/{highlight_id}` visibility under canonical predicate.
- keep mutation flows author-only with masked `404 E_MEDIA_NOT_FOUND`.

### `python/nexus/api/routes/highlights.py`
- add `mine_only` query parameter to `GET /fragments/{fragment_id}/highlights`.
- enforce deterministic app-level parse/validation:
  - default when omitted: `mine_only=true`.
  - accepted tokens (case-sensitive): `true`, `false`.
  - any other token returns `400 E_INVALID_REQUEST`.
  - do not rely on framework bool coercion or framework-driven `422` behavior.
- keep response envelope shape unchanged: `{ "data": { "highlights": [...] } }`.
- keep mutation route contracts unchanged in this pr.

### `python/tests/test_highlights.py`
- update integration coverage for:
  - list default behavior (`mine_only=true`).
  - list shared-visible behavior (`mine_only=false`).
  - invalid `mine_only` contract: deterministic `400 E_INVALID_REQUEST` (not `422`).
  - shared-reader point-read behavior for `GET /highlights/{id}`.
  - author-only mutation masking remains unchanged.
  - canonical visibility behavior (shared membership present vs revoked) on list/get.
  - response payload includes `author_user_id` and `is_owner` across create/list/get/update.

### `python/tests/test_web_article_highlight_e2e.py`
- replace owner-only read-isolation e2e assertions with s4-compatible contract:
  - shared reader can list/get.
  - shared reader cannot mutate (masked 404).
- keep non-member isolation assertions where viewer lacks media visibility.

---

## decision ledger

| id | question | decision | rationale | fallback/default |
|---|---|---|---|---|
| d-001 | what is pr-07 scope boundary? | restrict to highlight shared-read contract (`mine_only`, shared point-read, additive `HighlightOut`, unchanged mutation auth). | matches l3 ownership and prevents leakage into pr-08 search work. | if new behavior appears required, patch l3/l2 first. |
| d-002 | invalid `mine_only` input contract (`422` vs app-level `400`)? | deterministic app validation: only exact `true|false`; invalid returns `400 E_INVALID_REQUEST`, never framework `422`. | keeps transport contract stable across framework/parser changes and mirrors pr-06 determinism standard. | if parsing is refactored later, keep explicit contract tests and app-level validation branch. |
| d-003 | how to avoid read-auth drift between point-read and list-read? | add canonical highlight-visibility sql helper(s) in `permissions.py`; reuse in both `can_read_highlight(...)` and list query path. | single-source predicates prevent divergence and reduce n+1/logic drift risk. | if helper shape is insufficient, extend canonical helper layer first; do not duplicate auth sql in service. |
| d-004 | where should additive `HighlightOut` fields be emitted? | emit `author_user_id` and `is_owner` in every endpoint returning `HighlightOut` (create/list/get/update). | partial rollout creates schema drift and client parsing ambiguity. | if future contract narrows fields, update l2/l3/l4 and all endpoint tests in lockstep. |
| d-005 | how to avoid nondeterministic ordering when `start_offset` and `created_at` tie? | add `id ASC` deterministic tie-break after required ordering keys. | removes flaky ordering under legal timestamp ties without changing contract-level sorting behavior. | if l2 later formalizes tie-break field, follow l2 exactly and keep deterministic tests aligned. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| `GET /fragments/{fragment_id}/highlights` supports `mine_only` with default `true`. | `python/nexus/api/routes/highlights.py`; `python/nexus/services/highlights.py` | `python/tests/test_highlights.py` (`test_list_highlights_defaults_to_mine_only_true`) |
| `mine_only=false` returns visible shared highlights under canonical predicate. | `python/nexus/services/highlights.py`; `python/nexus/auth/permissions.py` | `python/tests/test_highlights.py` (`test_list_highlights_mine_only_false_returns_visible_shared`) |
| `GET /highlights/{highlight_id}` supports shared readers under canonical predicate. | `python/nexus/services/highlights.py` | `python/tests/test_highlights.py` (`test_get_highlight_shared_reader_visible_success`) |
| mutation endpoints remain author-only with masked 404 semantics. | `python/nexus/services/highlights.py`; `python/nexus/api/routes/highlights.py` | `python/tests/test_highlights.py` (`test_update_highlight_non_author_masked_404`, `test_delete_highlight_non_author_masked_404`, `test_annotation_upsert_non_author_masked_404`) |
| highlight endpoints consume pr-02 canonical helpers; no ad-hoc duplicate read-auth sql paths. | `python/nexus/auth/permissions.py`; `python/nexus/services/highlights.py` | `python/tests/test_highlights.py` (`test_list_and_get_highlight_visibility_match_canonical_predicate`) |
| `HighlightOut` includes `author_user_id` and `is_owner`. | `python/nexus/schemas/highlights.py`; `python/nexus/services/highlights.py` | `python/tests/test_highlights.py` (`test_highlight_out_includes_author_fields`) |
| tests updated in `python/tests/test_highlights.py` and `python/tests/test_web_article_highlight_e2e.py`. | `python/tests/test_highlights.py`; `python/tests/test_web_article_highlight_e2e.py` | `python/tests/test_highlights.py` (`test_list_highlights_defaults_to_mine_only_true`, `test_list_highlights_mine_only_false_returns_visible_shared`, `test_get_highlight_shared_reader_visible_success`, `test_update_highlight_non_author_masked_404`, `test_delete_highlight_non_author_masked_404`, `test_annotation_upsert_non_author_masked_404`, `test_highlight_out_includes_author_fields`, `test_list_and_get_highlight_visibility_match_canonical_predicate`, `test_list_highlights_invalid_mine_only_returns_400_e_invalid_request_not_422`, `test_list_highlights_order_is_deterministic_with_created_at_ties`); `python/tests/test_web_article_highlight_e2e.py` (`test_shared_reader_can_list_and_get_highlights_but_cannot_mutate`, `test_non_member_cannot_list_or_get_highlights`) |
| deterministic `mine_only` input behavior (hardening decision d-002). | `python/nexus/api/routes/highlights.py` | `python/tests/test_highlights.py` (`test_list_highlights_invalid_mine_only_returns_400_e_invalid_request_not_422`) |
| deterministic list order under timestamp ties (hardening decision d-005). | `python/nexus/services/highlights.py` | `python/tests/test_highlights.py` (`test_list_highlights_order_is_deterministic_with_created_at_ties`) |

---

## acceptance tests

### file: `python/tests/test_highlights.py`

**test: `test_list_highlights_defaults_to_mine_only_true`**
- input: viewer can read media with highlights from multiple authors; call list endpoint without `mine_only`.
- output: only viewer-authored highlights returned.

**test: `test_list_highlights_mine_only_false_returns_visible_shared`**
- input: viewer can read media and shares at least one containing library with other highlight authors; call list endpoint with `mine_only=false`.
- output: viewer + other visible authors' highlights returned.

**test: `test_list_and_get_highlight_visibility_match_canonical_predicate`**
- input: matrix covering (a) shared containing-library intersection present, (b) intersection absent, (c) intersection revoked after membership removal.
- output: list with `mine_only=false` and get-by-id produce identical allow/deny results under canonical visibility for each matrix row.

**test: `test_list_highlights_invalid_mine_only_returns_400_e_invalid_request_not_422`**
- input: call `GET /fragments/{id}/highlights?mine_only=TRUE`, `?mine_only=1`, and `?mine_only=invalid`.
- output: each returns `400 E_INVALID_REQUEST`; never `422`.
- note: strict token behavior is intentional in this pr; compatibility with legacy non-canonical bool tokens is not preserved.

**test: `test_get_highlight_shared_reader_visible_success`**
- input: viewer is not author but satisfies canonical highlight visibility.
- output: `GET /highlights/{id}` returns `200`.

**test: `test_get_highlight_shared_reader_revoked_membership_masked_404`**
- input: viewer previously shared visibility, then shared-library membership is revoked.
- output: `GET /highlights/{id}` returns `404 E_MEDIA_NOT_FOUND` immediately after revocation.

**test: `test_update_highlight_non_author_masked_404`**
- input: viewer can read highlight but is not author; call patch.
- output: `404 E_MEDIA_NOT_FOUND`.

**test: `test_delete_highlight_non_author_masked_404`**
- input: viewer can read highlight but is not author; call delete.
- output: `404 E_MEDIA_NOT_FOUND`.

**test: `test_annotation_upsert_non_author_masked_404`**
- input: viewer can read highlight but is not author; call annotation put.
- output: `404 E_MEDIA_NOT_FOUND`.

**test: `test_highlight_out_includes_author_fields`**
- input: create/list/get/update success responses.
- output: each returned highlight includes `author_user_id` and `is_owner`, with `is_owner` viewer-local truth value.

**test: `test_list_highlights_order_is_deterministic_with_created_at_ties`**
- input: multiple highlights on same fragment with identical `start_offset` and forced identical `created_at`.
- output: list order is deterministic by `id ASC` tie-break after `start_offset`, `created_at`.

### file: `python/tests/test_web_article_highlight_e2e.py`

**test: `test_shared_reader_can_list_and_get_highlights_but_cannot_mutate`**
- input: user a authors highlights on media in shared library with user b.
- output: user b `GET /fragments/{id}/highlights?mine_only=false` and `GET /highlights/{id}` succeed; patch/delete/annotation put by user b are masked `404 E_MEDIA_NOT_FOUND`.

**test: `test_non_member_cannot_list_or_get_highlights`**
- input: user b has no media visibility and no shared membership intersection.
- output: list/get remain masked `404 E_MEDIA_NOT_FOUND`.

---

## non-goals
- no annotation mutation model changes.
- no search behavior changes (owned by pr-08).
- no schema changes beyond additive `HighlightOut` fields.

---

## constraints
- only touch files listed in deliverables unless this spec is revised.
- preserve envelope and error-code contracts from s4 spec section 6.7.
- avoid introducing new duplicate visibility helpers.

---

## boundaries (for ai implementers)

**do**:
- implement only highlight shared-read and `mine_only` list behavior.
- preserve author-only mutation masking semantics.
- add assertions for every behavior-changing decision.

**do not**:
- modify annotation mutation semantics beyond read-authority side effects required by shared reads.
- change search/auth behavior owned by pr-08.
- change unrelated route/module structure.

---

## open questions + temporary defaults

| question | temporary default behavior | owner | due |
|---|---|---|---|
| none | n/a | n/a | n/a |

---

## checklist
- [x] every l3 acceptance bullet is in traceability matrix
- [x] every traceability row has at least one test
- [x] every behavior-changing decision has assertions
- [x] only scoped files are touched
- [x] non-goals are explicit and enforced
