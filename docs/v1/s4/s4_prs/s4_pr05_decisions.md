# s4 pr-05 decisions

## status
working ledger for behavior decisions required by `s4_pr05.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | pr boundary drift risk | keep pr-05 scope to closure writer touchpoints, backfill worker mechanics, and internal requeue endpoint only. | absorb adjacent conversation/highlight/search cleanup in same pr. | enforces single-owner l3 decomposition; prevents scope smuggling. | traceability must not include pr-06+ surfaces. | slice owner + pr-05 implementer | if scope pressure appears, patch l3/l2 first. | locked |
| d-002 | closure logic is duplicated and transaction ownership is ambiguous | introduce `python/nexus/services/default_library_closure.py` as single invariant module; helpers accept `Session` and never call `commit()`/`rollback()`. | keep ad hoc sql in `libraries.py`/`upload.py`/`media.py`/`ingest_web_article.py`. | preserves service-owned invariants while keeping transaction control at caller boundaries. | add assertions that all touched writer paths delegate to shared helpers. | pr-05 implementer | if extraction risk spikes, keep module and defer non-essential helper variants. | locked |
| d-003 | queue mismatch can silently drop work; backlog can starve | route backfill tasks to queue `ingest` in s4 mvp and define guardrails: degraded if pending age p95 > 900s for 15m or pending count > 500 for 15m. | add new queue immediately without worker topology changes; ignore backlog thresholds. | keeps dispatch operational in current infra and makes saturation actionable. | add tests for explicit queue routing; add backlog-query helper test coverage if helper is introduced. | slice owner + oncall | if guardrails breach persistently, next ops slice splits queue topology. | locked |
| d-004 | duplicate deliveries can create duplicate state transitions | claim jobs with one atomic statement: `UPDATE ... SET status='running' ... WHERE status='pending' RETURNING ...`; missing/non-pending claim is no-op. | select-then-update two-step claim; raise on duplicates. | guarantees at-most-one runner per pending state transition. | add test proving non-pending/missing claim returns skipped result. | pr-05 implementer | no-op remains authoritative for duplicate deliveries. | locked |
| d-005 | stale workers could overwrite terminal states | require status-guarded transitions for complete/fail paths: update rows only when current status is `running`. | unconditional updates keyed only by pk tuple. | prevents stale tasks from clobbering later state. | add tests that complete/fail helpers no-op when row is not `running`. | pr-05 implementer | if guarded update affects zero rows, task returns skipped/stale result. | locked |
| d-006 | retry schedule ambiguity causes off-by-one drift | encode retries as durable-state loop with delays `[60,300,900,3600,21600]`; increment `attempts` first, then use `delay[attempts-1]`; stop auto-retry at `attempts>=5`. | celery autoretry; implicit backoff math at call sites. | keeps retries deterministic and inspectable in db row state. | add tests for attempt<5 and attempt=5 branch behavior with exact countdown assertions. | pr-05 implementer | enqueue failure after state commit leaves row `pending` and recoverable via requeue. | locked |
| d-007 | malformed/poisoned task args can violate provenance | worker validates tuple integrity before materialization: job row exists, default library is owned default for `user_id`, source library is non-default. invalid tuple is terminal failed (no inserts). | trust task args blindly; treat invalid tuple as successful no-op. | protects closure tables from corrupted identifiers and cross-user contamination. | add test for invalid tuple path (failed state, no inserts, no retry). | pr-05 implementer | if validation cannot be satisfied, row remains failed for operator action. | locked |
| d-008 | revoke/remove can race running worker and reintroduce closure edges | worker locks membership row `(source_library_id,user_id)` before materialization; missing membership yields zero inserts + job completed. remove-member path already lock-deletes membership and cleanup in one transaction. | read membership without lock; rely on eventual cleanup. | enforces strict revocation immediately after commit under concurrency. | add race-oriented test where membership is removed before worker materialization and no edges are inserted. | pr-05 implementer | if membership lock is unavailable, rely on transaction retry at db layer. | locked |
| d-009 | stale durable intent survives revocation | `remove_library_member` deletes matching backfill job row `(default_library_id, source_library_id, user_id)` during closure cleanup. | keep job rows forever and trust worker no-op gating only. | removes obsolete intent and reduces noisy replay pressure. | add test verifying job-row deletion on member removal. | pr-05 implementer | stale queued delivery still no-ops via claim/membership gates. | locked |
| d-010 | legacy default-remove cascade contradicts s4 invariants | removing media from default library removes intrinsic row then applies gc rule only; no cascade delete across non-default libraries. | keep single-member-library cascade delete behavior. | preserves source-library state and closure provenance correctness. | rewrite failing legacy cascade tests; add explicit intrinsic/closure gc assertions. | pr-05 implementer | none; old behavior is forbidden in s4. | locked |
| d-011 | internal auth divergence risk | internal requeue route uses existing global middleware/internal-header policy; no route-local secret/auth fork. | route-local auth checks or custom secret compare in handler. | keeps one internal auth policy path across internal routes. | add test for `requires_internal_header=True` returning `403 E_INTERNAL_ONLY` without header. | pr-05 implementer | if auth policy changes, update middleware/deps centrally. | locked |
| d-012 | operator endpoint response is too thin for incident triage | requeue response includes `status`, `attempts`, `last_error_code`, `updated_at`, `finished_at`, `idempotent`, `enqueue_dispatched` in addition to job identity. | status-only response; require operators to query db manually. | improves operational observability without changing public contracts. | add response-shape tests for running no-op and reset paths, including enqueue failure reporting. | slice owner + pr-05 implementer | if field expansion is reverted, l2/l3 must be patched explicitly first. | locked |
| d-013 | internal route registration inconsistency can hide endpoints | register `/internal/libraries/backfill-jobs/requeue` through `create_api_router(...)`; `stream_tokens` remains historical app-level exception and is not a precedent for new routes. | add another app-level one-off include; create next.js bff proxy for internal route. | keeps route discovery and transport policy consistent, and preserves internal-only boundary. | add static assertion that no `apps/web/src/app/api/**` proxy route targets `/internal/libraries/backfill-jobs/requeue`. | pr-05 implementer | if router ordering conflict appears, use explicit app include with same path/auth contract and patch docs. | locked |
