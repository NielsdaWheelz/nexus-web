# s4 pr-04 decisions

## status
working ledger for behavior decisions required by `s4_pr04.md`.

| id | question | decision | rationale | fallback/default | status |
|---|---|---|---|---|---|
| d-001 | what is the boundary for pr-04? | limit scope to invitation lifecycle endpoints + atomic accept + bff parity + integration coverage from l3 acceptance. | prevents scope bleed into pr-05 closure worker or other adjacent behavior. | if implementation needs out-of-scope changes, revise l3/l4 first; do not silently absorb scope. | locked |
| d-002 | how should unresolved implementation details be handled during drafting? | use explicit temporary defaults, then promote each default into a locked decision before finalizing the spec. | keeps momentum while preserving auditability and preventing hidden assumptions. | do not start implementation while any behavior-affecting question lacks a locked decision. | locked |
| d-003 | should pr-04 create a new invite service module? | no; keep invite logic in `python/nexus/services/libraries.py`. | current library domain logic is already centralized there; splitting now adds churn without reducing risk for mvp. | if file complexity grows materially, extract in a focused follow-up refactor after pr-04 merge. | locked |
| d-004 | how to prevent `/libraries/invites` from being captured by `/libraries/{library_id}`? | declare static invite routes before dynamic `{library_id}` routes in fastapi router. | avoids UUID-parse leakage and path ambiguity from route declaration order. | add explicit route-resolution test if route layout changes in future. | locked |
| d-005 | should invite payloads reuse generic dicts or explicit schemas? | explicit request/response schemas in `schemas/library.py` for create/accept/decline payloads. | keeps contract typed, testable, and aligned with existing pydantic-first route style. | if schema churn occurs, keep additive-only changes within pr-04-owned invite endpoints. | locked |
| d-006 | should invite tests be split into a new test module? | no for mvp; keep invite integration tests in `python/tests/test_libraries.py`. | existing library endpoint integration harness/fixtures are already there; lowest-friction path. | split later only if test_libraries growth causes maintenance issues. | locked |
| d-007 | should bff routes implement invite-specific logic? | no; proxy-only parity routes with `runtime="nodejs"`. | preserves current architecture boundary: backend owns auth/state transitions. | if ui needs derived state, compute in client layer, not bff route handlers. | locked |
| d-008 | what are accept retry semantics once invite is already `accepted`? | strict idempotent no-op (`200`, `idempotent=true`) with no membership reinsert side effect. | replay must not re-grant access after explicit revocation/removal; terminal-state semantics stay coherent. | if access needs restoration, issue a new invite. | locked |
| d-009 | should accept fail when post-commit enqueue cannot dispatch? | no; keep endpoint success and rely on durable `default_library_backfill_jobs` row. | source-of-truth is DB intent row, not queue dispatch success; this keeps endpoint robust. | log enqueue failure and rely on worker/requeue flow in pr-05. | locked |
| d-010 | how to handle pending-invite duplicates under concurrency? | explicit pre-check for existing membership + pending invite, plus unique-index race mapping to `E_INVITE_ALREADY_EXISTS`. | deterministic business errors and race safety are both required. | unknown integrity constraint failures are surfaced as internal errors, not remapped blindly. | locked |
| d-011 | where should invite bff parity be verified? | add a thin route-unit test file under `apps/web/src/app/api/libraries/` that asserts upstream proxy paths/methods. | acceptance includes bff parity; low-cost route tests prevent silent path drift. | if route test harness proves unstable, require explicit reviewer checklist with file-level parity diff before merge. | locked |
| d-012 | should `GET .../invites` support `status=all` in pr-04? | no. keep strict enum filter with default `pending`. | avoids introducing a new sentinel mode not in l2 contract and keeps query behavior deterministic. | callers that need multiple states issue explicit per-status calls. | locked |
| d-013 | what should self-invite return on create? | `409 E_INVITE_MEMBER_EXISTS` via existing-membership guard. | caller is already a member by definition on invite-create route; this avoids surfacing low-level check-constraint behavior. | if membership invariant is broken unexpectedly, map explicit self-invite validation to same conflict code. | locked |
| d-014 | should create-invite reveal invitee existence to non-members/non-admins? | no. auth/membership checks execute before invitee lookup so unauthorized callers only see masked library errors. | preserves masking policy and prevents user-existence oracle on invite-create path. | keep `E_USER_NOT_FOUND` only for authorized admin callers. | locked |
