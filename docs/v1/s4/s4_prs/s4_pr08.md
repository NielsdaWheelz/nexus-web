# pr-08: search alignment

## goal
make search auth match s4 canonical visibility and enable library-scope message search without changing `/search` response shape.

## context
- `docs/v1/s4/s4_roadmap.md` assigns pr-08 ownership of search alignment and library-scope message search.
- `docs/v1/s4/s4_spec.md` section 6.8 defines required search visibility, scope masking, and response-shape constraints.
- current `python/nexus/services/search.py` still contains s3-era behavior:
  - conversation scope auth uses owner-write helper.
  - annotation search is owner-only.
  - `scope=library:*` message search is disabled.

## dependencies
- pr-02
- pr-06
- pr-07

---

## deliverables

### `python/nexus/services/search.py`
- replace conversation scope auth path in `authorize_scope(...)`:
  - for `scope_type == "conversation"`, use `can_read_conversation(db, viewer_id, scope_id)`.
  - if false, raise masked `NotFoundError(E_CONVERSATION_NOT_FOUND)`.
  - do not call owner-write helper anywhere in search read paths.
- keep typed masking behavior unchanged for other scopes:
  - `media:*` unauthorized -> `404 E_NOT_FOUND`
  - `library:*` unauthorized -> `404 E_NOT_FOUND`
- align visible-media cte with s4 provenance semantics (section 5.1), not plain membership join:
  - non-default membership path.
  - default intrinsic path.
  - default closure path gated by active source membership.
  - no per-row python visibility loops.
- align visible-conversation cte with canonical conversation semantics from pr-06:
  - owner path.
  - public path.
  - library-share path with active dual membership (viewer + owner) in same share-target library.
- update `_search_annotations(...)` visibility:
  - remove owner-only `h.user_id = :viewer_id` filter.
  - enforce s4 highlight visibility semantics in sql:
    - anchor media must be in canonical visible-media cte.
    - viewer and highlight author share at least one containing library for anchor media.
  - keep type/scope compatibility:
    - `scope=conversation:*` still returns empty for annotation type.
- update `_search_messages(...)` for library scope:
  - enable `scope=library:*` instead of returning empty.
  - include message only if conversation is actively library-shared to target library id (`conversation.sharing='library'` + share row to scope library).
  - still enforce canonical conversation visibility and pending-message exclusion.
  - explicitly exclude owner/public conversations not shared to target library.
- preserve non-goal behavior:
  - no ranking/weight/snippet algorithm changes.
  - no cursor algorithm changes.
  - no response envelope change.
- update module-level and function docstrings to remove s3 owner-only annotation/library-message claims.

### `python/nexus/api/routes/search.py`
- preserve external contract:
  - endpoint remains `GET /search`.
  - response shape remains top-level `{ "results": [...], "page": {...} }`.
- if route doc text mentions s3 owner-only annotation behavior, update docs/comments to s4-aligned language only.
- no new query params.

### `python/tests/test_search.py`
- replace s3-owner-only annotation assumptions with s4 shared-visibility assertions.
- add/upgrade integration coverage for:
  - shared conversation scope auth uses read visibility (not owner-only).
  - annotation search returns shared-visible annotations and denies after revocation.
  - message search for `scope=library:*` returns only conversations shared to that target library.
  - unauthorized scope typed-404 masking remains unchanged (`media|library -> E_NOT_FOUND`, `conversation -> E_CONVERSATION_NOT_FOUND`).
  - search response shape remains `{ results, page }`.
  - canonical media provenance applies to search visibility (stale default-library `library_media` without intrinsic/closure is not searchable).

### `python/tests/factories.py`
- if existing factories cannot express required pr-08 setups tersely, add narrowly-scoped helpers for:
  - creating a conversation shared to a specific library.
  - creating test membership/share topologies for library-scope message assertions.
- keep helper additions minimal and search-test-focused; do not refactor unrelated factory surfaces.

---

## decision ledger

| id | question | decision | rationale | fallback/default |
|---|---|---|---|---|
| d-001 | canonical conversation scope auth source in search | use `can_read_conversation(...)` in `authorize_scope(...)`; owner-write helper usage in search is forbidden. | scope auth must match shared-read contract and typed conversation masking semantics. | if refactor pressure appears, keep this bool gate and preserve `E_CONVERSATION_NOT_FOUND` behavior. |
| d-002 | how to align annotation search with highlight visibility | replace owner-only filter with sql predicate matching s4 highlight visibility (media readable + viewer/author library intersection on anchor media). | aligns search annotation results with pr-07 highlight read contract. | if helper extraction is deferred, enforce exact semantic parity with explicit matrix tests in this pr. |
| d-003 | should `scope=library:*` message search include public/owned conversations not shared to that library | no. include only messages whose conversation is actively library-shared to target library (`sharing='library'` + target share row); also enforce canonical conversation visibility. | matches s4 section 6.8 constraints and avoids over-broad library-scope results. | if conversation is owner/public-visible but not actively library-shared to target library, it is excluded. |
| d-004 | should pr-08 fix search media cte provenance mismatch | yes. visible-media cte must implement s4 provenance paths (non-default, intrinsic, closure+active source membership). | without this, search can diverge from canonical read auth and leak stale default-library rows. | if full refactor is blocked, do not ship pr-08 without at least semantic parity + regression tests. |
| d-005 | cross-module helper unification now vs later | keep pr-08 behavior-focused: enforce semantic parity + drift-detecting tests; defer structural helper dedupe/retirement to pr-09. | avoids high-risk refactor churn in a behavior-alignment pr while still locking correctness. | if parity cannot be achieved cleanly within pr-08 scoped files, stop and revise spec before widening scope. |
| d-006 | masking contract under new scope auth path | preserve exact typed masking codes for unauthorized scopes (`media|library -> E_NOT_FOUND`, `conversation -> E_CONVERSATION_NOT_FOUND`). | callers already rely on typed not-found behavior; drift is a contract break. | if internals change, keep status/code assertions as release gate. |
| d-007 | `/search` response shape in s4 | keep existing top-level `{ results, page }`; no envelope migration in this pr. | explicit l2/l3 compatibility requirement. | any response-shape change is deferred to future versioned contract work. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| scope auth uses canonical visibility helpers, not owner-only read helper. | `python/nexus/services/search.py` | `test_scope_conversation_shared_reader_allowed_by_read_visibility`; `test_scope_conversation_not_found` |
| annotation search visibility follows s4 highlight visibility, not owner-only filter. | `python/nexus/services/search.py` | `test_search_annotations_include_shared_visible_results`; `test_search_annotations_hidden_after_membership_revocation` |
| message search for `scope=library:*` is enabled and constrained to conversations shared to target library. | `python/nexus/services/search.py` | `test_scope_library_message_search_includes_only_target_shared_conversations`; `test_scope_library_message_search_excludes_visible_but_unshared_conversations`; `test_scope_library_message_search_requires_library_sharing_state` |
| unauthorized scope masking preserves existing typed 404 behavior. | `python/nexus/services/search.py` | `test_scope_media_not_found`; `test_scope_library_not_found`; `test_scope_conversation_not_found` |
| response shape remains `{ results, page }`. | `python/nexus/api/routes/search.py`; `python/nexus/services/search.py` | `test_search_response_shape_remains_results_page` |
| tests updated in `python/tests/test_search.py` for shared conversation scope, shared annotation visibility, and library-scope message constraints. | `python/tests/test_search.py` | `test_scope_conversation_shared_reader_allowed_by_read_visibility`; `test_search_annotations_include_shared_visible_results`; `test_scope_library_message_search_includes_only_target_shared_conversations` |
| search media/fragment/annotation visibility uses s4 media provenance (hardening decision d-004). | `python/nexus/services/search.py` | `test_search_does_not_return_stale_default_library_rows_without_intrinsic_or_closure` |

---

## acceptance tests

### file: `python/tests/test_search.py`

**test: `test_scope_conversation_shared_reader_allowed_by_read_visibility`**
- input: conversation owned by user `a`, shared to non-default library `l`; both `a` and `b` are members of `l`; `b` is not owner. `b` calls `GET /search?q=...&scope=conversation:{id}&types=message`.
- output: `200`; message rows from that conversation are returned.

**test: `test_scope_conversation_not_found`**
- input: viewer requests `GET /search?q=...&scope=conversation:{id}` for conversation id not visible under canonical read visibility.
- output: masked `404 E_CONVERSATION_NOT_FOUND` (existing typed masking contract preserved).

**test: `test_search_annotations_include_shared_visible_results`**
- input: media `m` in shared library `l`; user `a` authors highlight+annotation on `m`; user `b` has shared visibility to `m` and library intersection with `a`.
- output: `b` searching `types=annotation` can receive annotation result authored by `a`.

**test: `test_search_annotations_hidden_after_membership_revocation`**
- input: start from visible shared-annotation setup, then revoke `b` from intersecting containing library.
- output: subsequent annotation search by `b` no longer returns that annotation.

**test: `test_scope_library_message_search_includes_only_target_shared_conversations`**
- input: `c1` shared to `l1`, `c2` shared to `l2`; viewer `b` is member of `l1` only.
- output: `GET /search?...&scope=library:{l1}&types=message` may return messages from `c1`; never from `c2`.

**test: `test_scope_library_message_search_excludes_visible_but_unshared_conversations`**
- input: viewer has other visible conversations (owned/public/shared-to-other-library) that are not shared to target `library:{l1}`.
- output: those conversation messages are excluded from `scope=library:{l1}` results.

**test: `test_scope_library_message_search_requires_library_sharing_state`**
- input: conversation has a share row to target library but conversation `sharing` is not `library` (e.g., `public`).
- output: conversation messages are excluded from `scope=library:{target}` results.

**test: `test_search_response_shape_remains_results_page`**
- input: representative successful search call.
- output: response has top-level `results` and `page`, with no envelope/field migration.

**test: `test_search_does_not_return_stale_default_library_rows_without_intrinsic_or_closure`**
- input: create default-library `library_media(d,m)` row lacking intrinsic and closure provenance for viewer.
- output: search does not return media/fragment/annotation rows anchored to `m`.

---

## non-goals
- no ranking, weighting, or snippet algorithm changes.
- no `/search` envelope migration beyond existing `{ results, page }`.
- no conversation/highlight endpoint contract changes outside search alignment.
- no broad cross-module refactor of conversation/highlight services beyond search-owned behavior changes.

---

## constraints
- only touch files listed in deliverables unless this spec is revised.
- search visibility must align with section 5 predicates from `docs/v1/s4/s4_spec.md`.
- preserve typed masking codes and backward-compatible `/search` response shape.
- keep search visibility filtering in sql; do not add post-query python visibility loops.
- preserve pending-message exclusion from search results.
- do not perform cross-module helper retirement/refactors in this pr (owned by pr-09).

---

## boundaries (for ai implementers)

**do**:
- implement only search-alignment behavior owned by pr-08.
- reuse canonical visibility helpers; avoid ad-hoc duplicate auth logic.
- add tests for every behavior-changing decision.
- ensure scope-specific filters are layered on canonical base visibility, not replacing it.

**do not**:
- change unrelated search ranking/pagination behavior.
- modify non-search endpoints.
- introduce contract changes owned by other prs.
- silently change typed 404 error mapping for scope authorization.

---

## open questions + temporary defaults

| question | temporary default behavior | owner | due |
|---|---|---|---|
| none | n/a | n/a | n/a |

---

## checklist
- [x] every l3 acceptance bullet is in traceability matrix
- [x] every traceability row has at least one test
- [x] every behavior-changing decision has assertions
- [x] only scoped files are touched
- [x] non-goals are explicit and enforced
