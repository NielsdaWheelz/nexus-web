# pr-09: hardening + acceptance matrix + l4 handoff gate

## goal
prove the full s4 contract with deterministic audits and freeze final l4 handoff boundaries, without introducing new product behavior.

## context
- `docs/v1/s4/s4_roadmap.md` assigns pr-09 ownership for hardening, compatibility/helper audits, and handoff gate closure.
- `docs/v1/s4/s4_spec.md` sections 9-11 require strict invariants, scenarios 1-15 acceptance coverage, and canonical visibility helper centralization.
- merged tests already cover most scenario behavior across libraries/conversations/highlights/search, but proof is fragmented and not centralized as a release gate.
- merged code has split read/write helpers for conversations/highlights and canonical search scope auth, but there is no dedicated regression audit for helper-retirement drift.
- one blocking coverage gap remains for scenario 11 strict ordering proof under `scope=all`: current tests validate cursor stability but not explicit sort-key order assertions on mixed visibility rows.

## dependencies
- pr-01
- pr-02
- pr-03
- pr-04
- pr-05
- pr-06
- pr-07
- pr-08

---

## deliverables

### `docs/v1/s4/s4_prs/s4_pr09_acceptance_matrix.md` (new)
- add canonical scenario coverage matrix for s4 scenarios 1-15.
- required columns:
  - `scenario`
  - `contract summary`
  - `automated test(s)` (file + exact test name)
  - `status`
- every scenario row must map to at least one automated test.
- if any scenario needs a new test, add the test in this pr before marking matrix row complete.
- this file is the source of truth for the pr body traceability table.

### `docs/v1/s4/s4_prs/s4_pr09_handoff.md` (new)
- add short final handoff table for pr-01..pr-09 with columns:
  - `pr`
  - `critical files`
  - `contract invariants`
  - `acceptance tests`
  - `non-goals`
- include explicit `deferred churn` section:
  - list owner-pr reassignment items discovered during pr-09 audits.
  - if none, state `none` explicitly.
- no new behavior requirements may be introduced in this handoff note.

### `python/nexus/services/shares.py`
- close blocking invariant drift for legacy share service entry points:
  - `set_sharing_mode(...)`
  - `add_share(...)`
  - `set_shares(...)`
- enforce default-library target prohibition in these legacy paths too (not only route-owned owner APIs):
  - if target library is default, raise `ForbiddenError(E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN)`.
- keep remaining legacy error semantics unchanged unless required by this prohibition.
- this is a minimal blocking drift fix, not a new feature.

### `python/tests/test_shares.py`
- remove/replace legacy service tests that assume default-library share targets are valid.
- add service-layer invariant tests for legacy entry points:
  - `test_set_sharing_mode_default_library_forbidden`
  - `test_add_share_default_library_forbidden`
  - `test_set_shares_default_library_forbidden`
- keep existing route-level default-library prohibition coverage.

### `python/nexus/services/conversations.py`
- update module docstring/header comments to reflect merged s4 semantics:
  - shared read allowed by canonical visibility.
  - owner-only remains write boundary.
- no behavior changes in this file unless scenario-11 test exposes blocking drift.

### `python/nexus/services/highlights.py`
- update module docstring/header comments to reflect merged s4 semantics:
  - shared read allowed under canonical highlight visibility.
  - author-only remains write boundary.
- no behavior changes in this file.

### `python/tests/test_conversations.py`
- add one blocking-gap test for scenario 11 ordering contract on mixed visibility rows:
  - `test_list_conversations_scope_all_order_is_updated_at_desc_id_desc`
- required assertions:
  - query `GET /conversations?scope=all` returns rows ordered by `updated_at DESC, id DESC`.
  - tie-break on equal `updated_at` uses `id DESC` deterministically.
- deterministic setup requirements:
  - create at least three visible rows (`owned`, `shared`, `public`).
  - force controlled timestamps via direct sql update so at least two rows share identical `updated_at`.
  - set known conversation ids to assert exact tie-break ordering (`id DESC`) under equal timestamps.
- keep existing cursor-stability tests unchanged.
- do not change service or route behavior in this pr unless this test exposes blocking drift.

### `python/tests/test_s4_compatibility_audit.py` (new)
- add deterministic compatibility audit tests (static/introspection + lightweight runtime) for l3 contract:
  - `test_conversation_list_route_limit_contract_unchanged`
    - assert `/conversations` limit query contract remains default `50`, bounds `1..100`.
  - `test_message_list_route_limit_contract_unchanged`
    - assert `/conversations/{id}/messages` limit query contract remains default `50`, bounds `1..100`.
  - `test_conversation_service_limit_constants_unchanged`
    - assert `DEFAULT_LIMIT=50`, `MIN_LIMIT=1`, `MAX_LIMIT=100` in conversation service.
  - `test_conversation_out_required_fields_preserved`
    - assert base fields remain present and additive fields remain present (`owner_user_id`, `is_owner`).
  - `test_highlight_out_required_fields_preserved`
    - assert base fields remain present and additive fields remain present (`author_user_id`, `is_owner`).
- keep this module as audit-only; no db-heavy scenario setup.

### `python/tests/test_s4_helper_retirement_audit.py` (new)
- add deterministic helper-retirement regression tests:
  - `test_deprecated_visibility_helper_names_absent_from_python_code`
    - fail if `get_conversation_for_viewer_or_404` or `get_highlight_for_viewer_or_404` appears under `python/`.
  - `test_conversation_helper_split_surfaces_present`
    - require both `get_conversation_for_visible_read_or_404` and `get_conversation_for_owner_write_or_404` in `python/nexus/services/conversations.py`.
  - `test_highlight_helper_split_surfaces_present`
    - require both `get_highlight_for_visible_read_or_404` and `get_highlight_for_author_write_or_404` in `python/nexus/services/highlights.py`.
  - `test_search_read_scope_does_not_depend_on_owner_write_helpers`
    - fail if search service imports/uses owner-write helper names; require `can_read_conversation` scope gate.
- static-source checks only; do not add runtime behavior changes in this audit module.

### `docs/v1/s4/s4_roadmap.md`
- keep pr-09 drift triage policy authoritative and in sync with implementation:
  - blocking drift: minimal patch allowed in pr-09.
  - non-blocking feature churn: reassigned to owner prs with explicit roadmap pointer updates.
- if pr-09 discovers new owner-pr churn, update the owning pr entry in roadmap (not pr-09 acceptance) and record in `s4_pr09_handoff.md`.

---

## decision ledger

| question | decision | rationale | fallback/default |
|---|---|---|---|
| should pr-09 add new product behavior while hardening? | no. pr-09 is audit/hardening-only; behavior changes are allowed only as minimal blocking fixes required to satisfy acceptance/compatibility/helper audits. | preserves l3 ownership boundaries and avoids scope smuggling in end-of-slice consolidation work. | if a fix expands product behavior or contract surface, stop and reassign to owner pr docs first. |
| where should scenario 1-15 proof live? | in a committed matrix file (`s4_pr09_acceptance_matrix.md`) that is mirrored into pr description. | keeps traceability durable in-repo and reviewable after pr body edits are lost. | if matrix and tests diverge, tests are source of truth and matrix must be updated before merge. |
| how to handle scenario 11 coverage gap? | add one minimal test in `test_conversations.py` asserting exact `scope=all` ordering keys and tie-break. | this is blocking acceptance drift, not feature work; test-level hardening is correct pr-09 scope. | if test reveals behavior bug, apply smallest behavior patch needed and document in drift section. |
| should compatibility audit rely only on integration tests? | no. use deterministic introspection/static tests for route limits + schema fields, and retain runtime `/search` shape test as compatibility proof. | gives stable signals and avoids flaky E2E-only gating. | if introspection proves brittle, replace with direct route metadata assertions without changing behavior scope. |
| how to prove helper retirement with low churn? | enforce source-level audit tests for deprecated helper absence + required split-helper presence + search read-path helper use. | catches regression cheaply without refactoring runtime code again. | if false positives occur, tighten matcher to AST/token-level checks, not broader regex relaxations. |
| where to capture feature-level churn found during audits? | not in pr-09 implementation scope; record in `s4_pr09_handoff.md` and patch owner pr roadmap entry. | keeps ownership and accountability aligned with original slice decomposition. | if owner pr is already merged, document as follow-up pr with explicit owner and dependency pointer. |
| legacy share service functions still allow default-library targets, violating s4 invariant outside route-owned path. should pr-09 touch this? | yes. treat as blocking drift and patch legacy service entry points to enforce `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`. | invariant compliance must hold across all remaining callable service paths, not only one transport surface. | if patch scope expands beyond prohibition guard, stop and re-scope; keep minimal invariant closure only. |
| stale module docstrings in conversation/highlight services still claim pre-s4 owner-only semantics. | update module docstrings/comments in pr-09 as behavior-neutral hardening. | stale docs create implementation mistakes during handoff and future maintenance. | if wording is disputed, prefer exact l2 invariant language and avoid behavioral reinterpretation. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| s4 scenarios 1-15 are each mapped to at least one automated test, with traceability table in pr description. | `docs/v1/s4/s4_prs/s4_pr09_acceptance_matrix.md`; `python/tests/test_conversations.py` (gap fix only if needed) | matrix references existing tests + `test_list_conversations_scope_all_order_is_updated_at_desc_id_desc` |
| route structure constraints still pass (`python/tests/test_route_structure.py`). | no route-code changes; audit run captured in pr evidence | `python/tests/test_route_structure.py` |
| compatibility audit confirms list limits/search shape/additive-only evolution. | `python/tests/test_s4_compatibility_audit.py`; matrix row references existing search shape test | `test_conversation_list_route_limit_contract_unchanged`; `test_message_list_route_limit_contract_unchanged`; `test_conversation_service_limit_constants_unchanged`; `test_conversation_out_required_fields_preserved`; `test_highlight_out_required_fields_preserved`; `python/tests/test_search.py::test_search_response_shape_remains_results_page` |
| helper retirement audit confirms no stale duplicate visibility helpers remain. | `python/tests/test_s4_helper_retirement_audit.py` | `test_deprecated_visibility_helper_names_absent_from_python_code`; `test_conversation_helper_split_surfaces_present`; `test_highlight_helper_split_surfaces_present`; `test_search_read_scope_does_not_depend_on_owner_write_helpers` |
| default-library conversation-share prohibition holds across remaining legacy service entry points (blocking drift closure). | `python/nexus/services/shares.py`; `python/tests/test_shares.py` | `test_set_sharing_mode_default_library_forbidden`; `test_add_share_default_library_forbidden`; `test_set_shares_default_library_forbidden`; existing route-level `test_put_conversation_shares_default_library_forbidden` |
| drift triage is explicit and enforced (blocking drift fixed minimally; feature churn reassigned). | `docs/v1/s4/s4_roadmap.md`; `docs/v1/s4/s4_prs/s4_pr09_handoff.md` | automated: audit suites above; process gate: `s4_pr09_handoff.md` deferred-churn section and owner-pr roadmap pointer updates when churn exists |
| short handoff note lists final l4 inputs per pr. | `docs/v1/s4/s4_prs/s4_pr09_handoff.md` | doc review gate in pr checklist |

---

## acceptance tests

### file: `python/tests/test_conversations.py`

**test: `test_list_conversations_scope_all_order_is_updated_at_desc_id_desc`**
- input: mixed visible set for viewer (`owned`, `shared`, `public`) with controlled `updated_at` values including ties.
- output:
  - response order is strictly `updated_at DESC, id DESC`.
  - no deviations for tied timestamps.
  - tied rows follow exact `id DESC` ordering from known seeded ids.

### file: `python/tests/test_shares.py`

**test: `test_set_sharing_mode_default_library_forbidden`**
- input: call legacy `set_sharing_mode(..., sharing='library', library_ids=[default_library_id])`.
- output: fails with `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`.

**test: `test_add_share_default_library_forbidden`**
- input: conversation in shareable mode; call legacy `add_share(..., default_library_id)`.
- output: fails with `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`.

**test: `test_set_shares_default_library_forbidden`**
- input: call legacy `set_shares(..., [default_library_id])`.
- output: fails with `E_CONVERSATION_SHARE_DEFAULT_LIBRARY_FORBIDDEN`.

### file: `python/tests/test_s4_compatibility_audit.py`

**test: `test_conversation_list_route_limit_contract_unchanged`**
- input: introspect `/conversations` route signature/query metadata.
- output: default `50`, bounds `1..100`.

**test: `test_message_list_route_limit_contract_unchanged`**
- input: introspect `/conversations/{id}/messages` route signature/query metadata.
- output: default `50`, bounds `1..100`.

**test: `test_conversation_service_limit_constants_unchanged`**
- input: inspect conversation service constants.
- output: `DEFAULT_LIMIT=50`, `MIN_LIMIT=1`, `MAX_LIMIT=100`.

**test: `test_conversation_out_required_fields_preserved`**
- input: inspect `ConversationOut` schema field set.
- output: base fields preserved and additive fields present (`owner_user_id`, `is_owner`).

**test: `test_highlight_out_required_fields_preserved`**
- input: inspect `HighlightOut` schema field set.
- output: base fields preserved and additive fields present (`author_user_id`, `is_owner`).

### file: `python/tests/test_s4_helper_retirement_audit.py`

**test: `test_deprecated_visibility_helper_names_absent_from_python_code`**
- input: scan `python/` source files for deprecated helper symbols.
- output: no hits for `get_conversation_for_viewer_or_404` and `get_highlight_for_viewer_or_404`.

**test: `test_conversation_helper_split_surfaces_present`**
- input: inspect `python/nexus/services/conversations.py` symbols/source.
- output: both split helper names are present.

**test: `test_highlight_helper_split_surfaces_present`**
- input: inspect `python/nexus/services/highlights.py` symbols/source.
- output: both split helper names are present.

**test: `test_search_read_scope_does_not_depend_on_owner_write_helpers`**
- input: inspect `python/nexus/services/search.py` source/imports.
- output: search read-scope auth depends on `can_read_conversation`, not owner-write helper symbols.

### file: `python/tests/test_route_structure.py`

**test module smoke**
- input: run full route-structure suite unchanged.
- output: all route-structure constraints pass.

### file: `python/tests/test_search.py`

**test: `test_search_response_shape_remains_results_page`**
- input: successful `GET /search` request.
- output: response shape remains top-level `{ results, page }`.

---

## non-goals
- does not add new endpoints, scopes, or product behavior.
- does not refactor conversation/highlight/search services beyond minimal blocking drift fixes required by audit failures and behavior-neutral docstring correction.
- does not rebalance pr ownership; feature-level changes remain owned by original prs.

---

## constraints
- only touch files listed in deliverables unless this spec is revised.
- keep pr-09 behavior-neutral except minimal blocking drift discovered by acceptance/compatibility/helper audits.
- if a discovered issue requires feature-level behavior change, reassign to owner pr docs and update roadmap entry before implementation.

---

## boundaries (for ai implementers)

**do**:
- implement deterministic audit artifacts and missing blocking test coverage.
- keep drift fixes minimal, local, and explicitly tied to failed acceptance checks.
- update handoff note and matrix as first-class deliverables.

**do not**:
- add opportunistic refactors, api changes, or schema changes.
- absorb owner-pr feature churn into pr-09.
- claim coverage in matrix without an exact automated test reference.

---

## open questions + temporary defaults

| question | temporary default behavior | owner | due |
|---|---|---|---|
| none | n/a | n/a | n/a |

---

## checklist
- [x] every l3 acceptance bullet is in traceability matrix
- [x] every traceability row has at least one test
- [x] every behavior-changing decision has assertions
- [x] only scoped files are touched
- [x] non-goals are explicit and enforced
