# s4 pr-08 decisions

## status
working ledger for behavior decisions required by `s4_pr08.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | `scope=conversation:*` auth currently depends on owner-write helper, which conflicts with shared-read search contract. | replace owner-write helper scope gate with `can_read_conversation(...)`; unauthorized/missing must map to masked `404 E_CONVERSATION_NOT_FOUND`. | keep owner-write helper for scope auth; broaden to generic `E_NOT_FOUND`. | search scope auth now matches conversation read contract (`owner/public/library-share dual-membership`). | add tests proving shared non-owner conversation scope succeeds and unauthorized scope preserves `E_CONVERSATION_NOT_FOUND`. | pr-08 implementer | if helper wiring changes, preserve the same status/code contract tests. | locked |
| d-002 | annotation search is still owner-only, so it diverges from pr-07 highlight visibility. | replace owner-only clause with s4 highlight visibility predicate in sql: media must be visible under canonical provenance and viewer/author must share a containing-library intersection for anchor media. | keep owner-only annotation search; run post-query python checks; perform per-row `can_read_highlight(...)` calls. | search annotation visibility is aligned with highlight read semantics and strict revocation behavior. | add visibility and revocation tests for shared annotations. | pr-08 implementer | if helper extraction is deferred, enforce exact semantic parity through matrix tests in this pr. | locked |
| d-003 | `scope=library:*` message search is currently disabled and must be constrained correctly when enabled. | include messages only when conversation is actively library-shared to target library (`sharing='library'` + target share row) and still passes canonical conversation visibility; exclude visible conversations not shared to target library. | keep returning empty for library scope; include all visible conversations regardless of target share; ignore conversation sharing state and rely on share rows alone. | library-scoped message search becomes useful without widening scope beyond target-library share boundary. | add positive/negative tests for target-shared vs shared-to-other-library vs visible-but-unshared conversations, plus sharing-state guard test. | pr-08 implementer | if edge cases appear, keep strict target-share + sharing-state requirement and adjust tests/docs before widening. | locked |
| d-004 | search visible-media cte uses membership-only semantics and can diverge from s4 provenance auth. | upgrade visible-media cte to canonical s4 provenance paths (non-default membership, intrinsic default, closure default + active source membership). | leave existing membership-only cte; patch only conversation/annotation scope behavior. | search media/fragment/annotation paths stop overexposing stale default-library rows. | add regression test for stale default-library `library_media` without intrinsic/closure. | pr-08 implementer | if full refactor blocks merge, do not ship without equivalent provenance semantics and tests. | locked |
| d-005 | full cross-module helper dedupe in pr-08 can increase risk/coupling while behavior is still being corrected. | keep pr-08 behavior-focused: enforce semantic parity + drift-detecting tests now; defer structural helper retirement/dedupe to pr-09. | force broad helper refactor across non-search modules in this pr; defer behavior fixes to later. | keeps pr-08 focused on behavioral correctness while preserving slice-end cleanup path. | tests become release gate for parity until structural dedupe lands. | slice owner + pr-08 implementer | if parity cannot be achieved cleanly within pr-08 scoped files, stop and revise spec before widening scope. | locked |
| d-006 | scope-typed masking could regress when switching auth helper paths. | preserve exact typed 404 mapping: `media|library -> E_NOT_FOUND`, `conversation -> E_CONVERSATION_NOT_FOUND`. | normalize all scope failures to one error code/status. | prevents contract regressions for existing callers and auditing logic. | add explicit multi-scope masking test in `test_search.py`. | pr-08 implementer | any internal refactor must keep the same status/code assertions green. | locked |
| d-007 | response-shape drift risk while changing search internals. | keep `/search` response shape exactly `{ results, page }`; no envelope migration in s4 pr-08. | introduce envelope or rename `results/page` fields during alignment work. | preserves additive-compatibility requirement from l2/l3. | add explicit response-shape regression assertion. | pr-08 implementer | any shape migration requires a separate versioned contract. | locked |
