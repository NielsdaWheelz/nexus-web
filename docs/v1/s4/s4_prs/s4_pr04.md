# pr-04: invitation lifecycle

## goal
implement user-id invite lifecycle endpoints with atomic accept semantics and strict invite state transitions.

## context
- `docs/v1/s4/s4_spec.md` defines invite contracts, strict revocation, and default-library invite prohibition.
- `docs/v1/s4/s4_roadmap.md` assigns invite lifecycle to pr-04 and closure materialization worker to pr-05.
- `python/nexus/services/libraries.py` currently owns library-domain service logic and is the expected invite lifecycle implementation surface.
- `python/nexus/api/routes/libraries.py` is the public library route module to extend for invite endpoints.
- `apps/web/src/app/api/libraries/**` is the bff proxy surface that must stay route-parity aligned with backend public endpoints.

## dependencies
- pr-01
- pr-03

---

## deliverables

### `python/nexus/schemas/library.py`
- add invite request schemas:
  - `CreateLibraryInviteRequest`
    - `invitee_user_id: UUID`
    - `role: LibraryRole`
- add invite action response schemas (used by accept/decline endpoints):
  - `InviteAcceptMembershipOut`
    - `library_id: UUID`
    - `user_id: UUID`
    - `role: LibraryRole`
  - `AcceptLibraryInviteResponse`
    - `invite: LibraryInvitationOut`
    - `membership: InviteAcceptMembershipOut`
    - `idempotent: bool`
    - `backfill_job_status: str` (`pending` for pr-04)
  - `DeclineLibraryInviteResponse`
    - `invite: LibraryInvitationOut`
    - `idempotent: bool`
- keep `LibraryInvitationOut` unchanged (already present from pr-01).
- update module `__all__` to export all new invite request/response schemas.

### `python/nexus/schemas/__init__.py`
- re-export all new invite request/response schemas added in `schemas/library.py`:
  - `CreateLibraryInviteRequest`
  - `AcceptLibraryInviteResponse`
  - `DeclineLibraryInviteResponse`
  - `InviteAcceptMembershipOut`

### `python/nexus/services/libraries.py`
- keep invitation domain logic in this module (do not create a new service file in pr-04).
- add invite service functions for the six endpoint contracts:
  - `create_library_invite(db: Session, viewer_id: UUID, library_id: UUID, invitee_user_id: UUID, role: LibraryRole) -> LibraryInvitationOut`
  - `list_library_invites(db: Session, viewer_id: UUID, library_id: UUID, status: LibraryInvitationStatusValue = "pending", limit: int = 100) -> list[LibraryInvitationOut]`
  - `list_viewer_invites(db: Session, viewer_id: UUID, status: LibraryInvitationStatusValue = "pending", limit: int = 100) -> list[LibraryInvitationOut]`
  - `accept_library_invite(db: Session, viewer_id: UUID, invite_id: UUID) -> AcceptLibraryInviteResponse`
  - `decline_library_invite(db: Session, viewer_id: UUID, invite_id: UUID) -> DeclineLibraryInviteResponse`
  - `revoke_library_invite(db: Session, viewer_id: UUID, invite_id: UUID) -> None`
- endpoint-surface contract for this cluster:
  - all list functions clamp `limit` to `200` and reject non-positive using existing invalid-request path.
  - both list functions order by `created_at DESC, id DESC`.
  - invite status filters are exact (`pending|accepted|declined|revoked`) with default `pending`.
- create invite (`create_library_invite`) semantics:
  - auth:
    - viewer must be member of target library; non-member is masked `404 E_LIBRARY_NOT_FOUND`.
    - viewer must be admin/owner role; non-admin member gets `403 E_FORBIDDEN`.
  - default target guard: `libraries.is_default=true` is forbidden with `403 E_DEFAULT_LIBRARY_FORBIDDEN`.
  - invitee lookup is user-id only:
    - `SELECT 1 FROM users WHERE id = :invitee_user_id` required.
    - missing user returns `404 E_USER_NOT_FOUND`.
  - duplicate/member guards:
    - existing membership `(library_id, invitee_user_id)` -> `409 E_INVITE_MEMBER_EXISTS`.
    - existing pending invite for `(library_id, invitee_user_id)` -> `409 E_INVITE_ALREADY_EXISTS`.
    - self-invite resolves through the same membership guard path (`409 E_INVITE_MEMBER_EXISTS`), not a raw database constraint leak.
  - concurrency/race handling:
    - catch unique-index race on `uix_library_invitations_pending_once` and map to `409 E_INVITE_ALREADY_EXISTS`.
    - do not remap unknown integrity errors; surface as internal error.
  - insert pending invite row and return `LibraryInvitationOut`.
- list invite semantics:
  - `list_library_invites` is admin-only for target library (masked `404` for non-member, `403` for non-admin member).
  - `list_viewer_invites` returns rows where `invitee_user_id = viewer_id` only.
  - both support optional status filter default `pending`.
- accept semantics (`accept_library_invite`) are transactional and ordered exactly:
  1. lock invite row by id and invitee (`FOR UPDATE`), else masked `404 E_INVITE_NOT_FOUND`.
  2. if status is `accepted`, return `200` idempotent no-op (no state mutation).
  3. if status is not `pending`, return `409 E_INVITE_NOT_PENDING`.
  4. load target library and enforce non-default (`403 E_DEFAULT_LIBRARY_FORBIDDEN` as defensive guard).
  5. membership upsert using `ON CONFLICT DO NOTHING` for `(library_id, viewer_id)` with invite role.
  6. update invite row to `accepted` with `responded_at=now()`.
  7. upsert `default_library_backfill_jobs(default_library_id, source_library_id, user_id)`:
     - set `status='pending'`, `attempts=0`, `last_error_code=NULL`, `updated_at=now()`, `finished_at=NULL`.
  8. commit transaction.
  9. post-commit best-effort enqueue hook (non-fatal; durable job row is authoritative).
- decline semantics (`decline_library_invite`):
  - lock invite row by id + invitee (`FOR UPDATE`) else masked `404 E_INVITE_NOT_FOUND`.
  - `pending -> declined` with `responded_at=now()`.
  - `declined -> declined` returns `200` idempotent no-op.
  - `accepted|revoked -> 409 E_INVITE_NOT_PENDING`.
- revoke semantics (`revoke_library_invite`):
  - visibility/auth:
    - invite missing -> `404 E_INVITE_NOT_FOUND`.
    - caller not member of invite library -> masked `404 E_INVITE_NOT_FOUND`.
    - caller member but non-admin -> `403 E_FORBIDDEN`.
  - transitions:
    - `pending -> revoked` returns `204`.
    - `revoked -> revoked` returns `204` idempotent no-op.
    - `accepted|declined -> 409 E_INVITE_NOT_PENDING`.
- enqueue contract in pr-04:
  - add internal helper in `libraries.py`:
    - `_enqueue_default_library_backfill_job(default_library_id: UUID, source_library_id: UUID, user_id: UUID, request_id: str | None = None) -> bool`
    - helper is logging-only for failures and returns dispatch status.
  - enqueue is best-effort and must never fail endpoint success path.
  - if worker task is unavailable (pre-pr-05), keep accept response successful with durable backfill row persisted.

### `python/nexus/api/routes/libraries.py`
- import and use new invite schemas for request/response bodies.
- add routes for all required invite endpoints:
  - `POST /libraries/{library_id}/invites` (`201`)
  - `GET /libraries/{library_id}/invites`
  - `GET /libraries/invites`
  - `POST /libraries/invites/{invite_id}/accept`
  - `POST /libraries/invites/{invite_id}/decline`
  - `DELETE /libraries/invites/{invite_id}` (`204`)
- route discipline:
  - transport-only: one service call per route; envelope via `success_response(...)`.
  - query params:
    - `status` uses existing `LibraryInvitationStatusValue` enum and defaults to `pending`.
    - `limit` defaults to `100`, `ge=1`, service clamp `<=200`.
- critical path-ordering constraint:
  - register static `/libraries/invites` routes before dynamic `/libraries/{library_id}` routes to avoid UUID-path capture and invalid-request leakage.

### `apps/web/src/app/api/libraries/**`
- add next.js bff proxy routes mirroring new public invite endpoints:
  - `apps/web/src/app/api/libraries/[id]/invites/route.ts`
    - `POST`, `GET`
  - `apps/web/src/app/api/libraries/invites/route.ts`
    - `GET`
  - `apps/web/src/app/api/libraries/invites/[inviteId]/accept/route.ts`
    - `POST`
  - `apps/web/src/app/api/libraries/invites/[inviteId]/decline/route.ts`
    - `POST`
  - `apps/web/src/app/api/libraries/invites/[inviteId]/route.ts`
    - `DELETE`
- each route must keep existing bff pattern:
  - `runtime = "nodejs"`
  - direct `proxyToFastAPI(...)` passthrough
  - no domain/auth logic in next.js layer
- add bff route unit test file:
  - `apps/web/src/app/api/libraries/invites-routes.test.ts`
  - verifies each invite route handler calls `proxyToFastAPI(...)` with the expected upstream path and method.

### `python/tests/test_libraries.py`
- add invite endpoint coverage section with separate classes:
  - `TestLibraryInviteCreateList`
  - `TestLibraryInviteAccept`
  - `TestLibraryInviteDecline`
  - `TestLibraryInviteRevoke`
- endpoint-surface tests required for this cluster:
  - each new invite endpoint has at least one happy-path assertion and one auth/masking assertion.
  - route-level response status codes are pinned (`201`, `200`, `204` per contract).
  - list endpoints assert deterministic order (`created_at DESC, id DESC`) and `limit` behavior.
- transition/idempotency/error-matrix tests required:
  - create/list:
    - `test_create_invite_default_library_forbidden`
    - `test_create_invite_user_not_found`
    - `test_create_invite_member_exists_conflict`
    - `test_create_invite_self_conflicts_as_member_exists`
    - `test_create_invite_pending_duplicate_conflict`
    - `test_list_library_invites_status_filter_default_pending`
    - `test_list_viewer_invites_status_filter_and_order`
  - accept:
    - `test_accept_invite_transaction_creates_membership_updates_invite_and_upserts_backfill_job`
    - `test_accept_invite_grants_immediate_media_access_before_backfill_worker`
    - `test_accept_invite_idempotent_when_already_accepted`
    - `test_accept_invite_non_pending_returns_invite_not_pending`
    - `test_accept_invite_default_library_forbidden_defense`
  - decline:
    - `test_decline_invite_pending_to_declined`
    - `test_decline_invite_idempotent_when_already_declined`
    - `test_decline_invite_non_pending_returns_invite_not_pending`
  - revoke:
    - `test_revoke_invite_pending_to_revoked`
    - `test_revoke_invite_idempotent_when_already_revoked`
    - `test_revoke_invite_non_pending_returns_invite_not_pending`
    - `test_revoke_invite_non_member_masked_not_found`
- add error-masking assertions explicitly:
  - unknown invite id for accept/decline/revoke returns `404 E_INVITE_NOT_FOUND`.
  - non-member access on library-admin invite routes returns masked `404`.

---

## decision ledger

| question | decision | rationale | fallback/default |
|---|---|---|---|
| should invite logic live in a new service module or stay in `libraries.py`? | keep invite logic in `python/nexus/services/libraries.py` for pr-04. | minimizes churn and avoids splitting tightly-coupled library auth predicates across files mid-slice. | if file complexity becomes unmanageable during implementation, extract to `services/library_invites.py` in a dedicated follow-up refactor pr, not in-pr opportunistically. |
| how do we avoid path collision between `/libraries/invites` and `/libraries/{library_id}`? | static invite routes are registered before dynamic `{library_id}` routes. | prevents accidental UUID parse failures/422 leakage on `/libraries/invites`. | if router ordering changes later, add explicit route test asserting `/libraries/invites` resolves correctly. |
| should bff add any invite-domain logic? | no; proxy-only parity routes. | existing bff contract is transport passthrough and keeps auth/authorization in fastapi service layer. | if frontend needs derived invite state later, add separate ui adapter code outside api route handlers. |
| should accept-retry on an already accepted invite recreate membership if membership was later removed? | no. accepted-retry is a strict no-op (`idempotent=true`) and does not reinsert membership. | preserves state-machine semantics (`accepted` is terminal) and avoids accidental re-grant after explicit revocation/removal. | access must be restored via new invite, not terminal-state replay. |
| should backfill enqueue failure fail invite accept? | no. durable job upsert is authoritative; enqueue is best-effort post-commit. | keeps accept path reliable even when worker/task-dispatch is unavailable pre-pr-05 or transiently failing. | operator/worker will process pending jobs later; pr-05 requeue path handles recovery. |
| should create-invite rely only on unique index exceptions for duplicates? | no. perform explicit member check first; treat pending-duplicate as conflict and map unique-index race to same code. | gives deterministic user-facing errors and remains concurrency-safe. | on unexpected integrity error, raise internal error rather than silently remapping unknown constraints. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| implement endpoints: `POST /libraries/{library_id}/invites`; `GET /libraries/{library_id}/invites`; `GET /libraries/invites`; `POST /libraries/invites/{invite_id}/accept`; `POST /libraries/invites/{invite_id}/decline`; `DELETE /libraries/invites/{invite_id}` | `python/nexus/schemas/library.py`; `python/nexus/schemas/__init__.py`; `python/nexus/services/libraries.py`; `python/nexus/api/routes/libraries.py`; `apps/web/src/app/api/libraries/[id]/invites/route.ts`; `apps/web/src/app/api/libraries/invites/route.ts`; `apps/web/src/app/api/libraries/invites/[inviteId]/accept/route.ts`; `apps/web/src/app/api/libraries/invites/[inviteId]/decline/route.ts`; `apps/web/src/app/api/libraries/invites/[inviteId]/route.ts`; `python/tests/test_libraries.py` | `test_create_invite_success_returns_201`; `test_create_invite_non_admin_forbidden`; `test_create_invite_non_member_masked_not_found`; `test_list_library_invites_success_sorted_desc`; `test_list_library_invites_non_member_masked_not_found`; `test_list_viewer_invites_success`; `test_accept_invite_happy_path_returns_200`; `test_accept_invite_masked_not_found_for_non_invitee`; `test_decline_invite_happy_path_returns_200`; `test_revoke_invite_happy_path_returns_204`; `test_revoke_invite_non_admin_forbidden` |
| accept flow transactionally performs invite lock + state check + membership upsert + invite update + backfill-job upsert. | `python/nexus/services/libraries.py`; `python/nexus/schemas/library.py`; `python/nexus/api/routes/libraries.py`; `python/tests/test_libraries.py` | `test_accept_invite_transaction_creates_membership_updates_invite_and_upserts_backfill_job`; `test_accept_invite_grants_immediate_media_access_before_backfill_worker`; `test_accept_invite_membership_upsert_is_no_duplicate`; `test_accept_invite_non_pending_returns_invite_not_pending` |
| idempotent semantics for accept/decline/revoke match spec. | `python/nexus/services/libraries.py`; `python/nexus/api/routes/libraries.py`; `python/tests/test_libraries.py` | `test_accept_invite_idempotent_when_already_accepted`; `test_decline_invite_idempotent_when_already_declined`; `test_revoke_invite_idempotent_when_already_revoked` |
| default-library invite target forbidden. | `python/nexus/services/libraries.py`; `python/nexus/api/routes/libraries.py`; `python/tests/test_libraries.py` | `test_create_invite_default_library_forbidden`; `test_accept_invite_default_library_forbidden_defense` |
| invitee lookup is user-id only with `404 E_USER_NOT_FOUND`. | `python/nexus/services/libraries.py`; `python/nexus/api/routes/libraries.py`; `python/tests/test_libraries.py` | `test_create_invite_user_not_found` |
| add matching next.js bff proxy routes for invite endpoints. | `apps/web/src/app/api/libraries/[id]/invites/route.ts`; `apps/web/src/app/api/libraries/invites/route.ts`; `apps/web/src/app/api/libraries/invites/[inviteId]/accept/route.ts`; `apps/web/src/app/api/libraries/invites/[inviteId]/decline/route.ts`; `apps/web/src/app/api/libraries/invites/[inviteId]/route.ts`; `apps/web/src/app/api/libraries/invites-routes.test.ts` | `it('proxies invite routes to expected fastapi paths')` |
| new integration tests (or extension of `python/tests/test_libraries.py`) cover invite transitions and error masking. | `python/tests/test_libraries.py` | `test_create_invite_non_member_masked_not_found`; `test_accept_invite_masked_not_found_for_non_invitee`; `test_decline_invite_unknown_masked_not_found`; `test_revoke_invite_non_member_masked_not_found`; `test_revoke_invite_non_pending_returns_invite_not_pending`; `test_create_invite_pending_duplicate_conflict`; `test_create_invite_self_conflicts_as_member_exists` |

---

## acceptance tests

### file: `python/tests/test_libraries.py`

**test: `test_create_invite_success_returns_201`**
- input: owner/admin calls `POST /libraries/{library_id}/invites` with existing non-member `invitee_user_id` and valid role.
- output: `201`; response contains `LibraryInvitationOut` with `status='pending'` and `responded_at=null`.

**test: `test_list_library_invites_success_sorted_desc`**
- input: create multiple invites at distinct timestamps; call `GET /libraries/{library_id}/invites`.
- output: `200`; all rows belong to library and are ordered `created_at DESC, id DESC`.

**test: `test_list_viewer_invites_success`**
- input: viewer is invitee on multiple libraries; call `GET /libraries/invites?status=pending`.
- output: `200`; returned invites are filtered to `invitee_user_id == viewer_id`.

**test: `test_accept_invite_happy_path_returns_200`**
- input: invitee calls `POST /libraries/invites/{invite_id}/accept` for pending invite.
- output: `200`; response shape includes `invite`, `membership`, `idempotent`, `backfill_job_status`.

**test: `test_decline_invite_happy_path_returns_200`**
- input: invitee calls `POST /libraries/invites/{invite_id}/decline` for pending invite.
- output: `200`; response shape includes `invite` and `idempotent`.

**test: `test_revoke_invite_happy_path_returns_204`**
- input: admin/owner calls `DELETE /libraries/invites/{invite_id}` for pending invite.
- output: `204` empty response.

**test: `test_accept_invite_masked_not_found_for_non_invitee`**
- input: non-invitee calls `POST /libraries/invites/{invite_id}/accept`.
- output: `404 E_INVITE_NOT_FOUND` (masked).

**test: `test_revoke_invite_non_admin_forbidden`**
- input: non-admin member calls `DELETE /libraries/invites/{invite_id}`.
- output: `403 E_FORBIDDEN`.

**test: `test_create_invite_non_member_masked_not_found`**
- input: non-member caller invokes `POST /libraries/{library_id}/invites` on an existing library.
- output: `404 E_LIBRARY_NOT_FOUND` (masked).

**test: `test_accept_invite_transaction_creates_membership_updates_invite_and_upserts_backfill_job`**
- input: pending invite for viewer into non-default library with existing media; viewer calls accept endpoint.
- output:
  - `200`
  - invite status becomes `accepted` with non-null `responded_at`
  - membership row exists for `(library_id, viewer_id)`
  - `default_library_backfill_jobs` row exists for `(default_library_id, source_library_id, viewer_id)` with `status='pending'`

**test: `test_accept_invite_membership_upsert_is_no_duplicate`**
- input: membership for invitee is pre-created before accept; invitee then accepts pending invite.
- output: `200`; membership cardinality for `(library_id, invitee_user_id)` remains `1` and no duplicate rows are created.

**test: `test_accept_invite_grants_immediate_media_access_before_backfill_worker`**
- input: source non-default library has media; invitee accepts pending invite; no backfill worker task is executed.
- output: invitee can immediately read/list source-library media after accept commit.

**test: `test_accept_invite_idempotent_when_already_accepted`**
- input: same invite accepted once, then accept retried by same invitee.
- output: second call `200` with `idempotent=true`; membership row count remains 1.

**test: `test_decline_invite_idempotent_when_already_declined`**
- input: invitee declines pending invite, then retries decline.
- output: second call `200` with `idempotent=true`; invite remains `declined`.

**test: `test_revoke_invite_idempotent_when_already_revoked`**
- input: admin revokes pending invite, then retries revoke.
- output: second call `204`; invite remains `revoked`.

**test: `test_accept_invite_non_pending_returns_invite_not_pending`**
- input: invite already `declined` or `revoked`; invitee calls accept.
- output: `409 E_INVITE_NOT_PENDING`.

**test: `test_decline_invite_non_pending_returns_invite_not_pending`**
- input: invite already `accepted` or `revoked`; invitee calls decline.
- output: `409 E_INVITE_NOT_PENDING`.

**test: `test_revoke_invite_non_pending_returns_invite_not_pending`**
- input: invite already `accepted` or `declined`; admin calls revoke.
- output: `409 E_INVITE_NOT_PENDING`.

**test: `test_create_invite_default_library_forbidden`**
- input: admin attempts to create invite on default library id.
- output: `403 E_DEFAULT_LIBRARY_FORBIDDEN`.

**test: `test_accept_invite_default_library_forbidden_defense`**
- input: invite row targeting default library exists (fixture inserted directly); invitee calls accept.
- output: `403 E_DEFAULT_LIBRARY_FORBIDDEN`.

**test: `test_create_invite_user_not_found`**
- input: admin calls create invite with non-existent `invitee_user_id`.
- output: `404 E_USER_NOT_FOUND`.

**test: `test_create_invite_self_conflicts_as_member_exists`**
- input: admin/owner calls create invite with `invitee_user_id == viewer_id`.
- output: `409 E_INVITE_MEMBER_EXISTS`.

**test: `test_decline_invite_unknown_masked_not_found`**
- input: invitee calls decline with unknown or foreign invite id.
- output: `404 E_INVITE_NOT_FOUND`.

**test: `test_revoke_invite_non_member_masked_not_found`**
- input: non-member calls revoke on existing invite.
- output: `404 E_INVITE_NOT_FOUND`.

### file: `apps/web/src/app/api/libraries/invites-routes.test.ts`

**test: `it('proxies invite routes to expected fastapi paths')`**
- input: invoke each route handler (`[id]/invites`, `invites`, `invites/[inviteId]/accept`, `invites/[inviteId]/decline`, `invites/[inviteId]`) with mocked `proxyToFastAPI`.
- output: each handler forwards the exact expected upstream path and preserves the verb-specific handler mapping.

---

## non-goals
- does not implement closure materialization worker logic (owned by pr-05).
- does not expand invite model to email invites, links, or anonymous tokens.
- does not change non-invite library governance contracts owned by pr-03.

---

## constraints
- only touch files listed in deliverables unless spec is revised.
- follow established project patterns for routing/service/auth/tests.
- no contract changes outside this pr's ownership.

---

## boundaries (for ai implementers)

**do**:
- implement only listed invite lifecycle behaviors.
- preserve masked/not-found semantics and error contracts.
- add tests for every behavior-changing decision.

**do not**:
- implement features from future prs.
- rewrite unrelated modules.
- alter public contracts not owned by this pr.

---

## open questions + temporary defaults

none.

---

## checklist
- [ ] acceptance: endpoint `POST /libraries/{library_id}/invites`
- [ ] acceptance: endpoint `GET /libraries/{library_id}/invites`
- [ ] acceptance: endpoint `GET /libraries/invites`
- [ ] acceptance: endpoint `POST /libraries/invites/{invite_id}/accept`
- [ ] acceptance: endpoint `POST /libraries/invites/{invite_id}/decline`
- [ ] acceptance: endpoint `DELETE /libraries/invites/{invite_id}`
- [ ] acceptance: accept flow is transactional (`lock -> state check -> membership upsert -> invite update -> backfill-job upsert`)
- [ ] acceptance: idempotent semantics for accept/decline/revoke match l2
- [ ] acceptance: default-library invite target forbidden
- [ ] acceptance: invitee lookup is user-id only with `404 E_USER_NOT_FOUND`
- [ ] acceptance: matching next.js bff proxy routes for invite endpoints
- [ ] acceptance: integration coverage for invite transitions + error masking
- [ ] every traceability row has at least one planned test
- [ ] every behavior-changing decision is captured in decision ledger
- [ ] non-goals are explicit and enforced
