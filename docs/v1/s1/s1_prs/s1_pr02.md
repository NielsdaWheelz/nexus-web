# Nexus — L3 PR Spec: S1 PR-02 (X-Request-ID + Authorization Predicates)

## Goal

Introduce:
1) deterministic `X-Request-ID` generation + propagation across Next.js BFF → FastAPI → Celery, and
2) reusable authorization predicates for media/library visibility.

This PR must not change product behavior except:
- responses include `X-Request-ID`
- error responses include `request_id` in the body
- logging is structured JSON and includes `request_id`
- existing visibility checks are refactored to use a single predicate module (same semantics)

---

## Context

S0 already provides:
- FastAPI bootstrap with auth middleware (Supabase JWT verification + internal header enforcement)
- Next.js BFF helper `proxyToFastAPI()` that forwards bearer + internal header
- `GET /media/{id}` endpoint with inline visibility checks
- DB session helpers + test harness using **nested transactions with a single shared connection injected into the app dependency graph**
- Docker Compose with postgres + redis
- Worker scaffold + Celery placeholder
- ORM models: `User`, `Library`, `Membership`, `Media`, `Fragment`, `LibraryMedia`
- Membership roles stored as lowercase strings: `'admin'`, `'member'`

S1 PR-01 (merged before this PR) provides:
- S1 schema migration + enums + CI harness
- `.env.example` and `X-Nexus-Internal` header policy (required in all envs)

---

## Non-Goals

- No changes to auth, JWT verification, or internal header policy.
- No new endpoints.
- No business logic changes to visibility semantics.
- No OpenTelemetry / tracing system; only request-id correlation.
- No logging of request bodies or Authorization headers/tokens.

---

## Deliverables

### 1) `X-Request-ID` Middleware (FastAPI)

#### Requirements
- Header name: `X-Request-ID` (case-insensitive on input)
- If request includes a valid request id, preserve it (normalized to lowercase).
- Otherwise generate a UUID v4 string (lowercase, hyphenated).
- Echo final value on **every** response as `X-Request-ID`.
- Store value on request state for downstream use: `request.state.request_id`.

#### Validation Rules
A request id is considered valid if:
- Header length is ≤ 128 bytes (truncate/reject before regex evaluation to prevent DoS)
- it is a valid UUID string (any version), OR
- it matches regex: `^[A-Za-z0-9._-]{1,128}$`

**Normalization:** If valid UUID, normalize to lowercase hyphenated canonical form. Non-UUID strings are preserved as-is.

If invalid (or >128 bytes), silently replace with a newly generated UUID v4.

#### Middleware Ordering (Critical)

Request-ID middleware **must run outermost** (installed first in the middleware stack) so that:
- It wraps all other middleware including auth
- Auth failures still receive `X-Request-ID` in the response
- Every response, including 401/403/500, includes the header

In FastAPI terms: add request-id middleware **before** auth middleware in `app.add_middleware()` calls (middleware runs in reverse order of registration, so register request-id last to run first).

```python
# Correct order (request-id runs outermost)
app.add_middleware(AuthMiddleware)       # Runs second
app.add_middleware(RequestIDMiddleware)  # Runs first (outermost)
```

#### Additional Constraints
- Middleware must not depend on database access.
- Middleware must not read cookies or session state.

---

### 2) `X-Request-ID` Propagation (Next.js BFF)

Update `proxyToFastAPI()` such that:
- If inbound browser request includes `X-Request-ID`, forward it to FastAPI.
- If missing, generate UUID v4 and forward it.
- Never expose bearer tokens to the browser; proxy remains server-only.

#### Response Header Forwarding (Allowlist Only)

BFF must forward only a **safe allowlist** of response headers back to the browser:

**Allowed:**
- `X-Request-ID`
- `Content-Type`
- `Content-Length`

**Explicitly blocked (never forward):**
- `Authorization`
- `X-Nexus-Internal`
- `Set-Cookie`
- Any header starting with `X-Internal-`

This prevents leaking internal headers to the browser.

#### Unit Tests

File: `apps/web/src/lib/proxyToFastAPI.test.ts`
Runner: **vitest** (add to devDependencies if not present)

Tests must validate:
- Generation when missing
- Forwarding when present
- Response header allowlist is enforced (blocked headers not forwarded)
- Bearer token not included in response headers to browser

---

### 3) Celery Logging Convention

Establish a convention (no scheduling required in this PR):
- Celery task entrypoints accept `request_id: str | None = None`
- Celery logs include `request_id` if present.
- Provide a helper to set per-task logging context.

This PR does not need to enqueue tasks; only enable consistent logging for when tasks are invoked in later PRs and in eager-mode tests.

---

### 4) Structured Logging (FastAPI + Celery)

#### Logging Library Choice

Use **`structlog`** for all structured logging:
- Install: `structlog` (add to dependencies)
- Rationale: Industry standard, built-in JSON rendering, context injection

Alternative: `python-json-logger` is acceptable but structlog preferred.

#### FastAPI Request Logging

Emit **one access log entry per request** in the request-id middleware, **after** the response is produced:

```python
# In request-id middleware, after response
logger.info(
    "request_completed",
    request_id=request_id,
    user_id=str(request.state.viewer_user_id) if hasattr(request.state, 'viewer_user_id') else None,
    method=request.method,
    path=request.url.path,
    status_code=response.status_code,
    duration_ms=duration_ms,
)
```

**User ID source of truth:** Auth middleware must set `request.state.viewer_user_id: UUID | None`. Request-id middleware reads from there. If auth fails, `viewer_user_id` is None.

**Disable uvicorn default access logs** to prevent duplicate/conflicting log lines:

```python
# In uvicorn config
uvicorn.run(app, access_log=False, ...)
```

Or in production via CLI: `uvicorn ... --no-access-log`

#### Celery Logging
- Use JSON structured logs (same structlog setup).
- Minimum fields per task log entry:
  - `timestamp`
  - `level`
  - `message`
  - `request_id` (nullable)
  - `task_name`
  - `task_id` (from Celery)
  - optional: `media_id` if task concerns a media row

#### Prohibitions
- Never log Authorization headers, cookies, or JWTs.
- Never log request bodies by default.

---

### 5) Error Response Enhancement

Include `request_id` in the error response body for easy copy/paste in bug reports:

```json
{
  "data": null,
  "error": {
    "code": "E_MEDIA_NOT_FOUND",
    "message": "Media not found",
    "request_id": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

Update `error_response()` helper to accept and include `request_id`.

---

### 6) Authorization Predicates Module

Create a reusable predicate module used by endpoints and later slices.

#### File
`python/nexus/auth/permissions.py`

#### Function Signatures

All functions:
- accept an explicit SQLAlchemy `Session`
- return booleans / mappings only (no HTTP exceptions raised)
- must not leak existence: "not found" and "not visible" both return `False`

```python
from uuid import UUID
from sqlalchemy.orm import Session

def can_read_media(session: Session, viewer_user_id: UUID, media_id: UUID) -> bool:
    """
    True iff media_id appears in at least one library where viewer_user_id is a member.
    Role does not matter ('member' or 'admin' both count).

    Uses ORM models: LibraryMedia, Membership
    Joins: library_media.library_id = memberships.library_id
    Filter: memberships.user_id = viewer_user_id AND library_media.media_id = media_id

    Returns False if media_id does not exist (no existence leak).
    """

def can_read_media_bulk(
    session: Session,
    viewer_user_id: UUID,
    media_ids: list[UUID],
) -> dict[UUID, bool]:
    """
    Returns a dict containing ALL input ids as keys.
    For any media_id not readable (or non-existent), value is False.

    Implementation constraint: executes exactly ONE SELECT query.
    No per-id roundtrips. Python postprocessing is fine.

    Empty list input: return {} without executing any query.
    """

def is_library_admin(session: Session, viewer_user_id: UUID, library_id: UUID) -> bool:
    """
    True iff viewer_user_id is a member of library_id with role == 'admin'.

    Uses ORM model: Membership
    Filter: library_id, user_id, role = 'admin' (exact, case-sensitive)

    Returns False if library_id does not exist.
    """

def is_admin_of_any_containing_library(session: Session, viewer_user_id: UUID, media_id: UUID) -> bool:
    """
    True iff there exists a library L such that:
      - (L contains media_id via LibraryMedia) AND
      - viewer_user_id has Membership in L with role == 'admin'.

    Returns False if media_id does not exist.
    """
```

#### Query Semantics (Hard Constraints)

- `can_read_media` checks existence of any (LibraryMedia, Membership) join row for viewer.
- `is_library_admin` checks Membership.role == `'admin'` (exact string match, case-sensitive).
- `is_admin_of_any_containing_library` checks admin membership in any library containing the media.
- Role values in database: `'admin'`, `'member'` (lowercase strings, not enums).

#### Index Expectations

PR-02 does not add indexes (S0 schema should already support this), but implementations must use join patterns compatible with:
- `library_media` primary key (library_id, media_id)
- `memberships` primary key (library_id, user_id) with role column

---

### 7) Refactor Existing Endpoint to Use Predicates

Refactor `GET /media/{id}`:
- Replace inline visibility logic with `can_read_media(session, viewer_user_id, media_id)`.
- If predicate returns False, return 404 (not 403).
- Behavior must remain unchanged from S0 except that responses include `X-Request-ID`.

No other endpoint refactors are required in this PR.

---

## Tests

### FastAPI Tests (pytest)

#### Request ID Middleware

1. **test_request_id_generated_when_missing**
   - Call any endpoint without `X-Request-ID`
   - Assert response includes `X-Request-ID`
   - Assert value is valid UUID (lowercase, hyphenated)

2. **test_request_id_preserved_when_valid**
   - Send request with `X-Request-ID: abc_def-123`
   - Assert response header equals `abc_def-123`

3. **test_request_id_uuid_normalized_to_lowercase**
   - Send request with `X-Request-ID: 550E8400-E29B-41D4-A716-446655440000`
   - Assert response header is `550e8400-e29b-41d4-a716-446655440000`

4. **test_request_id_replaced_when_invalid**
   - Send request with `X-Request-ID: "bad id with spaces"`
   - Assert response header is different and is a valid UUID v4

5. **test_request_id_replaced_when_too_long**
   - Send request with `X-Request-ID` header of 10KB
   - Assert response header is a valid UUID v4 (original replaced)

6. **test_request_id_present_on_auth_failure**
   - Call endpoint without auth token
   - Assert 401 response includes `X-Request-ID`

7. **test_error_response_includes_request_id_in_body**
   - Trigger any error (e.g., 404)
   - Assert `error.request_id` present in response JSON

#### Permissions Predicates

8. **test_can_read_media_true_for_member**
   - Create viewer user, library, membership (role='member'), media, library_media
   - Assert `can_read_media(...)` is True

9. **test_can_read_media_true_for_admin**
   - Create viewer user, library, membership (role='admin'), media, library_media
   - Assert `can_read_media(...)` is True

10. **test_can_read_media_false_for_non_member**
    - Create media in library not containing viewer membership
    - Assert False

11. **test_can_read_media_false_for_nonexistent_media**
    - Call with random UUID that doesn't exist in DB
    - Assert False (no existence leak)

12. **test_can_read_media_bulk_mixed**
    - Provide a list with readable, unreadable, and non-existent ids
    - Assert mapping contains all input ids, with correct booleans

13. **test_can_read_media_bulk_empty_list**
    - Call with empty list
    - Assert returns `{}` (and verify no query executed if possible)

14. **test_is_library_admin_true**
    - Membership with role='admin' => True

15. **test_is_library_admin_false_for_member_role**
    - Membership with role='member' => False

16. **test_is_library_admin_false_for_nonexistent_library**
    - Random UUID library => False (no existence leak)

17. **test_is_admin_of_any_containing_library_true**
    - Viewer admin of a library containing media => True

18. **test_is_admin_of_any_containing_library_false_admin_other_library**
    - Viewer admin of other library not containing media => False

19. **test_is_admin_of_any_containing_library_false_nonexistent_media**
    - Random UUID media => False (no existence leak)

#### Endpoint Refactor

20. **test_get_media_404_when_not_readable**
    - Ensure endpoint returns 404 when predicate false

21. **test_get_media_includes_request_id_header**
    - Assert `X-Request-ID` present on 200 response

### Next.js Unit Tests (vitest)

File: `apps/web/src/lib/proxyToFastAPI.test.ts`

22. **proxyToFastAPI_generates_request_id_when_missing**
    - Mock inbound request without header
    - Mock fetch to FastAPI
    - Assert outbound request contains `X-Request-ID` (uuid)

23. **proxyToFastAPI_forwards_existing_request_id**
    - Inbound request includes `X-Request-ID: abc_def-123`
    - Assert outbound includes same

24. **proxyToFastAPI_forwards_allowed_response_headers**
    - FastAPI responds with `X-Request-ID`, `Content-Type`
    - Assert both present in response to browser

25. **proxyToFastAPI_blocks_internal_response_headers**
    - FastAPI responds with `X-Nexus-Internal`, `Set-Cookie`
    - Assert neither present in response to browser

26. **proxyToFastAPI_does_not_expose_authorization_to_browser**
    - Ensure response to browser does not include `Authorization` header

---

## Constraints

- Only modify/add files required for:
  - FastAPI middleware
  - Next.js proxy propagation
  - logging utilities (structlog setup)
  - permissions predicate module
  - tests for the above
- Do not add new endpoints.
- Do not change visibility semantics.
- Do not add external tracing/telemetry dependencies.
- `structlog` is the only new dependency allowed.

---

## Completion Checklist

- All FastAPI tests pass (including request id + permissions)
- Next.js proxy unit tests pass (vitest)
- `GET /media/{id}` still returns 404 for unreadable media
- Every response includes `X-Request-ID` (including auth failures)
- Error responses include `request_id` in body
- Logs are JSON (structlog) and include `request_id`
- Uvicorn default access logs disabled
- No auth tokens/cookies are logged
- Response header allowlist enforced in BFF
- PR does not introduce new endpoints or alter business logic
