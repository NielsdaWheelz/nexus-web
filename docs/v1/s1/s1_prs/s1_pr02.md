# Nexus — L3 PR Spec: S1 PR-02 (X-Request-ID + Authorization Predicates)

## Goal

Introduce:
1) deterministic `X-Request-ID` generation + propagation across Next.js BFF → FastAPI → Celery, and
2) reusable authorization predicates for media/library visibility.

This PR must not change product behavior except:
- responses include `X-Request-ID`
- logging is structured and includes `request_id`
- existing visibility checks are refactored to use a single predicate module (same semantics)

---

## Context

S0 already provides:
- FastAPI bootstrap with auth middleware (Supabase JWT verification + internal header enforcement)
- Next.js BFF helper `proxyToFastAPI()` that forwards bearer + internal header
- `GET /media/{id}` endpoint with inline visibility checks
- DB session helpers + test harness using **nested transactions with a single shared connection injected into the app dependency graph**
- Docker Compose with postgres + redis
- Worker scaffold + Celery placeholder

S1 PR-01 (merged before this PR) provides:
- S1 schema migration + enums + CI harness
- `.env.example` and `X-Nexus-Internal` header policy (required in all envs)

---

## Non-Goals

- No changes to auth, JWT verification, or internal header policy.
- No new endpoints.
- No business logic changes to visibility semantics.
- No OpenTelemetry / tracing system; only request-id correlation.
- No logging of request bodies or Authorization headers/tokens.

---

## Deliverables

### 1) `X-Request-ID` Middleware (FastAPI)

#### Requirements
- Header name: `X-Request-ID` (case-insensitive on input)
- If request includes a valid request id, preserve it.
- Otherwise generate a UUID v4 string.
- Echo final value on **every** response as `X-Request-ID`.
- Store value on request state for downstream use: `request.state.request_id`.

#### Validation Rules
A request id is considered valid if:
- it is a UUID (any version) string, OR
- it matches regex: `^[A-Za-z0-9._-]{1,128}$`

If invalid, silently replace with a newly generated UUID v4.

#### Placement
- Middleware must run **after** internal header/JWT auth middleware is fine, but it must apply to all routes (including auth failures) so every response still includes `X-Request-ID`.
- Middleware must not depend on database access.

---

### 2) `X-Request-ID` Propagation (Next.js BFF)

Update `proxyToFastAPI()` such that:
- If inbound browser request includes `X-Request-ID`, forward it to FastAPI.
- If missing, generate UUID v4 and forward it.
- Never expose bearer tokens to the browser; proxy remains server-only.
- BFF must forward FastAPI response headers (including `X-Request-ID`) back to the browser.

Unit tests must validate:
- generation when missing
- forwarding when present

---

### 3) Celery Logging Convention

Establish a convention (no scheduling required in this PR):
- Celery task entrypoints accept `request_id: str | None = None`
- Celery logs include `request_id` if present.
- Provide a helper to set per-task logging context.

This PR does not need to enqueue tasks; only enable consistent logging for when tasks are invoked in later PRs and in eager-mode tests.

---

### 4) Structured Logging (FastAPI + Celery)

#### FastAPI Logging
- Use JSON structured logs.
- Minimum fields per request log entry:
  - `timestamp`
  - `level`
  - `message`
  - `request_id`
  - `user_id` (if authenticated, else null)
  - `method`
  - `path`
  - `status_code`

#### Celery Logging
- Use JSON structured logs.
- Minimum fields per task log entry:
  - `timestamp`
  - `level`
  - `message`
  - `request_id` (nullable)
  - `task_name`
  - `task_id` (from Celery)
  - optional: `media_id` if task concerns a media row

#### Prohibitions
- Never log Authorization headers, cookies, or JWTs.
- Never log request bodies by default.

---

### 5) Authorization Predicates Module

Create a reusable predicate module used by endpoints and later slices.

#### File
`python/nexus/auth/permissions.py` (or equivalent path consistent with repo conventions)

#### Function Signatures

All functions:
- accept an explicit SQLAlchemy `Session`
- return booleans / mappings only (no HTTP exceptions raised)
- must not leak existence: "not found" and "not visible" both return `False`

```python
from uuid import UUID
from sqlalchemy.orm import Session

def can_read_media(session: Session, viewer_user_id: UUID, media_id: UUID) -> bool:
    """
    True iff media_id appears in at least one library where viewer_user_id is a member.
    Role does not matter (member or admin both count).
    """

def can_read_media_bulk(
    session: Session,
    viewer_user_id: UUID,
    media_ids: list[UUID],
) -> dict[UUID, bool]:
    """
    Returns a dict containing ALL input ids as keys.
    For any media_id not readable (or non-existent), value is False.
    Must be implemented with a single query (no per-id queries).
    """

def is_library_admin(session: Session, viewer_user_id: UUID, library_id: UUID) -> bool:
    """
    True iff viewer_user_id is a member of library_id with role == 'admin'.
    """

def is_admin_of_any_containing_library(session: Session, viewer_user_id: UUID, media_id: UUID) -> bool:
    """
    True iff there exists a library L such that:
      - (L contains media_id) AND
      - viewer_user_id is an admin member of L.
    """
```

#### Query Semantics (Hard Constraints)

- `can_read_media` checks existence of any (library_media, memberships) join row for viewer.
- `is_library_admin` checks membership role.
- `is_admin_of_any_containing_library` checks admin membership in any library containing the media.

#### Index Expectations

PR-02 does not add indexes (S0 schema should already support this), but implementations must use join patterns compatible with:
- `library_media` unique (library_id, media_id)
- membership lookup by (library_id, user_id) and role

---

### 6) Refactor Existing Endpoint to Use Predicates

Refactor `GET /media/{id}`:
- Replace inline visibility logic with `can_read_media(session, viewer_user_id, media_id)`.
- If predicate returns False, return 404 (not 403).
- Behavior must remain unchanged from S0 except that responses include `X-Request-ID`.

No other endpoint refactors are required in this PR.

---

## Tests

### FastAPI Tests (pytest)

#### Request ID Middleware

1. **test_request_id_generated_when_missing**
   - Call any endpoint without `X-Request-ID`
   - Assert response includes `X-Request-ID`
   - Assert value is UUID-like (or passes validation rules)

2. **test_request_id_preserved_when_valid**
   - Send request with `X-Request-ID: abc_def-123`
   - Assert response header equals `abc_def-123`

3. **test_request_id_replaced_when_invalid**
   - Send request with `X-Request-ID: "bad id with spaces"`
   - Assert response header is different and is a UUID v4

#### Permissions Predicates

4. **test_can_read_media_true_for_member**
   - Create viewer user, library, membership, media, library_media
   - Assert `can_read_media(...)` is True

5. **test_can_read_media_false_for_non_member**
   - Create media in library not containing viewer membership
   - Assert False

6. **test_can_read_media_bulk_mixed**
   - Provide a list with readable and unreadable ids
   - Assert mapping contains all input ids, with correct booleans

7. **test_is_library_admin**
   - Member role returns False; admin role returns True

8. **test_is_admin_of_any_containing_library**
   - Viewer admin of a library containing media => True
   - Viewer admin of other library not containing media => False

#### Endpoint Refactor

9. **test_get_media_404_when_not_readable**
   - Ensure endpoint returns 404 when predicate false

10. **test_get_media_includes_request_id_header**
    - Assert `X-Request-ID` present on 200 response

### Next.js Unit Tests

11. **proxyToFastAPI_generates_request_id_when_missing**
    - Mock inbound request without header
    - Mock fetch to FastAPI
    - Assert outbound request contains `X-Request-ID` (uuid)

12. **proxyToFastAPI_forwards_existing_request_id**
    - Inbound request includes `X-Request-ID: abc_def-123`
    - Assert outbound includes same

---

## Constraints

- Only modify/add files required for:
  - FastAPI middleware
  - Next.js proxy propagation
  - logging utilities
  - permissions predicate module
  - tests for the above
- Do not add new endpoints.
- Do not change visibility semantics.
- Do not add external tracing/telemetry dependencies.

---

## Completion Checklist

- All FastAPI tests pass (including request id + permissions)
- Next.js proxy unit tests pass
- `GET /media/{id}` still returns 404 for unreadable media
- Every response includes `X-Request-ID`
- Logs are JSON and include `request_id`
- No auth tokens/cookies are logged
- PR does not introduce new endpoints or alter business logic
