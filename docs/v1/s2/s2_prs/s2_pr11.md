# PR-11 â€” Slice 2 End-to-End Integration + Hardening

This PR finalizes Slice 2 (Web Articles + Highlights) by proving the full
read â†’ highlight â†’ annotate â†’ reload loop works end-to-end and locking
regressions with stable integration tests.

This PR does **not** add new product features.
It validates correctness, security, and developer ergonomics.

---

## 1. Goal

Prove that a real web article can be:

1. Ingested by URL
2. Sanitized and canonicalized
3. Rendered in-app
4. Highlighted (including overlapping highlights)
5. Annotated
6. Reloaded without drift or data loss

â€¦and that all Slice 2 invariants hold under realistic conditions.

---

## 2. Scope

### Included
- Backend end-to-end ingestion + highlight flow
- Security regression coverage for sanitization + image proxy
- Capabilities correctness assertions
- Unicode / emoji stability
- Image proxy HTTP behavior (ETag / 304)
- Minimal Next.js BFF smoke test
- Developer documentation updates

### Explicitly Excluded
- Celery worker execution (sync ingestion only)
- UI visual polish or animation tests
- Performance benchmarking
- New API endpoints or schema changes
- DOM snapshot tests (brittle, low signal)
- Additional fixtures beyond two pages + emoji text

---

## 3. Backend End-to-End Integration Test

### Test Name
`test_web_article_highlight_e2e.py`

### Flow

1. **Create media**
   ```
   POST /media/from_url
   ```
   - Assert:
     - Response status: `201 Created`
     - `processing_status = pending`
     - `duplicate = false`

2. **Run ingestion synchronously**
   ```py
   run_ingest_sync(db_session, media_id, viewer_id)
   ```
   - Assert:
     - `processing_status = ready_for_reading`
     - `canonical_url` set (do NOT assert `canonical_source_url`)
     - exactly one fragment exists (`idx = 0`)
     - `html_sanitized` and `canonical_text` populated

3. **Fetch media**
   ```
   GET /media/{id}
   ```
   - Assert:
     - `capabilities.can_read == true`
     - `capabilities.can_highlight == true`
     - `capabilities.can_quote == true`
     - `capabilities.can_search == false` (search UI not shipped in S2)

4. **Create overlapping highlights**
   - Two highlights with overlapping spans
   - Assert:
     - both persist
     - exact-duplicate span returns `409 E_HIGHLIGHT_CONFLICT`

5. **Verify highlight invariants**
   - For each highlight:
     - `exact == canonical_text[start:end]`
     - `prefix` and `suffix` match canonical text slices

6. **Add annotation**
   ```
   PUT /highlights/{id}/annotation
   ```
   - Assert annotation attached

7. **Reload**
   - Re-fetch highlights and fragment
   - Assert:
     - no offset drift
     - annotation still present
     - `fragment.canonical_text == original_canonical_text` (immutability)

8. **Ownership isolation**
   - Fetch highlights as a different user
   - Assert: `404 E_MEDIA_NOT_FOUND` or empty list (depending on API contract)
   - This prevents regression where user filter is accidentally removed from query

---

## 4. Unicode / Emoji Stability Test

### Purpose

Prevent UTF-16 vs codepoint regressions.

### Fixture

Canonical text contains astral characters:

```
"Hello ðŸŽ‰ World"
```

### Assertions
- Highlight offsets correctly slice emoji-containing text
- `exact`, `prefix`, `suffix` are correct
- Reload does not change offsets or text

---

## 5. Sanitization Security Regression Tests

### Strategy

Property-based assertions (not HTML snapshots).

### Assertions

- No `<script>` tags
- No attributes starting with `on`
- No `style`, `class`, or `id` attributes
- No `javascript:` or `data:` URLs
- SVG images rejected
- `<img src>` rewritten to `/media/image`
- External links include:
  - `rel` containing `noopener noreferrer`
  - `target="_blank"`
  - `referrerpolicy="no-referrer"`

---

## 6. Redirect + Dedup Integration Test

### Fixture

- Requested URL performs HTTP 301 redirect
- Final URL contains actual article content

### Assertions

- `canonical_url` equals normalized final URL
- Second ingest of different requested URL resolving to same final URL:
  - returns existing media
  - does not create duplicate row
  - attaches existing media to default library

---

## 7. Image Proxy Integration Test

### Flow

1. Request proxied image
2. Assert:
   - `Content-Type: image/*`
   - `ETag` present
   - `Cache-Control` present
3. Re-request with `If-None-Match`
   - Assert `304 Not Modified`

---

## 8. Minimal Next.js BFF Smoke Test

### Purpose

Prevent silent proxy regressions.

### Test

- Vitest test for `proxyToFastAPI()`:
  - Attaches `Authorization: Bearer <token>`
  - Attaches `x-nexus-internal` when configured
- One integration test hitting a Next.js route handler
  - Verifies request is forwarded correctly

**No browser automation required.**

---

## 9. Processing-State Regression Coverage

- Re-run Processing-State Test Suite for `web_article`
- Assert:
  - `pending â†’ extracting â†’ ready_for_reading`
  - `failed` states never expose highlights
  - retries reset state correctly

### processing_attempts Assertions

- After forced failure: `processing_attempts` increments
- After success: `processing_attempts` remains at its initial value (not incremented on success path)
- This prevents infinite retry loops and silent failures

---

## 10. Documentation Updates

### CONTRIBUTING.md

Add:
- Playwright dependency install:
  ```bash
  npx playwright install --with-deps chromium
  ```
- How sync ingestion works in tests:
  ```py
  run_ingest_sync(...)
  ```
- When to run a worker (optional, not required for S2)

### Fixture Server Contract (add to CONTRIBUTING.md)

Document these invariants for `pytest-httpserver` usage:

- **Localhost URLs**: Allowed in `NEXUS_ENV=test` only
- **Redirects**: Allowed (301, 302, etc.)
- **JavaScript execution**: Allowed (Playwright renders with JS)
- **External network access**: Forbidden in CI (all HTTP must go through httpserver fixtures)

This prevents "why doesn't this work in prod?" confusion.

No README changes required.

---

## 11. Definition of Done

PR-11 is complete when:

- All backend E2E tests pass deterministically
- Highlights survive reload without drift
- Emoji offsets are stable
- Sanitization security tests pass
- Image proxy caching behavior is verified
- Next.js proxy smoke test passes
- CI runs backend tests + vitest
- No new migrations introduced
- Ownership isolation is tested (different user cannot see highlights)
- `canonical_text` immutability is asserted
- `processing_attempts` behavior is verified

---

## 12. Non-Goals (Re-affirmed)

- No async worker requirement
- No sharing logic
- No semantic search
- No UI polish
- No DOM snapshot tests (brittle)
- No additional fixtures beyond minimal set

This PR locks Slice 2 correctness before Slice 3 begins.
