# PR-03 — Provisional Web Article Creation (`/media/from_url`)

This PR implements **URL-based provisional media creation** for web articles.
It creates a `web_article` media row, attaches it to the viewer's default library,
and defers all fetching, deduplication, and extraction to PR-04.

This PR is strictly about **creating the media row correctly and safely**.

---

## 1. Goal

Enable users to submit a URL and immediately obtain a media object that:
- Is readable by the user (via default library membership)
- Is marked `pending`
- Is ready for ingestion in a later PR
- Does **not** yet perform fetching, sanitization, or deduplication

This establishes the public entry point for web article ingestion.

---

## 2. Non-Goals

This PR explicitly does **not**:
- Fetch or parse the URL
- Follow redirects
- Compute `canonical_url`
- Perform deduplication
- Create fragments
- Enqueue Celery jobs
- Transition processing state beyond `pending`

---

## 3. Endpoint

### `POST /media/from_url`

#### Request

```json
{
  "url": "https://example.com/article"
}
```

#### Validation

- `url` must be a string
- Length ≤ 2048 characters
- Must parse as a valid absolute URL
- Scheme must be `http` or `https`
- Host must be present and non-empty
- **Forbid userinfo** (`user:pass@host` patterns)
- (Recommended) Reject obvious local hosts: `localhost`, `127.0.0.1`, `::1`, `*.local`

Invalid input returns:
- `400 E_INVALID_REQUEST`

---

#### Response

```json
{
  "data": {
    "media_id": "<uuid>",
    "duplicate": false,
    "processing_status": "pending",
    "ingest_enqueued": false
  }
}
```

#### Semantics

- `duplicate` is always `false` in PR-03
- `ingest_enqueued` is always `false` (ingestion not implemented yet)
- `processing_status` is always `pending`

HTTP status:
- `201 Created` for new media rows
- `200 OK` is not used in PR-03 (true duplicates are handled in PR-04)

**Route decorator must specify:** `@router.post("/media/from_url", status_code=201)`

---

## 4. Service Contract

### `create_provisional_web_article(db, viewer_id, url)`

**Location:** `python/nexus/services/media.py`

#### Signature

```python
def create_provisional_web_article(
    db: Session,
    viewer_id: UUID,
    url: str,
) -> FromUrlResponse
```

#### Response Schema

Define in `python/nexus/schemas/media.py`:

```python
class FromUrlResponse(BaseModel):
    media_id: UUID
    duplicate: bool
    processing_status: str
    ingest_enqueued: bool
```

Service returns a Pydantic model, not a dict. Route wraps it in `success_response(result.model_dump(mode="json"))`.

---

## 5. Media Row Creation Rules

### Fields Set in PR-03

| Field | Value |
|-------|-------|
| `id` | New UUID |
| `kind` | `"web_article"` |
| `title` | Truncated `url` (≤255 chars) or `"Untitled"` |
| `requested_url` | Exactly as provided by client |
| `canonical_url` | `NULL` (set in PR-04 after redirect resolution) |
| `canonical_source_url` | `normalize_url_for_display(url)` — see §7 |
| `processing_status` | `pending` |
| `created_by_user_id` | `viewer.user_id` |
| `created_at` | `now()` |
| `updated_at` | `now()` |

### Fields NOT Set (DB defaults apply)

- `file_sha256`
- `failure_stage`
- `last_error_code`
- `last_error_message`
- `external_playback_url`
- `processing_attempts` (defaults to 0)
- `fragments` (none created)

---

## 6. Default Library Attachment

Immediately after media creation:
- Ensure `(default_library_id, media_id)` exists in `library_media`
- Use `_ensure_in_default_library()` from `services/upload.py`
- Operation must be idempotent
- No admin check required (viewer owns their default library)

Failure to attach results in:
- Transaction rollback
- `500 E_INTERNAL`

**Refactor note:** `_ensure_in_default_library()` currently lives in `upload.py` but has no upload-specific logic. Consider moving to `services/libraries.py` for reuse. If not moved, add a test proving it works for `web_article` (no file upload assumptions).

---

## 7. URL Validation & Normalization

### Utility

Create: `python/nexus/services/url_normalize.py`

### Functions

#### `validate_requested_url(url: str) -> None`

Strict validation — raises `InvalidRequestError` on failure:
- Scheme must be `http` or `https`
- Length ≤ 2048 characters
- Host must be present and non-empty
- **No userinfo** (`user:pass@host` forbidden)
- (Recommended) Reject `localhost`, `127.0.0.1`, `::1`, `*.local`
- Must parse as valid absolute URL

#### `normalize_url_for_display(url: str) -> str`

Returns a normalized URL suitable for `canonical_source_url`:
- Lowercase scheme
- Lowercase host
- Strip fragment (`#...`)
- Preserve path, query params, port

**Do NOT:**
- Follow redirects
- Modify query params
- Deduplicate (that's PR-04)

### Usage

```python
validate_requested_url(url)  # raises on invalid
display_url = normalize_url_for_display(url)
```

PR-04 will add `normalize_url_for_dedup(final_url)` using the same rules after redirect resolution.

---

## 8. Permissions & Visibility

- Any authenticated user may call this endpoint
- Resulting media is readable only by:
  - The creating user
  - Via default library membership
- Non-members accessing `/media/{id}` must receive:
  - `404 E_MEDIA_NOT_FOUND`

---

## 9. Error Handling

### Error Codes Used

| Code | Status | Condition |
|------|--------|-----------|
| `E_INVALID_REQUEST` | 400 | Malformed or invalid URL |
| `E_UNAUTHENTICATED` | 401 | Missing/invalid token |
| `E_INTERNAL` | 500 | DB or invariant violation |

Routes do not catch errors; services raise `ApiError` subclasses.

---

## 10. Tests

### Integration Tests (pytest)

- **Creating media:**
  - Creates media row
  - `canonical_url` IS `NULL`
  - `requested_url` stored exactly as provided
  - `canonical_source_url` == `normalize_url_for_display(requested_url)` (NOT NULL)
  - `processing_status` = `pending`
  - Response status code is `201`
  - Response envelope is `{ "data": { ... } }`
- **Default library attachment:**
  - `(default_library_id, media_id)` exists
  - `_ensure_in_default_library` works for `web_article` (no file upload assumptions)
- **Visibility:**
  - Creator can read media via `GET /media/{id}`
  - Other users receive 404
- **Validation:**
  - Invalid scheme → `400 E_INVALID_REQUEST`
  - Overlong URL → `400 E_INVALID_REQUEST`
  - URL with credentials (`user:pass@host`) → `400 E_INVALID_REQUEST`
  - Missing host → `400 E_INVALID_REQUEST`

### Unit Tests

- `validate_requested_url()` rejects:
  - `javascript:` scheme
  - `ftp://` scheme
  - relative URLs
  - malformed URLs
  - URLs with userinfo
  - `localhost` / `127.0.0.1` (if blocking enabled)
- `normalize_url_for_display()`:
  - Lowercases scheme and host
  - Strips fragment
  - Preserves path and query
- Placeholder title truncation behavior

---

## 11. Invariants Established

This PR establishes the following invariants for later slices:
- Web article ingestion always begins with a provisional media row
- Deduplication occurs after redirect resolution, not before
- `canonical_url` is never guessed or heuristically derived — always NULL until PR-04
- `canonical_source_url` is a "best-known source URL" for display — may be updated in PR-04 after redirect resolution to reflect the final URL
- `requested_url` is immutable — exactly what the user submitted
- Media visibility is library-based from the moment of creation
- All ingestion paths converge on the same media model

---

## 12. Done Definition

PR-03 is complete when:
- `/media/from_url` creates a valid provisional `web_article`
- Media is immediately readable by the creator
- No ingestion, fetching, or deduplication occurs
- All tests pass
- No invariants from L0–L2 are violated
