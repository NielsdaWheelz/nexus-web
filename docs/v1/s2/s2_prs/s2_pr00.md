# PR-00 — Centralize Next.js → FastAPI Proxy + Internal Header + Vitest in CI

This PR establishes a single, correct, and testable transport layer between Next.js (BFF) and FastAPI. All subsequent Slice 2 PRs depend on this being rock-solid.

This PR is **infrastructure-only**: no product features, no ingestion, no highlights.

---

## Goal

1. Ensure **every** Next.js API route forwards requests to FastAPI with:
   - correct auth
   - correct internal header
   - correct request id
   - correct query strings
   - correct binary/text handling
2. Remove per-route proxy logic in favor of **one canonical helper**.
3. Add **frontend tests to CI** so future Slice 2 frontend logic is gated.

---

## Non-Goals

- No FastAPI changes
- No new API endpoints
- No CSRF/origin enforcement
- No business logic

---

## Constraints

- **Never log** `Authorization` or `X-Nexus-Internal` header values
- **Never forward** `Cookie` or `Set-Cookie` to FastAPI
- **Proxy buffers responses in memory** in v1; acceptable for JSON and small binaries (images capped at 10MB)

---

## Context / Current State

| Item | Status |
|------|--------|
| Proxy helper location | `apps/web/src/lib/api/proxy.ts` |
| Query strings forwarded | ❌ (not extracted from `req.url`) |
| Binary responses | ❌ (broken via `response.text()`) |
| Request header allowlist | ❌ (only Content-Type copied) |
| Vitest in CI | ❌ |
| Tests for proxy behavior | ❌ |

- Internal header (`X-Nexus-Internal`) is already enforced server-side in staging/prod
- All current routes pass **path-only** URLs (no `?` yet)
  - `/media/image?url=...` will be the first query-bearing route
- `/media/{id}/file` returns JSON signed URL (not binary) — unchanged by this PR

---

## Deliverables

### 1. Canonical Proxy Helper

**File:** `apps/web/src/lib/api/proxy.ts`

#### Required behavior

Export **one** public helper:

```ts
export async function proxyToFastAPI(
  req: Request,
  path: string
): Promise<Response>
```

All `/app/api/**/route.ts` handlers must call this helper directly.

---

### 2. Request Construction Rules

#### Base URL

```ts
const FASTAPI_BASE_URL =
  process.env.FASTAPI_BASE_URL ?? "http://localhost:8000";
```

#### Query String Forwarding

- Extract query string from `req.url` via `new URL(req.url).search`
- Append to upstream URL (semantically equivalent; ordering/encoding may normalize)
- Disallow callers passing `?` inside path
- If `path.includes("?")`, throw synchronously

**Example:**

```
/media/image?url=https%3A%2F%2Fexample.com
→ FASTAPI_BASE_URL + "/media/image" + "?url=https%3A%2F%2Fexample.com"
```

Note: "semantically equivalent" not "verbatim" — URL normalization is acceptable.

---

### 3. Authentication Handling

Retrieve Supabase session via server client:

```ts
const supabase = await createClient();
const { data: { session } } = await supabase.auth.getSession();
```

- If no session or no `access_token`:
  - Return 401 immediately with standard error envelope
  - Do not call FastAPI
  - Include `x-request-id` in response headers

**401 response shape (must match backend):**

```json
{
  "error": {
    "code": "E_UNAUTHENTICATED",
    "message": "Authentication required",
    "request_id": "<uuid>"
  }
}
```

- Otherwise attach:

```
Authorization: Bearer <access_token>
```

---

### 4. Internal Header Handling

If `process.env.NEXUS_INTERNAL_SECRET` is set:

```
X-Nexus-Internal: <raw secret>
```

- Header is attached unconditionally when env var exists
- No token derivation or hashing in frontend

---

### 5. Request ID Propagation

- If incoming request has `x-request-id`, reuse it
- Otherwise generate a UUIDv4
- Always forward upstream as: `x-request-id: <id>`
- Always return it in the response headers

---

### 6. Request Header Forwarding

**Allowlist (copy from incoming request):**

```ts
const ALLOWED_REQUEST_HEADERS = new Set([
  "content-type",
  "accept",
  "range",
  "if-none-match",
  "if-modified-since",
]);
```

**Blocklist (never forward):**

```ts
const BLOCKED_REQUEST_HEADERS = new Set([
  "cookie",
  "authorization",  // we override with session token
  "x-nexus-internal",  // we override with env var
]);
```

**Always set/override:**
- `Authorization: Bearer <access_token>`
- `X-Request-ID: <uuid>`
- `X-Nexus-Internal: <secret>` (if env var set)

---

### 7. Request Body Forwarding (Critical)

For methods other than GET / HEAD:

- Forward body as raw bytes:

```ts
const body = await req.arrayBuffer();
```

- Forward `Content-Type` header from allowlist
- Do not synthesize or override `application/json`

---

### 8. Response Handling (Critical)

#### Content Handling

Inspect upstream `content-type`:

| Content-Type | Method | Return |
|--------------|--------|--------|
| `application/json` or `text/*` | `const txt = await upstream.text()` | `new Response(txt, { status, headers })` |
| Everything else (binary) | `const buf = await upstream.arrayBuffer()` | `new Response(buf, { status, headers })` |

Do NOT forward the upstream Response directly — always construct a new Response to ensure header filtering and request-id guarantee.

#### Status Handling

Preserve:
- `status`
- `statusText`

#### Header Forwarding

**Allowlist:**

```ts
const ALLOWED_RESPONSE_HEADERS = new Set([
  "x-request-id",
  "content-type",
  "content-length",
  "cache-control",
  "etag",
  "vary",
  "content-disposition",
  "location",
]);
```

**Blocklist:**

```ts
const BLOCKED_RESPONSE_HEADERS = new Set([
  "authorization",
  "x-nexus-internal",
  "set-cookie",
]);
```

- Normalize header names to lowercase before comparing
- Blocklist always wins over allowlist
- `x-request-id` always attached (even if upstream omits it)

---

### 9. Refactor Route Handlers

All route handlers must:
- Call `proxyToFastAPI(req, path)`
- Contain zero logic beyond param extraction
- No duplicated proxy logic allowed

---

### 10. Testability Refactor (Required)

To avoid brittle global mocks, extract internal helper:

```ts
proxyToFastAPIWithDeps(req, path, deps)
```

- `proxyToFastAPI` calls it with real deps
- Tests call the deps version with:
  - mocked fetch
  - mocked `getSession`
  - deterministic request id

This is required to keep vitest stable.

---

## Tests

### Frontend (Vitest)

**Location:** `apps/web/src/lib/api/__tests__/proxy.test.ts`

#### Required test cases

| # | Category | Test Cases |
|---|----------|------------|
| 1 | Auth | Missing session → 401, no fetch called, returns error envelope with `E_UNAUTHENTICATED` and `request_id` |
|   |      | Session present → Authorization header attached |
| 2 | Internal Header | Env var set → header attached |
|   |                 | Env var unset → header absent |
| 3 | Query Strings | Query string semantically forwarded (e.g., `?url=https%3A%2F%2Fexample.com%2Fa%3Fb%3Dc` survives decode/re-encode) |
|   |               | `path` containing `?` throws |
| 4 | Request Body | POST forwards raw bytes |
|   |              | Content-Type from allowlist preserved |
| 5 | Request Headers | Allowlisted request headers forwarded (`accept`, `range`, etc.) |
|   |                 | Blocklisted request headers NOT forwarded (`cookie`) |
| 6 | Binary Response | `image/png` → returns correct bytes AND correct `content-type` |
|   |                 | Assert body bytes equal expected (not just "arrayBuffer path used") |
| 7 | Response Headers | Allowlisted headers forwarded |
|   |                  | Blocklisted headers stripped |
|   |                  | `x-request-id` always present (even on early 401) |

---

## CI

**File:** `.github/workflows/ci.yml`

- Extend existing frontend job with `npm test`
- Do not change typecheck strictness in this PR

---

## Acceptance Criteria

- [ ] All Next.js API routes use the canonical proxy helper
- [ ] Binary endpoints (e.g., `/media/image`) work correctly; JSON endpoints unchanged
- [ ] Query strings forwarded correctly (semantically equivalent)
- [ ] Missing auth short-circuits in BFF with standard error envelope
- [ ] `x-request-id` present in all responses (including early 401)
- [ ] Vitest runs in CI and gates merges
- [ ] No FastAPI changes required
- [ ] No product behavior changes

---

## Risks / Mitigations

| Risk | Mitigation |
|------|------------|
| Breaking downloads or images | Explicit binary tests with byte-level assertion |
| Header leakage to browser | Explicit response header allow/block lists |
| Cookie leakage to FastAPI | Explicit request header blocklist |
| Logging sensitive headers | Code review: never log auth/internal headers |

---

## Follow-Ups (Out of Scope)

- CSRF / Origin enforcement
- Streaming passthrough (ReadableStream) — current approach buffers in memory
- Edge runtime support
- Range request handling for large files

---

## Definition of Done

PR-00 is complete when:

- [ ] All tests pass locally and in CI
- [ ] Proxy is the single transport path
- [ ] Subsequent Slice 2 PRs do not re-touch proxy logic
