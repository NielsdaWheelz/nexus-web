# PR-02: S2 Error Codes + Highlights Router Scaffold

> Add the Slice 2 error codes and status mappings, and introduce the `highlights` route module scaffold **without** exposing new endpoints yet.

**Scope:** Small, mechanical, non-behavioral

---

## Context

| Component | Location | Notes |
|-----------|----------|-------|
| `ApiErrorCode` | `python/nexus/errors.py` | Single source of truth for wire-level error codes |
| Status mappings | `ERROR_CODE_TO_STATUS` | Same file, derives HTTP status codes |
| Mapping test | `python/tests/test_errors.py` | Fails if any enum value lacks a mapping |
| Router registry | `python/nexus/api/routes/__init__.py` | Centralized registration with explicit tags |

Internal header enforcement is global middleware — registering a new router does not bypass it.

---

## Non-Goals

- Do **not** implement any endpoints in `highlights.py`
- Do **not** register the highlights router (avoid empty OpenAPI tags)
- Do **not** add helper functions (no `get_*_or_404` helpers)
- Do **not** change error envelope shape or middleware behavior
- Do **not** add retryability/category metadata mappings

---

## Deliverables

### 1. Extend Error Codes

**File:** `python/nexus/errors.py`

#### New Enum Values

Add to `ApiErrorCode`:

| Code | Block | HTTP | Description |
|------|-------|------|-------------|
| `E_INGEST_FAILED` | Ingestion errors | 502 | Upstream fetch failure |
| `E_SANITIZATION_FAILED` | Server errors | 500 | Sanitize/canonicalize failure |
| `E_HIGHLIGHT_INVALID_RANGE` | Highlight errors | 400 | Invalid offset range |
| `E_HIGHLIGHT_CONFLICT` | Highlight errors | 409 | Duplicate highlight |
| `E_MEDIA_NOT_READY` | Highlight errors | 409 | Media not `ready_for_reading` |

#### Required Cleanup

Move `E_INGEST_TIMEOUT` from "Validation errors (400)" block to "Ingestion errors" block. The code maps to 504, not 400 — keeping it in validation errors causes confusion.

> **Note:** `E_INGEST_TIMEOUT` already exists; do not duplicate the enum value.

---

### 2. Extend Error Mapping Tests

**File:** `python/tests/test_errors.py`

Add spot-checks to the existing parametrized test:

```python
@pytest.mark.parametrize("code,expected_status", [
    (ApiErrorCode.E_INGEST_FAILED, 502),
    (ApiErrorCode.E_SANITIZATION_FAILED, 500),
    (ApiErrorCode.E_HIGHLIGHT_INVALID_RANGE, 400),
    (ApiErrorCode.E_HIGHLIGHT_CONFLICT, 409),
    (ApiErrorCode.E_MEDIA_NOT_READY, 409),
])
```

Do not change existing tests beyond adding these cases. The "all codes mapped" test already enforces completeness.

---

### 3. Add Highlights Router Scaffold

**File:** `python/nexus/api/routes/highlights.py` *(new)*

```python
from fastapi import APIRouter

router = APIRouter(tags=["highlights"])
```

- No route handlers in this PR
- Do **not** register in `__init__.py` — registration happens in PR-06

#### Import Test

Add a trivial test to verify the module loads:

```python
def test_highlights_router_imports():
    from nexus.api.routes import highlights
    assert highlights.router is not None
```

---

## Acceptance Criteria

- [ ] `make test-migrations` passes (no migration changes)
- [ ] pytest passes:
  - "All error codes have status mapping" test
  - New spot-check mapping tests
  - Highlights router import test
- [ ] No new OpenAPI tags/routes exposed (router not registered)

---

## Files Changed

| File | Change |
|------|--------|
| `python/nexus/errors.py` | Add error codes + mappings |
| `python/tests/test_errors.py` | Add spot-check tests |
| `python/nexus/api/routes/highlights.py` | New scaffold file |

---

## Completion Checklist

- [ ] New `ApiErrorCode` values added
- [ ] `E_INGEST_TIMEOUT` moved to "Ingestion errors" block
- [ ] `ERROR_CODE_TO_STATUS` includes all new mappings
- [ ] Spot-check tests added for new values
- [ ] Highlights router scaffold exists and imports cleanly
- [ ] Import test added and passes
- [ ] Router is **not** registered yet
- [ ] `pytest` passes locally
