# PR-01 — DB Schema: Highlights + Annotations

This PR introduces persistent storage for highlights and annotations as defined in
**Slice 2 (Web Articles + Highlights)**.

It is a **schema-only PR**: no routes, no services, and no business logic.
All changes conform to the Nexus L0 constitution and L2 Slice 2 spec.

---

## Goal

Establish the database foundation for:
- Overlapping highlights anchored to immutable fragments
- Optional 0..1 annotations per highlight
- Strict integrity guarantees enforced at the database layer

This PR enables later backend and frontend work without requiring further schema changes.

---

## Non-Goals

This PR explicitly does **not** include:
- API endpoints
- Service-layer logic
- Visibility or permission checks
- Highlight creation or rendering
- Any changes to existing tables

---

## Migration

### Revision

- **Revision ID:** `0003`
- **Down Revision:** `0002`
- **Filename:** `0003_slice2_highlights_annotations.py`

---

## Schema Changes

### `highlights` Table

#### DDL (migration must implement exactly)

```python
# Table creation
op.create_table(
    "highlights",
    sa.Column("id", sa.UUID(), primary_key=True, server_default=sa.text("gen_random_uuid()")),
    sa.Column("user_id", sa.UUID(), sa.ForeignKey("users.id", ondelete="CASCADE"), nullable=False),
    sa.Column("fragment_id", sa.UUID(), sa.ForeignKey("fragments.id", ondelete="CASCADE"), nullable=False),
    sa.Column("start_offset", sa.Integer(), nullable=False),
    sa.Column("end_offset", sa.Integer(), nullable=False),
    sa.Column("color", sa.Text(), nullable=False),
    sa.Column("exact", sa.Text(), nullable=False),
    sa.Column("prefix", sa.Text(), nullable=False),
    sa.Column("suffix", sa.Text(), nullable=False),
    sa.Column("created_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.Column("updated_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
)

# CHECK constraints (names must match exactly for test assertions)
op.create_check_constraint(
    "ck_highlights_offsets_valid",
    "highlights",
    "start_offset >= 0 AND end_offset > start_offset",
)
op.create_check_constraint(
    "ck_highlights_color",
    "highlights",
    "color IN ('yellow','green','blue','pink','purple')",
)

# Unique index (name must match exactly for test assertions)
op.create_index(
    "uix_highlights_user_fragment_offsets",
    "highlights",
    ["user_id", "fragment_id", "start_offset", "end_offset"],
    unique=True,
)
```

#### Semantics (non-DDL)

- Offsets are half-open `[start_offset, end_offset)` in Unicode codepoints over `fragment.canonical_text`
- **DB stores integers only**; codepoint interpretation is enforced by service/frontend in PR-06+
- Overlapping highlights are allowed
- Duplicate highlights at the exact same span by the same user are forbidden
- `exact`, `prefix`, and `suffix` are server-derived and persisted for:
  - Cheap reads
  - Debugging
  - Future repair tooling (out of scope for v1)

---

### `annotations` Table

#### DDL (migration must implement exactly)

```python
op.create_table(
    "annotations",
    sa.Column("id", sa.UUID(), primary_key=True, server_default=sa.text("gen_random_uuid()")),
    sa.Column("highlight_id", sa.UUID(), sa.ForeignKey("highlights.id", ondelete="CASCADE"), nullable=False),
    sa.Column("body", sa.Text(), nullable=False),
    sa.Column("created_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.Column("updated_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
)

# Unique constraint (name must match exactly for test assertions)
op.create_unique_constraint(
    "uix_annotations_one_per_highlight",
    "annotations",
    ["highlight_id"],
)
```

#### Semantics (non-DDL)

- An annotation is optional and strictly 0..1 per highlight
- An annotation does not have its own `user_id`; ownership is derived via `highlights.user_id`
- Deleting a highlight cascades to delete its annotation
- Deleting an annotation leaves the highlight intact (service behavior, not DB enforced)

---

## SQLAlchemy Models

Add the following models to `python/nexus/db/models.py` using the existing SQLAlchemy 2.x style:

- `Highlight`
- `Annotation`

**Conventions:**

- Use `Mapped[]` + `mapped_column()`
- UUID primary keys via `gen_random_uuid()`
- `TIMESTAMP(timezone=True)` with `server_default=text("now()")`
- No triggers for `updated_at` — service-layer responsibility
- **No relationships in PR-01** (keep this PR schema-only; relationships can be added in PR-06 if needed)

**Invariant for follow-on PRs:** PR-06 must set `updated_at = datetime.now(UTC)` on every update; tests will enforce.

---

## Pydantic Schemas

Create `python/nexus/schemas/highlights.py` with:

**Output Schemas:**

- `HighlightOut`
- `AnnotationOut`

**Request Schemas (matching repo convention):**

- `CreateHighlightRequest`
- `UpdateHighlightRequest`
- `UpsertAnnotationRequest`

**Conventions:**

- `model_config = ConfigDict(from_attributes=True)` for output schemas
- No validation logic beyond basic field typing
- Business validation occurs in later PRs

Export schemas via `schemas/__init__.py`.

---

## Tests

**Location:** `python/tests/test_migrations.py` using `migrated_engine` fixture

Add DB-level integrity tests following existing patterns (`make test-migrations`):

**Constraints:**

- Invalid color rejected → assert `"ck_highlights_color"` in error
- Invalid offset range rejected → assert `"ck_highlights_offsets_valid"` in error
- Duplicate `(user_id, fragment_id, start_offset, end_offset)` rejected → assert `"uix_highlights_user_fragment_offsets"` in error
- Second annotation for same highlight rejected → assert `"uix_annotations_one_per_highlight"` in error

**Cascades:**

- Deleting a highlight deletes its annotation
- Deleting a fragment deletes associated highlights (and annotations)

Assertions must check constraint/index names in raised `IntegrityError` messages (existing test pattern).

---

## Out of Scope (Explicit)

- No API routes
- No service functions
- No visibility predicates
- No frontend changes
- No ingestion logic
- No sharing semantics

---

## Acceptance Criteria

This PR is complete when:

- [ ] Alembic migration applies cleanly (`alembic upgrade head`)
- [ ] Alembic migration rolls back cleanly (`alembic downgrade 0002`)
- [ ] All new constraints are enforced at the DB level
- [ ] Migration tests pass (`make test-migrations`)
- [ ] Models and schemas compile without unused imports
- [ ] No existing tests regress

---

## Notes

- Color enforcement uses a CHECK constraint, not a PostgreSQL enum, to allow painless palette extension later.
- `annotations.user_id` is intentionally omitted to avoid ownership drift.
- Offset bounds relative to `fragment.canonical_text` length are validated in service logic (PR-06); DB cannot enforce this safely.

---

## Follow-On PRs

- PR-02: error codes + routing scaffolds
- PR-06: highlight + annotation services and endpoints
- PR-08+: frontend rendering and interaction

