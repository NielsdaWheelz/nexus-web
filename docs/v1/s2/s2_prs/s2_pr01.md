# PR-01 — DB Schema: Highlights + Annotations

> **Slice 2 · Schema-Only PR**
>
> Introduces persistent storage for highlights and annotations. No routes, services, or business logic.

## Overview

| Attribute | Value |
|-----------|-------|
| Revision ID | `0003` |
| Down Revision | `0002` |
| Filename | `0003_slice2_highlights_annotations.py` |

## Goal

Establish the database foundation for:

- Overlapping highlights anchored to immutable fragments
- Optional 0..1 annotations per highlight
- Strict integrity guarantees enforced at the database layer

This PR enables later backend and frontend work without requiring further schema changes.

## Non-Goals

| Excluded | Reason |
|----------|--------|
| API endpoints | Deferred to PR-02+ |
| Service-layer logic | Deferred to PR-06 |
| Visibility / permission checks | Deferred to PR-06 |
| Highlight creation or rendering | Deferred to PR-06+ |
| Changes to existing tables | Not required |

---

## Schema: `highlights`

### Columns

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | PK, `gen_random_uuid()` |
| `user_id` | `UUID` | FK → `users.id` (CASCADE) |
| `fragment_id` | `UUID` | FK → `fragments.id` (CASCADE) |
| `start_offset` | `Integer` | NOT NULL |
| `end_offset` | `Integer` | NOT NULL |
| `color` | `Text` | NOT NULL |
| `exact` | `Text` | NOT NULL |
| `prefix` | `Text` | NOT NULL |
| `suffix` | `Text` | NOT NULL |
| `created_at` | `TIMESTAMP(tz)` | `now()` |
| `updated_at` | `TIMESTAMP(tz)` | `now()` |

### Constraints & Indexes

| Name | Type | Definition |
|------|------|------------|
| `ck_highlights_offsets_valid` | CHECK | `start_offset >= 0 AND end_offset > start_offset` |
| `ck_highlights_color` | CHECK | `color IN ('yellow','green','blue','pink','purple')` |
| `uix_highlights_user_fragment_offsets` | UNIQUE INDEX | `(user_id, fragment_id, start_offset, end_offset)` |

### DDL

```python
op.create_table(
    "highlights",
    sa.Column("id", sa.UUID(), primary_key=True, server_default=sa.text("gen_random_uuid()")),
    sa.Column("user_id", sa.UUID(), sa.ForeignKey("users.id", ondelete="CASCADE"), nullable=False),
    sa.Column("fragment_id", sa.UUID(), sa.ForeignKey("fragments.id", ondelete="CASCADE"), nullable=False),
    sa.Column("start_offset", sa.Integer(), nullable=False),
    sa.Column("end_offset", sa.Integer(), nullable=False),
    sa.Column("color", sa.Text(), nullable=False),
    sa.Column("exact", sa.Text(), nullable=False),
    sa.Column("prefix", sa.Text(), nullable=False),
    sa.Column("suffix", sa.Text(), nullable=False),
    sa.Column("created_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.Column("updated_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
)

op.create_check_constraint(
    "ck_highlights_offsets_valid",
    "highlights",
    "start_offset >= 0 AND end_offset > start_offset",
)

op.create_check_constraint(
    "ck_highlights_color",
    "highlights",
    "color IN ('yellow','green','blue','pink','purple')",
)

op.create_index(
    "uix_highlights_user_fragment_offsets",
    "highlights",
    ["user_id", "fragment_id", "start_offset", "end_offset"],
    unique=True,
)
```

### Semantics

| Rule | Detail |
|------|--------|
| Offset range | Half-open `[start, end)` in Unicode codepoints over `fragment.canonical_text` |
| Storage | DB stores integers only; codepoint interpretation enforced by service/frontend (PR-06+) |
| Overlaps | Allowed |
| Duplicates | Forbidden (same user + fragment + offsets) |
| `exact`, `prefix`, `suffix` | Server-derived; persisted for cheap reads, debugging, future repair tooling |

---

## Schema: `annotations`

### Columns

| Column | Type | Constraints |
|--------|------|-------------|
| `id` | `UUID` | PK, `gen_random_uuid()` |
| `highlight_id` | `UUID` | FK → `highlights.id` (CASCADE), UNIQUE |
| `body` | `Text` | NOT NULL |
| `created_at` | `TIMESTAMP(tz)` | `now()` |
| `updated_at` | `TIMESTAMP(tz)` | `now()` |

### Constraints

| Name | Type | Definition |
|------|------|------------|
| `uix_annotations_one_per_highlight` | UNIQUE | `(highlight_id)` |

### DDL

```python
op.create_table(
    "annotations",
    sa.Column("id", sa.UUID(), primary_key=True, server_default=sa.text("gen_random_uuid()")),
    sa.Column("highlight_id", sa.UUID(), sa.ForeignKey("highlights.id", ondelete="CASCADE"), nullable=False),
    sa.Column("body", sa.Text(), nullable=False),
    sa.Column("created_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.Column("updated_at", sa.TIMESTAMP(timezone=True), server_default=sa.text("now()"), nullable=False),
)

op.create_unique_constraint(
    "uix_annotations_one_per_highlight",
    "annotations",
    ["highlight_id"],
)
```

### Semantics

| Rule | Detail |
|------|--------|
| Cardinality | 0..1 per highlight |
| Ownership | Derived via `highlights.user_id` (no own `user_id`) |
| Cascade | Deleting highlight → deletes annotation |
| Reverse | Deleting annotation leaves highlight intact (service behavior) |

---

## SQLAlchemy Models

Add to `python/nexus/db/models.py`:

| Model | Notes |
|-------|-------|
| `Highlight` | SQLAlchemy 2.x style |
| `Annotation` | SQLAlchemy 2.x style |

**Conventions:**

- `Mapped[]` + `mapped_column()`
- UUID PKs via `gen_random_uuid()`
- `TIMESTAMP(timezone=True)` with `server_default=text("now()")`
- No triggers for `updated_at` — service-layer responsibility
- **No relationships in PR-01** (add in PR-06 if needed)

> **Invariant:** PR-06 must set `updated_at = datetime.now(UTC)` on every update; tests will enforce.

---

## Pydantic Schemas

Create `python/nexus/schemas/highlights.py`:

| Category | Schemas |
|----------|---------|
| Output | `HighlightOut`, `AnnotationOut` |
| Request | `CreateHighlightRequest`, `UpdateHighlightRequest`, `UpsertAnnotationRequest` |

**Conventions:**

- `model_config = ConfigDict(from_attributes=True)` for output schemas
- No validation logic beyond basic field typing
- Business validation in later PRs

Export via `schemas/__init__.py`.

---

## Tests

**Location:** `python/tests/test_migrations.py` (uses `migrated_engine` fixture)

### Constraint Tests

| Test Case | Assert Contains |
|-----------|-----------------|
| Invalid color rejected | `"ck_highlights_color"` |
| Invalid offset range rejected | `"ck_highlights_offsets_valid"` |
| Duplicate span rejected | `"uix_highlights_user_fragment_offsets"` |
| Second annotation rejected | `"uix_annotations_one_per_highlight"` |

### Cascade Tests

| Action | Expected Result |
|--------|-----------------|
| Delete highlight | Annotation deleted |
| Delete fragment | Highlights + annotations deleted |

---

## Acceptance Criteria

- [ ] `alembic upgrade head` applies cleanly
- [ ] `alembic downgrade 0002` rolls back cleanly
- [ ] All constraints enforced at DB level
- [ ] `make test-migrations` passes
- [ ] Models and schemas compile without unused imports
- [ ] No existing tests regress

---

## Design Notes

| Decision | Rationale |
|----------|-----------|
| CHECK constraint for colors | Allows painless palette extension (vs. PostgreSQL enum) |
| No `annotations.user_id` | Avoids ownership drift |
| Offset bounds not DB-enforced | Requires `fragment.canonical_text` length; validated in service (PR-06) |

---

## Follow-On PRs

| PR | Scope |
|----|-------|
| PR-02 | Error codes + routing scaffolds |
| PR-06 | Highlight + annotation services and endpoints |
| PR-08+ | Frontend rendering and interaction |
