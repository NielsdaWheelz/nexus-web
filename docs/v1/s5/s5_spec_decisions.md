# Slice 5 Spec Decisions

## Decision Ledger

| id | question | decision | rationale | fallback/default | owner | due | status |
|---|---|---|---|---|---|---|---|
| S5-D01 | How should Slice 5 be decomposed for L2 authoring? | Use five contract clusters: (1) ingestion + lifecycle, (2) chapter/fragment model, (3) TOC and navigation contract, (4) highlight/chat reuse over EPUB fragments, (5) acceptance/traceability hardening. | Mirrors L1 acceptance surfaces and enforces L2 cluster micro-loop discipline. | n/a | Spec owner | Immediate | Accepted |
| S5-D02 | Should S5 include URL-based EPUB/PDF ingestion in scope? | S5 is upload-first; URL EPUB/PDF ingestion is excluded from S5 and deferred to v2. | Current merged code supports upload-backed ingestion paths; avoids scope blowup and keeps v1 aligned to revised scope. | Source-agnostic ingestion seam is mandatory so URL paths can converge later without contract split. | Product + spec owner | v2 planning | Accepted (user-approved 2026-02-19; updated 2026-02-20) |
| S5-D03 | What is the canonical TOC persistence model? | Persist immutable TOC snapshot in `epub_toc_nodes` with deterministic hierarchy/order and optional chapter linkage via `fragment_idx`. | Read-time TOC derivation is unstable and expensive; persisted snapshot gives deterministic navigation and auditability. | For EPUBs with no usable TOC, persist zero rows and rely on chapter list fallback titles. | Spec owner | S5 | Accepted (user-approved 2026-02-19) |
| S5-D04 | What is the API shape for chapter navigation? | Keep `GET /media/{id}/fragments` for compatibility and add dedicated EPUB APIs: `GET /media/{id}/chapters`, `GET /media/{id}/chapters/{idx}`, `GET /media/{id}/toc`. | Prevents loading full-book content for chapter nav and establishes cache-friendly read contracts. | Legacy clients may continue using fragments endpoint until migrated. | Spec owner | S5 | Accepted (user-approved 2026-02-19) |
| S5-D05 | How should manual processing retry be exposed? | Add explicit `POST /media/{id}/retry` and keep `POST /media/{id}/ingest` as upload-confirm + dedupe commit only. | Separates operational intents, improves observability and policy control, and avoids mixed semantics in shared endpoint. | None. Retry endpoint is normative for S5. | Spec owner | S5 | Accepted (user-approved 2026-02-19) |
| S5-D06 | Should missing TOC be extraction-fatal? | No. Missing or unusable TOC is non-fatal if chapter fragments are valid; return `nodes: []` and continue. | Real EPUB catalogs are inconsistent; failing hard on TOC-only defects creates avoidable ingestion failures. | When TOC parse fails but chapter parse succeeds, set empty TOC snapshot and continue to ready state. | Spec owner | S5 | Accepted |
| S5-D07 | Should chapter list support paging? | Yes. Cursor-by-idx paging (`limit`, `cursor`) is part of contract. | Supports very large books with bounded payloads and deterministic page traversal. | Clients may fetch all pages and cache locally for full-book sidebar UX. | Spec owner | S5 | Accepted |
| S5-D08 | How should spine items map to chapter fragments? | Fragment generation follows EPUB spine order; only readable spine items (non-empty canonical text after sanitization/trim) produce fragments. | Prevents noisy/empty structural documents from polluting chapter navigation while preserving deterministic order. | Non-readable spine items may still appear in TOC with `fragment_idx=null`. | Spec owner | S5 | Accepted |
| S5-D09 | How should unresolved EPUB internal resources behave? | Resource references must be rewritten via EPUB mapping; unresolved assets degrade safely without blocking `ready_for_reading` when text extraction is valid. | Preserves reading/highlight core behavior despite common real-world EPUB asset inconsistencies. | If resource rewrite fails for a node, chapter text remains valid and active content remains sanitized. | Spec owner | S5 | Accepted |
| S5-D10 | Should legacy document-system patterns be adopted (public buckets, URL discriminator, redirect APIs)? | No. Legacy patterns are explicitly rejected; S5 remains aligned to L0 private storage, `media.kind`, and JSON envelope APIs. | Legacy patterns conflict with constitution-level architecture/security constraints. | n/a | Spec owner | S5 | Accepted |
| S5-D11 | What is the deterministic EPUB title fallback contract? | Use strict fallback order: `dc:title`/`title` from OPF metadata, then upload filename without extension, then literal `Untitled EPUB` after normalization. | Prevents parser drift and inconsistent title outcomes across ingestion implementations. | If all metadata keys are empty/invalid and filename normalizes empty, store `Untitled EPUB`. | Spec owner | S5 | Accepted (user-approved 2026-02-19) |
| S5-D12 | Which pagination envelope should chapter list use? | Use the canonical pagination envelope: top-level `data` array plus top-level `page` object containing `next_cursor` and `has_more`. | Best-practice priority is cross-API contract consistency and non-breaking client behavior; this matches constitution-level conventions. | None. All new S5 paginated endpoints follow this shape. | Spec owner | S5 | Accepted (user-approved 2026-02-19) |
| S5-D13 | How strict should retry cleanup be? | Retry reset must clear extraction artifacts and any existing chunk/embedding artifacts before restarting extraction. | Prevents mixed-generation reads, stale search artifacts, and non-deterministic state after failure recovery. | If no chunk/embedding artifacts exist in a deployment, cleanup is a no-op for those stores. | Spec owner | S5 | Accepted |
| S5-D14 | How should chapter/toc endpoints behave for non-EPUB media? | `GET /chapters`, `GET /chapters/{idx}`, and `GET /toc` return `400 E_INVALID_KIND` for non-EPUB media rows. | Makes kind guards explicit and prevents silent cross-kind behavior drift. | None. | Spec owner | S5 | Accepted |
| S5-D15 | What archive safety baseline must EPUB ingest enforce? | Enforce path traversal rejection plus bounded limits (entries, decompressed bytes, compression ratio, parse time), failing with `E_ARCHIVE_UNSAFE`. | Establishes minimum zip-bomb/path-traversal defenses as a normative contract, not optional implementation behavior. | Operators may tighten limits; they may not relax below the baseline defaults. | Spec owner + security | S5 | Accepted |
| S5-D16 | How are `has_toc_entry` and `primary_toc_node_id` derived? | `has_toc_entry` is true iff any TOC node maps to chapter `idx`; `primary_toc_node_id` is the mapped node with smallest `order_key` (else null). | Removes response ambiguity when multiple TOC nodes map to one chapter and keeps chapter manifests deterministic. | None. | Spec owner | S5 | Accepted |
| S5-D17 | How is `order_key` generated and compared to guarantee deterministic TOC ordering? | Use canonical zero-padded ordinal path keys (`dddd(.dddd)*`) derived from normalized source order; compare with ASCII lexicographic ascending order; tie-break ambiguous siblings by source encounter index then `node_id`. | Prevents parser/library drift from producing incomparable keys and enforces deterministic TOC/chapter navigation outputs. | If parser emits ambiguous sibling order, apply deterministic tie-break rules before persisting. | Spec owner | S5 | Accepted |
| S5-D18 | How should retry behave for `E_ARCHIVE_UNSAFE` failures? | Treat `E_ARCHIVE_UNSAFE` as terminal for the media row in S5; `POST /media/{id}/retry` returns `409 E_RETRY_NOT_ALLOWED`; remediation is fresh upload (new media row). | Avoids unimplementable “in-row input replacement” semantics and keeps retry behavior explicit and testable. | None. | Spec owner + product | S5 | Accepted |
| S5-D19 | Should `order_key` format validation be enforced at the database layer? | Yes. `epub_toc_nodes.order_key` must have a named DB `CHECK` constraint enforcing `dddd(.dddd)*` format. | Deterministic ordering is a persisted data invariant; DB enforcement prevents malformed keys from parser/service drift. | If expression syntax needs adjustment per engine specifics, keep equivalent strict matcher semantics and preserve named constraint stability. | Spec owner + platform | S5 | Accepted (user-approved 2026-02-20) |
| S5-D20 | How should rewritten EPUB-internal asset URLs be resolved safely and deterministically? | Use canonical path contract `GET /media/{media_id}/assets/{asset_key}` with deterministic `asset_key` derivation, visibility masking (`404 E_MEDIA_NOT_FOUND`), and no direct private storage URL exposure. | Leaves retrieval path implementation-defined; direct signed/private storage URLs embedded in persisted HTML. | Completes resource rewrite contract and prevents incompatible asset fetch behavior across implementations. | If endpoint wiring is temporarily blocked, rewritten URLs must still target this canonical path and unresolved assets must degrade safely without active content execution. | Spec owner + platform | S5 | Accepted (user-approved 2026-02-20) |
| S5-D21 | How should `POST /media/{id}/ingest` behave on repeat non-duplicate calls after dispatch/state advance? | Treat repeat calls as idempotent lifecycle snapshots: no redispatch, no `processing_attempts` increment, `ingest_enqueued=false` unless dispatch actually occurs. | Prevents duplicate work and illegal state-machine transitions under client retries/races while preserving response compatibility. | `failed` rows are remediated through `POST /media/{id}/retry`, not via redispatch from `/ingest`. | Spec owner + platform | S5 | Accepted (user-approved 2026-02-21) |
| S5-D22 | Should retry perform cleanup before validating source file integrity? | No. Retry MUST enforce source-integrity preconditions before cleanup/reset; failures are deterministic and non-mutating. | Prevents destructive cleanup followed by guaranteed extraction failure when source file is missing/corrupt/mismatched. | Source-integrity mismatch is treated under deterministic storage/validation error contract and caller remediation is restore source or fresh upload. | Spec owner + platform | S5 | Accepted (user-approved 2026-02-21) |
| S5-D23 | How should chapter-list cursor behave when the provided cursor is beyond the current max chapter index? | Treat as deterministic exhausted page, not an error: return `200` with empty `data`, `next_cursor=null`, `has_more=false`. | Supports resumable clients and avoids brittle error branching for benign stale cursor states while preserving deterministic pagination semantics. | Malformed cursor values and negative cursor domain remain `400 E_INVALID_REQUEST`. | Spec owner + platform | S5 | Accepted (user-approved 2026-02-21) |
| S5-D24 | Should `/media/{id}/chapters/{idx}` ever return concatenated multi-chapter payloads for convenience? | No. `/chapters/{idx}` is strictly chapter-scoped to exactly one persisted fragment for `idx`. | Preserves chapter-boundary architecture and prevents regression to legacy whole-book concatenation behavior. | Whole-book reads remain available through existing `/media/{id}/fragments` iteration; no contract change in S5. | Spec owner + platform | S5 | Accepted (user-approved 2026-02-21) |

## Notes
- All previously open S5 decisions are resolved; `s5_spec.md` unresolved section is intentionally empty.
- No L3/L4 implementation details are included in this ledger.
