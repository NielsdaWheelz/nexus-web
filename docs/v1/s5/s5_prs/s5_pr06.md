# pr-06: s5 highlight + quote-to-chat compatibility on epub

## goal
Prove existing highlight and quote-to-chat contracts remain compatible on EPUB chapter fragments, including deterministic highlight-attach handoff into chat composer flows, without changing public API shapes.

## context
- PR-06 scope is explicitly C7 compatibility reuse for highlights/chat on EPUB fragments (`docs/v1/s5/s5_roadmap.md:140`).
- C7 ownership is locked to section `4.7` and invariants `6.6-6.8`; feature expansion is out of scope (`docs/v1/s5/s5_roadmap_ownership.md:22`).
- L2 compatibility contract requires no API shape change for highlight endpoints and quote-to-chat, and preserves `/media/{id}/fragments` (`docs/v1/s5/s5_spec.md:592`).
- L2 invariant requires EPUB highlight anchoring to remain canonical fragment offsets only (`docs/v1/s5/s5_spec.md:668`).
- L2 invariant requires quote-to-chat determinism from immutable `fragment.canonical_text` (`docs/v1/s5/s5_spec.md:670`).
- Reader already emits quote-to-chat navigation with `attach_type=highlight&attach_id=<highlight_id>` (`apps/web/src/app/(authenticated)/media/[id]/page.tsx:786`).
- Chat composer already supports attached contexts and forwards them in `SendMessageRequest.contexts` (`apps/web/src/components/ChatComposer.tsx:64`, `apps/web/src/components/ChatComposer.tsx:398`).
- Conversations pages currently do not consume attach query params or pass attached contexts to the composer (`apps/web/src/app/(authenticated)/conversations/page.tsx:10`, `apps/web/src/app/(authenticated)/conversations/[id]/page.tsx:10`).
- Highlight APIs are already fragment-scoped and derive exact/prefix/suffix from `fragment.canonical_text` (`python/nexus/api/routes/highlights.py:39`, `python/nexus/services/highlights.py:84`).
- Quote context rendering already resolves from highlight -> fragment -> `get_context_window(fragment_id, start_offset, end_offset)` (`python/nexus/services/context_rendering.py:147`, `python/nexus/services/context_window.py:44`).
- Existing send-message context visibility gate is currently `can_read_media`-based and documented in S3 (`python/nexus/services/send_message.py:345`, `docs/v1/s3/s3_spec.md:553`).
- Existing `/media/{id}/fragments` endpoint remains ordered by `idx ASC` and service-owned (`python/nexus/api/routes/media.py:141`, `python/nexus/services/media.py:314`).

## dependencies
- PR-02 merged (EPUB fragments + fragment_blocks extraction artifacts available).
- PR-04 merged (chapter/toc read APIs available; no C5 contract changes needed here).
- Mainline context includes PR-05 reader adoption and quote-to-chat trigger seam; PR-06 must remain compatible with that state without introducing a formal dependency on C6 ownership.

---

## deliverables

### `apps/web/src/lib/conversations/attachedContext.ts` (new)
- Add a dedicated URL-attach parsing helper for chat context bootstrapping.
- Define deterministic parser behavior:
  - supports `attach_type=highlight` only in v1.
  - accepts only valid UUID `attach_id`; invalid/malformed IDs are ignored.
  - unsupported `attach_type` values are ignored (non-fatal).
  - output shape is `ContextItem[]` aligned to `apps/web/src/lib/api/sse.ts`.
- Add helper to canonicalize query params after attach consumption by removing `attach_type` and `attach_id` while preserving unrelated query keys.

### `apps/web/src/lib/conversations/attachedContext.test.ts` (new)
- Add focused unit tests for parser/canonicalizer behavior.

Required tests:

**test: `parse_attach_context_returns_highlight_context_for_valid_query`**
- input:
  - query params contain `attach_type=highlight` and valid UUID `attach_id`.
- output:
  - returns `[ { type: "highlight", id: "<uuid>" } ]`.

**test: `parse_attach_context_ignores_invalid_or_unsupported_values`**
- input:
  - invalid UUID, missing id, or unsupported `attach_type`.
- output:
  - returns empty context list.

**test: `strip_attach_params_preserves_unrelated_query_keys`**
- input:
  - query params include attach keys plus unrelated keys.
- output:
  - attach keys removed; unrelated keys retained in stable order.

### `apps/web/src/app/(authenticated)/conversations/page.tsx`
- Implement attach-context bridge for new-chat route (`/conversations`):
  - parse `attach_type` + `attach_id` via helper.
  - when parsed context exists, pre-open composer state (`showNewChat=true`) and pass `attachedContexts` into `ChatComposer`.
  - pass `onRemoveContext` so chips are removable.
  - on successful send, clear attached contexts and canonicalize URL by removing attach query params via `router.replace`.
- Keep existing conversation list fetch/pagination behavior unchanged.
- Keep non-attach flows unchanged.
- Do not introduce cross-page global conversation targeting state; route remains source of truth (S3 binding).

### `apps/web/src/app/(authenticated)/conversations/[id]/page.tsx`
- Implement attach-context consumption for existing-conversation route (`/conversations/{id}`):
  - parse attach params via shared helper.
  - pass parsed context to the page’s `ChatComposer` instance for this conversation.
  - support chip removal and clear attach params after successful send via URL canonicalization.
- Keep existing message load, streaming callbacks, and pagination behavior unchanged.

### `apps/web/src/app/(authenticated)/conversations/page.test.tsx` (new)
- Add integration tests for attach-context behavior on `/conversations`.
- Mock `apiFetch`, router/search params, and `ChatComposer` callbacks as needed.

Required tests:

**test: `conversations_page_valid_attach_query_preloads_composer_context`**
- input:
  - route query includes valid `attach_type=highlight&attach_id=<uuid>`.
- output:
  - new-chat composer path is active.
  - attached context chip/state is present and mapped to highlight context.

**test: `conversations_page_invalid_attach_query_is_ignored`**
- input:
  - invalid attach query (`attach_type` unsupported or malformed UUID).
- output:
  - no attached contexts; page remains usable with no attach errors.

**test: `conversations_page_send_includes_attached_context_and_clears_state`**
- input:
  - valid attached highlight context, user sends message.
- output:
  - outgoing send payload includes `contexts=[{type:"highlight",id}]`.
  - attached contexts clear after success.
  - URL canonicalized with attach params removed via `router.replace`.

**test: `conversations_page_send_failure_retains_attach_state`**
- input:
  - valid attached highlight context, user send fails with API error.
- output:
  - attached context remains present for retry.
  - attach params are not removed from URL.

**test: `conversations_page_remove_context_chip_excludes_context_from_send`**
- input:
  - valid attached context then user removes chip before send.
- output:
  - outgoing send payload has no attached contexts.

### `apps/web/src/app/(authenticated)/conversations/[id]/page.test.tsx` (new)
- Add integration tests for attach-context behavior on `/conversations/{id}`.

Required tests:

**test: `conversation_detail_valid_attach_query_preloads_context_for_target_conversation`**
- input:
  - route includes valid attach query.
- output:
  - composer receives attached highlight context for this conversation ID.

**test: `conversation_detail_invalid_attach_query_is_ignored`**
- input:
  - invalid attach query (`attach_type` unsupported or malformed UUID).
- output:
  - no attached contexts; page remains usable with no attach errors.

**test: `conversation_detail_send_includes_attached_context_and_clears_after_success`**
- input:
  - attached highlight context then send.
- output:
  - send payload includes attached context.
  - attached context clears and attach params are removed from URL after success.

**test: `conversation_detail_send_failure_retains_attach_state`**
- input:
  - attached highlight context then send fails with API error.
- output:
  - attached context remains present for retry.
  - attach params are not removed from URL.

### `python/tests/factories.py`
- Extend/add test factories to create EPUB media/fragments in library-linked fixtures without duplicating raw SQL in every test.
- Requirements:
  - support creating `media.kind='epub'` rows in ready states.
  - support creating chapter fragments with explicit `idx` and deterministic canonical text payloads.
  - keep existing web-article factory semantics unchanged.

### `python/tests/test_highlights.py`
- Add explicit EPUB compatibility tests for existing highlight endpoints (no API contract changes).

Required tests:

**test: `test_epub_highlight_scopes_to_target_fragment_only`**
- input:
  - ready EPUB with at least three chapter fragments.
  - create highlight on fragment for chapter idx=1.
- output:
  - highlight appears when listing chapter idx=1 fragment highlights.
  - chapter idx=0 and idx=2 fragment highlight lists remain unaffected.

**test: `test_epub_highlight_exact_prefix_suffix_derived_from_chapter_canonical_text`**
- input:
  - EPUB chapter fragment with unicode-rich canonical text.
  - create highlight with explicit offsets.
- output:
  - `exact/prefix/suffix` derive from that chapter fragment canonical text only.
  - returned offsets remain canonical codepoint offsets.

**test: `test_epub_highlight_rejects_legacy_global_offsets_as_invalid_range`**
- input:
  - ready EPUB with at least two chapter fragments.
  - attempt highlight creation on chapter `idx=1` fragment using offsets valid only in a legacy concatenated-book domain but out of bounds for that fragment.
- output:
  - create call fails with `400 E_HIGHLIGHT_INVALID_RANGE`.
  - no highlight row is created for the target fragment.

### `python/tests/test_send_message.py`
- Add explicit EPUB quote-to-chat compatibility tests using context type `highlight`.

Required tests:

**test: `test_send_message_with_epub_highlight_context_renders_fragment_based_quote_context`**
- input:
  - ready EPUB fragment + highlight context.
  - send message with `contexts=[{type:"highlight",id}]` while capturing generated LLM request.
- output:
  - response succeeds.
  - rendered prompt/context includes highlight quote and surrounding context derived from the highlighted fragment’s canonical text.
  - no requirement for EPUB-specific context algorithm branches.

**test: `test_send_message_with_epub_highlight_context_is_chapter_local_not_book_global`**
- input:
  - ready EPUB with at least two chapter fragments containing distinct sentinel text.
  - create highlight in chapter `idx=1` and send message with that highlight context.
- output:
  - rendered quote/context includes chapter-1 sentinel text.
  - rendered quote/context excludes chapter-0 (and other chapter) sentinel text.
  - confirms no cross-chapter concatenated-offset behavior.

**test: `test_send_message_with_epub_highlight_context_not_visible_returns_404_e_not_found`**
- input:
  - viewer without visibility to EPUB highlight context target.
- output:
  - request fails with `404 E_NOT_FOUND` (existing masked semantics).

### `python/tests/test_media.py`
- Add explicit EPUB regression guard for existing fragments endpoint compatibility.

Required tests:

**test: `test_get_fragments_epub_ready_returns_all_chapters_ordered_by_idx`**
- input:
  - ready EPUB with contiguous chapter fragments (`idx=0..N-1`).
- output:
  - `/media/{id}/fragments` returns full fragment payload list.
  - rows ordered by `idx ASC`.
  - response fields remain unchanged (`html_sanitized`, `canonical_text` present).

### `python/nexus/services/send_message.py` (explicit no-change boundary + assertions)
- Keep existing S3 context visibility predicate semantics unchanged in PR-06 (approved boundary).
- Do not alter context validation rules in this PR.
- Ensure new tests assert current behavior remains stable for EPUB compatibility flows.

### `python/nexus/services/highlights.py` and `python/nexus/services/context_rendering.py` (explicit no-change boundary + assertions)
- No contract/behavior rewrite in PR-06.
- Compatibility is proven by new EPUB-targeted tests over existing logic.

---

## decision ledger

| question | decision | rationale | fallback/default |
|---|---|---|---|
| Should PR-06 include the attach-query handoff bridge into chat composer flows? | Yes. Implement a minimal compatibility bridge from `attach_type/attach_id` URL params to composer `attachedContexts` on conversations pages. | Without this, the existing media-page quote trigger cannot be proven end-to-end for EPUB highlights despite contract ownership in C7. | If attach params are invalid, ignore them safely and continue without attached contexts. |
| Should PR-06 change S3/S4 context visibility predicate semantics (`can_read_media` -> `can_read_highlight`/annotation-level)? | No. Keep current predicate semantics unchanged in PR-06 and defer hardening to dedicated follow-up. | This is cross-slice auth-policy work with wider blast radius; PR-06 is a compatibility proof PR under C7 scope. | Document deferred hardening item with explicit owner/due; keep regression tests for current behavior. |
| Should PR-06 alter highlight or quote-to-chat API shapes? | No. Preserve existing endpoint/request/response contracts exactly. | L2 `4.7` explicitly requires no shape drift for highlights and quote-to-chat. | Any API evolution requires later L2/L3 revision. |
| Should PR-06 introduce EPUB-specific offset or anchoring rules? | No. Keep canonical `(fragment_id,start_offset,end_offset)` model only. | L2 invariants 6.6-6.8 lock fragment-scoped canonical offsets and canonical_text-derived quote determinism. | EPUB-specific anchor models are out of scope and rejected in this PR. |
| Should PR-06 accept legacy global-book offset behavior inherited from concatenated EPUB rendering models? | No. Explicitly reject global/chapter-crossing offset interpretation and enforce fragment-local offset validation only. | Legacy concatenated-book rendering produced one continuous offset domain; S5 contract requires fragment-local anchors. | Any out-of-range fragment offsets return `400 E_HIGHLIGHT_INVALID_RANGE`. |
| Should `/media/{id}/fragments` behavior be changed for EPUB? | No. Add regression tests only to prove compatibility remains intact. | Contract ownership requires additive compatibility proof, not endpoint redesign. | Future deprecation/migration is explicit later-slice work only. |
| Where should attach-query parsing logic live? | Shared helper module under `apps/web/src/lib/conversations` consumed by both conversation pages. | Centralizes validation/canonicalization behavior and prevents drift between `/conversations` and `/conversations/{id}` paths. | If helper extraction blocks merge, duplicate logic temporarily but keep identical behavior and consolidate before PR close. |
| How should attach params be handled after successful send? | Clear attached contexts and canonicalize URL by removing attach params via `router.replace`. | Prevents repeated stale attachment on refresh/back and keeps URL state truthful after context consumption. | If send fails, retain attached contexts for user retry and do not canonicalize away attach params. |
| Should PR-06 introduce EPUB CSS isolation architecture changes (iframe/shadow DOM/style-stripping) to address legacy style leakage concerns? | No. Keep rendering architecture unchanged in PR-06 and defer styling-isolation work to future scoped reader hardening. | C7 ownership is highlight/chat compatibility reuse; rendering architecture changes are outside PR-06 scope and carry broad UI risk. | Preserve current rendering path and enforce compatibility by tests only. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| Highlight anchoring remains fragment-offset based with no EPUB-specific offset model. | `python/tests/test_highlights.py`, `python/tests/factories.py` | `test_epub_highlight_scopes_to_target_fragment_only`, `test_epub_highlight_exact_prefix_suffix_derived_from_chapter_canonical_text`, `test_epub_highlight_rejects_legacy_global_offsets_as_invalid_range` |
| Existing highlight APIs and behavior apply to EPUB chapter fragments without contract drift. | `python/tests/test_highlights.py`, `python/tests/factories.py` | `test_epub_highlight_scopes_to_target_fragment_only`, `test_epub_highlight_exact_prefix_suffix_derived_from_chapter_canonical_text`, `test_epub_highlight_rejects_legacy_global_offsets_as_invalid_range` |
| Route-bound quote-to-chat attach handoff semantics are preserved for `/conversations` and `/conversations/{id}` without cross-page global target state. | `apps/web/src/lib/conversations/attachedContext.ts`, `apps/web/src/app/(authenticated)/conversations/page.tsx`, `apps/web/src/app/(authenticated)/conversations/[id]/page.tsx`, `apps/web/src/app/(authenticated)/conversations/page.test.tsx`, `apps/web/src/app/(authenticated)/conversations/[id]/page.test.tsx` | `conversations_page_valid_attach_query_preloads_composer_context`, `conversations_page_invalid_attach_query_is_ignored`, `conversations_page_send_includes_attached_context_and_clears_state`, `conversations_page_send_failure_retains_attach_state`, `conversations_page_remove_context_chip_excludes_context_from_send`, `conversation_detail_valid_attach_query_preloads_context_for_target_conversation`, `conversation_detail_invalid_attach_query_is_ignored`, `conversation_detail_send_includes_attached_context_and_clears_after_success`, `conversation_detail_send_failure_retains_attach_state` |
| Quote-to-chat context for EPUB highlights is derived from immutable fragment canonical text via existing context-window semantics. | `apps/web/src/lib/conversations/attachedContext.ts`, `apps/web/src/app/(authenticated)/conversations/page.tsx`, `apps/web/src/app/(authenticated)/conversations/[id]/page.tsx`, `apps/web/src/app/(authenticated)/conversations/page.test.tsx`, `apps/web/src/app/(authenticated)/conversations/[id]/page.test.tsx`, `python/tests/test_send_message.py`, `python/tests/factories.py` | `conversations_page_valid_attach_query_preloads_composer_context`, `conversations_page_invalid_attach_query_is_ignored`, `conversations_page_send_includes_attached_context_and_clears_state`, `conversations_page_send_failure_retains_attach_state`, `conversations_page_remove_context_chip_excludes_context_from_send`, `conversation_detail_valid_attach_query_preloads_context_for_target_conversation`, `conversation_detail_invalid_attach_query_is_ignored`, `conversation_detail_send_includes_attached_context_and_clears_after_success`, `conversation_detail_send_failure_retains_attach_state`, `test_send_message_with_epub_highlight_context_renders_fragment_based_quote_context`, `test_send_message_with_epub_highlight_context_is_chapter_local_not_book_global`, `test_send_message_with_epub_highlight_context_not_visible_returns_404_e_not_found` |
| Existing `/media/{id}/fragments` compatibility remains intact. | `python/tests/test_media.py` | `test_get_fragments_epub_ready_returns_all_chapters_ordered_by_idx` |

---

## acceptance tests

### file: `apps/web/src/lib/conversations/attachedContext.test.ts`

**test: `parse_attach_context_returns_highlight_context_for_valid_query`**
- input: `URLSearchParams("attach_type=highlight&attach_id=<valid_uuid>")`.
- output: returns one context item `{ type: "highlight", id: <valid_uuid> }`.

**test: `parse_attach_context_ignores_invalid_or_unsupported_values`**
- input: malformed UUID, missing `attach_id`, or unsupported `attach_type`.
- output: returns empty context list and no throw.

**test: `strip_attach_params_preserves_unrelated_query_keys`**
- input: attach params plus extra query keys.
- output: attach params removed, extra keys preserved.

### file: `apps/web/src/app/(authenticated)/conversations/page.test.tsx`

**test: `conversations_page_valid_attach_query_preloads_composer_context`**
- input: route query includes valid attach pair.
- output: composer receives attached highlight context and new-chat state is active.

**test: `conversations_page_invalid_attach_query_is_ignored`**
- input: route query includes unsupported attach type or invalid UUID attach_id.
- output: no attached context is passed and page remains usable.

**test: `conversations_page_send_includes_attached_context_and_clears_state`**
- input: valid attached highlight then send success.
- output: send payload includes context; attached state clears and URL is canonicalized.

**test: `conversations_page_send_failure_retains_attach_state`**
- input: valid attached highlight then send fails.
- output: attached context remains and attach params are not removed from URL.

**test: `conversations_page_remove_context_chip_excludes_context_from_send`**
- input: valid attached highlight, user removes chip, then sends.
- output: outgoing send payload has no `contexts` value for removed item.

### file: `apps/web/src/app/(authenticated)/conversations/[id]/page.test.tsx`

**test: `conversation_detail_valid_attach_query_preloads_context_for_target_conversation`**
- input: detail route includes attach pair.
- output: composer for that conversation receives attached highlight context.

**test: `conversation_detail_invalid_attach_query_is_ignored`**
- input: detail route includes unsupported attach type or invalid UUID attach_id.
- output: attached context is not applied and page remains usable.

**test: `conversation_detail_send_includes_attached_context_and_clears_after_success`**
- input: attached context then successful send in existing conversation.
- output: send payload includes context, then context clears and attach params are removed.

**test: `conversation_detail_send_failure_retains_attach_state`**
- input: attached context then send fails in existing conversation.
- output: attached context remains and attach params are not removed from URL.

### file: `python/tests/test_highlights.py`

**test: `test_epub_highlight_scopes_to_target_fragment_only`**
- input: ready EPUB with at least three chapter fragments; create highlight on chapter-1 fragment.
- output: list/get behavior shows highlight bound only to target fragment; chapter-0 and chapter-2 fragments are unaffected.

**test: `test_epub_highlight_exact_prefix_suffix_derived_from_chapter_canonical_text`**
- input: EPUB chapter canonical text with unicode; create highlight with offsets.
- output: response `exact/prefix/suffix` match deterministic canonical-text slicing for that chapter fragment.

**test: `test_epub_highlight_rejects_legacy_global_offsets_as_invalid_range`**
- input: multi-chapter EPUB; create highlight on one chapter using offsets valid only in a legacy book-global domain.
- output: returns `400 E_HIGHLIGHT_INVALID_RANGE` and creates no highlight row.

### file: `python/tests/test_send_message.py`

**test: `test_send_message_with_epub_highlight_context_renders_fragment_based_quote_context`**
- input: send-message call with EPUB highlight context and mocked LLM generate call capture.
- output: prompt/context includes quote + surrounding context derived from highlighted fragment canonical text; response succeeds.

**test: `test_send_message_with_epub_highlight_context_is_chapter_local_not_book_global`**
- input: send-message call with EPUB highlight context where adjacent chapters contain sentinel text.
- output: rendered quote/context includes only target chapter sentinel text and excludes adjacent-chapter sentinel text.

**test: `test_send_message_with_epub_highlight_context_not_visible_returns_404_e_not_found`**
- input: viewer sends message with non-visible EPUB highlight context.
- output: `404 E_NOT_FOUND` with no existence leak.

### file: `python/tests/test_media.py`

**test: `test_get_fragments_epub_ready_returns_all_chapters_ordered_by_idx`**
- input: ready EPUB fixture with contiguous chapter fragments.
- output: `/media/{id}/fragments` returns all chapters in `idx ASC` order and preserves full fragment payload shape.

---

## non-goals
- Does not introduce new highlight, annotation, or chat product features beyond compatibility closure (owned by future slices/PRs).
- Does not alter chapter/TOC endpoint contracts or reader baseline adoption behavior (owned by PR-04/PR-05).
- Does not change S3/S4 context visibility policy semantics; auth-hardening is explicitly deferred.
- Does not perform PR-07-wide acceptance freeze/hardening work.
- Does not introduce EPUB rendering architecture changes (CSS isolation via iframe/shadow DOM or style-stripping pipelines).

---

## constraints
- Only touch files listed in deliverables unless this spec is revised.
- Preserve existing public route shapes and error envelopes for highlights/send-message/fragments.
- Keep route handlers transport-only and service ownership boundaries intact.
- No schema migration is allowed in PR-06.

---

## boundaries (for ai implementers)

**do**:
- implement only C7 compatibility behavior and tests.
- preserve masked-not-found semantics and existing error codes.
- add explicit EPUB-targeted regression tests for each acceptance bullet.
- keep attach-context parsing deterministic and side-effect free.

**do not**:
- introduce EPUB-specific offset models, anchoring schemas, or alternate quote algorithms.
- modify chapter/toc/read lifecycle contracts.
- broaden this PR into auth policy redesign or unrelated UI refactors.
- remove or deprecate `/media/{id}/fragments`.

---

## open questions + temporary defaults

| question | temporary default behavior | owner | due |
|---|---|---|---|
| none | n/a | n/a | n/a |

---

## checklist
- [ ] every l3 acceptance bullet is in traceability matrix
- [ ] every traceability row has at least one test
- [ ] every behavior-changing decision has assertions
- [ ] only scoped files are touched
- [ ] non-goals are explicit and enforced
