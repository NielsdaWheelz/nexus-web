# s5 pr-05 decisions

## status
working decision ledger for `docs/v1/s5/s5_prs/s5_pr05.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | Current media reader path is single-fragment oriented (`fragments[0]`) and cannot satisfy chapter-first EPUB contracts without risking cross-kind regression. | Implement a dual-path reader: EPUB uses chapter manifest + chapter detail APIs; non-EPUB keeps existing fragment path unchanged. | Global migration of all media kinds to chapter APIs; backend shape multiplexing that hides kind-specific contracts. | Preserves L2 compatibility contract for `/fragments` while satisfying C6 EPUB adoption ownership. | Requires integration tests proving EPUB path uses chapter endpoints and non-EPUB path remains fragment-based. | PR-05 implementer | If kind cannot be resolved in a transitional code path, default to existing fragment flow and surface a deterministic client warning. | locked |
| d-002 | Active chapter selection can drift after reload/share/back-forward if state is in-memory only. | Canonicalize active chapter as URL query param `chapter`, with deterministic fallback to first manifest chapter when invalid/missing. | Store active chapter only in React state; store only in localStorage; use TOC node ids instead of canonical chapter idx. | Reinforces deterministic chapter navigation semantics (idx as canonical ordering key) across sessions and links. | Requires tests for invalid query fallback and URL canonicalization via `router.replace`. | PR-05 implementer | Invalid query values never hard-fail; they are normalized to first available chapter idx. | locked |
| d-003 | TOC may be empty or partial by contract; treating it as canonical navigation source would cause brittle reader behavior. | Treat chapter manifest (`idx`) as canonical navigation source and TOC as auxiliary metadata/navigation affordance only. | Build active chapter state primarily from TOC nodes; fail reader when TOC has missing fragment mappings. | Preserves L2 TOC semantics (`nodes=[]` is valid) and guarantees basic navigation independent of TOC completeness. | Requires TOC normalization tests showing mapped vs unmapped behavior and non-blocking empty TOC UX. | PR-05 implementer | Without TOC data, chapter controls continue to operate from manifest only. | locked |
| d-004 | UI currently marks media readable only for `ready` and `ready_for_reading`, which can incorrectly block reading during `embedding`. | Expand UI readable state to `ready_for_reading|embedding|ready` in PR-05 reader gating. | Keep existing two-state check and show not-ready during embedding; fetch anyway while showing stale not-ready banner. | Aligns client gating with backend read contract used by chapter/toc/assets endpoints. | Requires integration test proving embedding status still renders readable chapter path. | PR-05 implementer | If future statuses become readable, maintain a single centralized readable-status constant in the reader module. | locked |
| d-005 | Large books can exceed one chapter-manifest page; naive single-call fetching would silently truncate navigation. | Always walk chapter manifest cursor pages (`limit=200`) until `has_more=false`, with strict cursor-progression checks. | Single request with default limit; assume chapter count <= 200; request arbitrarily huge limit outside contract bounds. | Preserves deterministic chapter coverage for complete navigation across large EPUBs. | Requires pagination walk test and non-advancing cursor safety test. | PR-05 implementer | On pagination contract anomaly, fail fast with deterministic client error instead of infinite loops or partial silent rendering. | locked |
| d-006 | TOC retrieval failures (network/transient backend) can unnecessarily block reading if treated as fatal. | Degrade TOC retrieval failures gracefully: keep chapter reading path active with empty/disabled TOC state and non-blocking warning. | Hard-fail reader on TOC fetch failure; retry loop that blocks render until TOC succeeds. | Maintains baseline reading availability while still exposing TOC quality issues to users/operators. | Requires integration test for TOC fetch failure or empty result preserving readable chapter content. | PR-05 implementer | Default TOC state is empty tree; reading controls remain enabled. | locked |
| d-007 | Highlight interactions are fragment-scoped; chapter switches can leave stale focus/selection state bound to old fragment ids. | On chapter switch, clear selection/focus/edit state before loading/refetching highlights for the new chapter fragment id. | Persist focused highlight across chapter switch; attempt cross-chapter highlight reconciliation. | Preserves fragment-bound highlight invariants and avoids cross-chapter interaction corruption. | Requires chapter-switch test asserting highlight fetch target updates and stale focus is cleared. | PR-05 implementer | If highlight refetch fails, chapter content still renders and highlight pane shows recoverable error/empty state. | locked |
| d-008 | Reader code in `page.tsx` is already large; embedding all EPUB orchestration logic directly increases regression risk and weakens testability. | Extract EPUB orchestration into `apps/web/src/lib/media/epubReader.ts` with pure/testable helpers and keep page component as composition layer. | Keep all orchestration inline in page component; add only snapshot tests without unit seams. | Improves long-term maintainability and enables deterministic unit tests for pagination/query/TOC normalization logic. | Requires dedicated `epubReader.test.ts` with pure logic assertions independent of DOM rendering. | PR-05 implementer | If extraction must be staged, keep helper API stable and move one orchestration concern at a time with test parity. | locked |
| d-009 | Loading all chapter detail payloads on initial open would recreate legacy whole-book rendering performance risks for large EPUBs. | Restrict PR-05 to one active chapter-detail payload at a time; no eager all-chapter `/chapters/{idx}` prefetch. | Fetch all chapter details up front; pre-render entire book DOM at initial load. | Protects baseline reader responsiveness and memory profile while preserving chapter-first navigation. | Requires explicit integration test asserting only active chapter-detail fetch occurs on initial load. | PR-05 implementer | Any future adjacent-chapter prefetch requires explicit perf budget and L2/L3 scope revision. | locked |
| d-010 | Rapid chapter switching can produce out-of-order chapter and highlight responses that overwrite newer active state. | Add stale-response guards for both chapter payload and highlight requests (request cancellation or monotonic request-version gating). | Last-response-wins without request identity checks; serialize UI on each request and block navigation. | Preserves deterministic active-chapter render and highlight binding under concurrent user actions/network jitter. | Requires race tests where older chapter/highlight responses resolve later and are ignored. | PR-05 implementer | If cancellation API is unavailable, ignore payloads whose request version is older than current selection/version token. | locked |
| d-011 | Legacy EPUB behavior noted CSS leakage risk, but PR-05 ownership is UI adoption, not new sanitization architecture. | Keep chapter rendering strictly on backend `html_sanitized` contract and existing renderer path; defer iframe/shadow-DOM or client rewrite layers. | Introduce ad-hoc client-side stripping/rewriting of style/link tags; parallel sanitization logic in browser. | Avoids split-brain HTML safety policy and keeps C6 scope bounded to baseline navigation adoption. | Requires test asserting chapter render path consumes server-sanitized payload without extra client rewrite stage. | PR-05 implementer | Capture severe style leakage as follow-up hardening item; do not patch with ad-hoc runtime rewrites in PR-05. | locked |
| d-012 | User-initiated chapter navigation and automatic URL canonicalization need different history semantics to avoid broken back/forward UX or noisy history stacks. | Use `router.push` for explicit user chapter changes and `router.replace` for automatic invalid/missing-param canonicalization. | Use `replace` for all updates (loses user history) or `push` for all updates (adds noisy normalization entries). | Preserves deterministic deep-link canonicalization while retaining expected browser history behavior for reader navigation. | Requires explicit test asserting push-vs-replace behavior by event source. | PR-05 implementer | If action source is ambiguous, treat programmatic correction paths as replace and direct UI navigation as push. | locked |
| d-013 | Chapter-detail fetch can fail after manifest resolution during retry/re-extract races, causing ambiguous recovery behavior. | Adopt deterministic chapter-fetch recovery matrix: `E_CHAPTER_NOT_FOUND` -> one manifest re-sync + re-resolve + one retry; `E_MEDIA_NOT_READY` -> processing gate; `E_MEDIA_NOT_FOUND` -> masked not-found state. | Show generic error for all chapter-fetch failures; infinite retry loops on chapter not found. | Keeps reader behavior deterministic and resilient under transient lifecycle races without redefining backend contracts. | Requires dedicated tests for each recovery branch and URL canonicalization on reconciliation. | PR-05 implementer | Unknown/non-contract failures use deterministic error UI and keep last known safe state without unsafe mutation. | locked |

## notes
- d-001 through d-013 are aligned to PR-05 L3 acceptance and C6 ownership boundaries.
- No backend contract decisions are introduced in PR-05; all endpoint semantics remain owned by PR-04.
