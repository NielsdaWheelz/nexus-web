# s5 pr-02 decisions

## status
working decision ledger for `docs/v1/s5/s5_prs/s5_pr02.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | PR-02 has no existing EPUB extractor in merged code and can be implemented either via Node subprocess or Python-native parser pipeline. | Implement Python-native extraction domain service (`python/nexus/services/epub_ingest.py`) and keep EPUB extraction in backend runtime; no Node subprocess extractor for EPUB. | Reuse/extend Node ingest subprocess model for EPUB parsing; split parser logic across runtimes. | Improves deterministic behavior, operability, and security control under one runtime/toolchain. | Requires deterministic unit/integration tests around Python service seams instead of process-wrapper tests. | slice owner + PR-02 implementer | If one parser gap emerges, add bounded Python-side adapter while keeping single-runtime contract. | locked |
| d-002 | Ownership boundary between C3 extraction and C4 ingest/retry orchestration can drift without explicit contract split. | PR-02 owns artifact executor and extraction-local classification only; PR-03 owns endpoint semantics, state-transition policy, and retry orchestration behavior. | Let PR-02 redefine `/ingest` response/status semantics or retry gating behavior. | Preserves roadmap ownership and keeps lifecycle policy isolated to PR-03. | PR-02 tests assert artifact correctness and extraction classification only; endpoint/state-machine tests remain PR-03 scope. | slice owner + PR-02/03 implementers | If minimal wiring is required, expose neutral return types and defer mapping to PR-03. | locked |
| d-003 | TOC `node_id` can be unstable across parser/source variants if copied directly from source nav ids. | Generate deterministic parse-path `node_id` (`nav-id -> href -> label slug`, sibling disambiguation, hierarchical path composition, deterministic length cap handling). | Persist raw nav ids only; generate random UUID node ids; href-only identity. | Stabilizes `primary_toc_node_id` and TOC identity determinism independent of parser implementation details. | Adds deterministic replay test asserting stable `node_id` + `order_key` outputs for equivalent bytes. | PR-02 implementer | If source ids are consistently stable for a subset, still apply canonical generation for uniformity. | locked |
| d-004 | Extraction failures can leave partial artifacts if writes are committed incrementally. | Enforce all-or-nothing transaction for artifact persistence (`fragments`, `fragment_blocks`, `epub_toc_nodes`, title update). | Progressive commits per chapter; best-effort cleanup after failure. | Protects mixed-generation prohibition and supports reliable retry/reset semantics. | Requires atomicity regression test that forces failure pre-commit and asserts zero persisted artifacts. | PR-02 implementer | Future staged pipelines require explicit generation-version contract (out of S5 scope). | locked |
| d-005 | Archive-safety enforcement point is ambiguous between upload-confirm and extraction executor. | PR-02 enforces archive safety in extractor hard-gate before artifact materialization and classifies as `E_ARCHIVE_UNSAFE`; PR-03 handles endpoint/state implications. | Best-effort warnings; defer all safety checks to PR-03 endpoint path. | Guarantees C3 artifact pipeline never processes unsafe archives and preserves deterministic error classification. | Requires unsafe-fixture tests for traversal/limit violations with no persisted artifacts. | PR-02 implementer | Operator-configurable values may be tightened only; L2 floor is minimum. | locked |
| d-006 | Missing TOC and unresolved internal assets are common in real EPUBs and may be treated inconsistently as fatal/non-fatal. | Missing/unusable TOC and unresolved internal resources are non-fatal if readable chapter extraction succeeds; persist empty TOC and degraded-safe HTML. | Fail extraction on TOC absence or unresolved assets. | Preserves resilient ingestion and aligns with L2 non-fatal degradation requirements. | Adds explicit success tests for no-TOC and unresolved-resource cases. | PR-02 implementer | If sanitization detects active-content risk, fail that content path while preserving safety guarantees. | locked |
| d-007 | Title fallback can drift across parser implementations without normalization constraints. | Persist title using deterministic priority (`dc:title -> title -> filename -> Untitled EPUB`) with trim/whitespace-collapse/non-empty enforcement/truncate(255). | Keep provisional upload title; parser-specific fallback only; no normalization. | Locks invariant 6.12 and avoids downstream UX/data drift. | Adds title fallback tests covering metadata-missing and unusable-filename paths. | PR-02 implementer | If OPF field extraction varies by parser, apply same fallback/normalization after parser output normalization. | locked |
| d-008 | Archive-safety limits can drift if hardcoded in service code or loosely configured per environment. | Define all five archive-safety limits as `Settings` keys with L2 defaults and enforce minimum-floor validation (strict allowed, weaker rejected). | Hardcode limits in extractor; allow unrestricted env overrides. | Preserves invariant 6.15 security floor while enabling enterprise operations tightening without contract drift. | Adds config validation tests for defaults, strict overrides, and weaker-value rejection. | PR-02 implementer + platform owner | If an emergency operational override is required, only allow stricter values until L2 is formally revised. | locked |
| d-009 | Choosing an EPUB parsing library can introduce hidden parser heuristics and dependency drift that undermine deterministic contracts. | Implement internal parser flow with `zipfile` + `lxml` for OPF/spine/nav/NCX extraction; do not add external EPUB framework dependency in PR-02. | Add `ebooklib`/equivalent dependency and rely on framework-specific parsing behavior. | Keeps parsing semantics explicit and reproducible, reducing long-term operational and security risk while preserving deterministic extraction guarantees. | Requires fixture coverage across EPUB2 (NCX) and EPUB3 (nav) variants under the same deterministic contract. | PR-02 implementer | If a specific unsupported EPUB edge case emerges, add a bounded adapter while preserving executor contract and test determinism. | locked |
| d-010 | Resource rewrite contract was incomplete without a canonical retrieval surface for rewritten internal asset URLs. | Implement canonical asset endpoint contract in PR-02: `GET /media/{media_id}/assets/{asset_key}` with visibility masking and no private storage URL exposure; derive `asset_key` from normalized internal path (fragment stripped) with deterministic collision disambiguation. | Defer asset retrieval to ad-hoc signed URLs; leave path format implementation-defined. | Completes resource rewrite determinism and closes ownership gap for C3 asset behavior. | Adds route/service tests for success, masking, kind guard, and ready-state guard; adds rewrite assertions for fragment-insensitive mapping and deterministic collision behavior. | slice owner + PR-02 implementer | If endpoint wiring is blocked, PR-02 cannot be accepted as complete because rewritten URLs would have undefined retrieval semantics. | locked |
| d-011 | Executor failure outputs were ambiguous for non-archive extraction failures. | Enforce explicit classification matrix: sanitization/canonicalization failures -> `E_SANITIZATION_FAILED`; structural parse/extraction failures -> `E_INGEST_FAILED`; archive safety violations -> `E_ARCHIVE_UNSAFE`. | Collapse all failures to `E_INGEST_FAILED`; infer classes only in PR-03 orchestration layer. | Keeps extraction output deterministic and prevents downstream taxonomy drift across orchestration paths. | Adds failure-matrix tests with deterministic seams for each class. | PR-02 implementer | Unexpected/unclassified failures default to `E_INGEST_FAILED` after safe message truncation/redaction. | locked |

## notes
- d-001, d-002, d-003, d-008, d-009, and d-010 were explicitly user-approved during PR-02 authoring.
- d-011 is a deterministic downstream contract clarification derived from existing L2 error taxonomy.
- No unresolved decision remains for PR-02 scope.
