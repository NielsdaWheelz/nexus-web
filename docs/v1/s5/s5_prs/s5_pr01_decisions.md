# s5 pr-01 decisions

## status
working decision ledger for `docs/v1/s5/s5_prs/s5_pr01.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | L3 PR-01 ownership references previously included downstream behavior sections (`2.3` payload shapes and `6.14` pagination invariant). | PR-01 is explicitly limited to C1+C2 foundations: TOC persistence schema and error primitive registration only; C2 source sections are restricted to section `5`. | Implement endpoint/pagination behavior contracts in PR-01; split behavior ownership across PR-01/PR-04. | Prevents ownership overlap and hidden dependencies; preserves one-cluster/one-owner rule. | Traceability matrix for PR-01 includes only schema and error mapping tests. | slice owner + PR-01 implementer | If compile scaffolding for payload types is unavoidable, keep it private/non-contractual and remove before PR-04 freeze. | locked |
| d-002 | `order_key` format is normative in L2 semantics but not enforced by DDL snippet alone. | Add DB-level format check `ck_epub_toc_nodes_order_key_format` enforcing `dddd(.dddd)*`. | Rely on parser discipline only; validate format only in service layer. | Strengthens deterministic ordering invariant as persisted data contract, not best-effort behavior. | Add explicit valid/invalid order-key migration tests with named-constraint assertion. | PR-01 implementer | If regex expression needs engine-safe adjustment, keep equivalent strict matcher semantics and same constraint name. | locked |
| d-003 | Adding `epub_toc_nodes` migration without ORM registration can cause code/DB contract drift. | Include `EpubTocNode` ORM model + db module exports in PR-01. | Defer ORM model to PR-02; use raw SQL until extraction PR lands. | Keeps merged-state schema representation synchronized and reviewable. | No direct runtime behavior tests required beyond migration contract; schema import checks rely on existing test suite. | PR-01 implementer | If relationship surface introduces complexity, keep minimal model fields and defer optional relations. | locked |
| d-004 | S5 error codes are used across multiple later PRs; late registration risks inconsistent temporary error taxonomies. | Register S5 error enums and status map in PR-01 (`E_RETRY_INVALID_STATE`, `E_RETRY_NOT_ALLOWED`, `E_CHAPTER_NOT_FOUND`, `E_ARCHIVE_UNSAFE`). | Defer code registration until route implementation PRs; use ad-hoc interim codes. | Establishes canonical platform taxonomy before behavioral rollout. | Extend existing `test_error_code_maps_to_correct_status` table with S5 rows. | PR-01 implementer | If any code is unused immediately, keep it registered with stable mapping and document downstream owner PR. | locked |
| d-005 | Self-referential ORM relationship choices can introduce inconsistent implementations across branches. | Do not add `EpubTocNode` self-parent/children ORM relationships in PR-01; keep only columns/FKs and `media` relation. | Add parent/children ORM relationships now; perform recursive ORM loading in this PR. | Keeps PR-01 focused on schema contract and prevents premature graph behavior assumptions. | No tree-construction tests in PR-01; tree behavior remains covered in PR-04 endpoint/service tests. | PR-01 implementer | If future performance requires ORM graph traversal, add it in PR-04+ with explicit contract tests. | locked |
| d-006 | Revision-specific migration assertions can become flaky when using shared head-migrated fixtures. | S5 migration tests must self-manage revision state (`base -> 0007 -> 0008/head`) per class/test path and restore head after teardown. | Reuse broad `migrated_engine` fixture with pre-upgraded head state only. | Strengthens deterministic migration correctness proof for `0008` introduction path and prevents cross-suite ordering side effects. | Add/structure `TestS5Migration0008` tests with explicit revision transitions and teardown restoration to head. | PR-01 implementer | Shared helper wrappers allowed only if they preserve explicit revision transitions and head restoration in each test flow. | locked |

## notes
- Decisions d-001 and d-002 were explicitly user-approved during PR-01 L4 authoring.
- Decisions d-005 and d-006 were explicitly user-approved during PR-01 L4 authoring.
- No unresolved decision remains for PR-01 scope.
