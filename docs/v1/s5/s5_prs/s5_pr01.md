# pr-01: s5 contract primitives (schema + error surface)

## goal
Land the Slice 5 foundational contracts by adding `epub_toc_nodes` storage semantics and registering S5 error primitives with stable status mappings.

## context
- Current migration head is `0007` (`migrations/alembic/versions/0007_slice4_library_sharing.py`).
- `media` and `fragments` already exist and are the valid FK anchors for S5 TOC linkage.
- `python/nexus/errors.py` is the single source of truth for API error code registry and HTTP status mapping.
- `python/tests/test_migrations.py` and `python/tests/test_errors.py` already enforce migration and error mapping contracts.
- L3 ownership scope for PR-01 is limited to C1+C2 in `docs/v1/s5/s5_roadmap.md` and `docs/v1/s5/s5_roadmap_ownership.md`.

## dependencies
- none.

---

## deliverables

### `migrations/alembic/versions/0008_slice5_epub_toc_nodes.py`
- Create revision:
  - `revision = "0008"`
  - `down_revision = "0007"`
- Create table `epub_toc_nodes` with exact structural contract from `docs/v1/s5/s5_spec.md` section 2.2:
  - columns: `media_id`, `node_id`, `parent_node_id`, `label`, `href`, `fragment_idx`, `depth`, `order_key`, `created_at`
  - primary key: `(media_id, node_id)`
  - check constraints:
    - `ck_epub_toc_nodes_node_id_nonempty`
    - `ck_epub_toc_nodes_parent_nonself`
    - `ck_epub_toc_nodes_label_nonempty`
    - `ck_epub_toc_nodes_depth_range`
    - `ck_epub_toc_nodes_fragment_idx_nonneg`
    - `ck_epub_toc_nodes_order_key_format` enforcing `dddd(.dddd)*` format
  - foreign keys:
    - `fk_epub_toc_nodes_parent` on `(media_id, parent_node_id)` -> `epub_toc_nodes(media_id, node_id)` with `ON DELETE CASCADE`
    - `fk_epub_toc_nodes_fragment` on `(media_id, fragment_idx)` -> `fragments(media_id, idx)` with `ON DELETE CASCADE DEFERRABLE INITIALLY DEFERRED`
- Create indexes:
  - unique index `uix_epub_toc_nodes_media_order` on `(media_id, order_key)`
  - index `idx_epub_toc_nodes_media_fragment` on `(media_id, fragment_idx)`
- Downgrade drops indexes and table in reverse dependency-safe order.

### `python/nexus/db/models.py`
- Add ORM model `EpubTocNode` mapped to `epub_toc_nodes`.
- Keep model contract aligned with migration constraints and names.
- Add explicit `CheckConstraint` for `order_key` format to mirror DB contract.
- Add minimal relationship surface only:
  - `media` -> `Media`
  - no self-referential ORM parent/children relationship in PR-01
  - no additional service logic.
- Do not add extraction/read API behavior in model layer.

### `python/nexus/db/__init__.py`
- Export `EpubTocNode` in import list and `__all__`.

### `python/nexus/errors.py`
- Add error enums:
  - `E_RETRY_INVALID_STATE`
  - `E_RETRY_NOT_ALLOWED`
  - `E_CHAPTER_NOT_FOUND`
  - `E_ARCHIVE_UNSAFE`
- Add `ERROR_CODE_TO_STATUS` mappings:
  - `E_RETRY_INVALID_STATE -> 409`
  - `E_RETRY_NOT_ALLOWED -> 409`
  - `E_CHAPTER_NOT_FOUND -> 404`
  - `E_ARCHIVE_UNSAFE -> 400`
- Do not change semantics of existing error codes.

### `python/tests/test_migrations.py`
- Add S5 migration-focused tests under `TestS5Migration0008` with revision-scoped orchestration.
- Required orchestration for each S5 migration test:
  - self-manage migration state (`downgrade base -> upgrade 0007 -> setup fixtures -> upgrade 0008/head` as required)
  - do not rely on `migrated_engine` module fixture for S5 revision-specific assertions
  - clean up by downgrading to base and restoring `head` at test/class teardown.
- Required tests:

**test: `test_0008_epub_toc_nodes_table_and_indexes_exist`**
- input:
  - upgrade to `head`
  - query metadata/index catalogs
- output:
  - table `epub_toc_nodes` exists
  - indexes `uix_epub_toc_nodes_media_order`, `idx_epub_toc_nodes_media_fragment` exist

**test: `test_0008_epub_toc_nodes_constraints_enforced`**
- input:
  - create fixture `users`, `media(kind='epub')`, `fragments(media_id, idx)` row
  - attempt invalid inserts violating each key check/fk contract
- output:
  - invalid inserts fail with expected constraint names

**test: `test_0008_order_key_format_constraint`**
- input:
  - insert valid keys (`0001`, `0001.0002`, `0010.0001.0003`)
  - insert invalid keys (`1`, `0001.2`, `0001.000A`, `.0001`, `0001.`)
- output:
  - valid keys succeed
  - invalid keys fail on `ck_epub_toc_nodes_order_key_format`

**test: `test_0008_unique_media_order_key_enforced`**
- input:
  - same `media_id`, duplicate `order_key` across different `node_id`
- output:
  - duplicate rejected by `uix_epub_toc_nodes_media_order`

### `python/tests/test_errors.py`
- Extend `TestErrorCodeToStatus.test_error_code_maps_to_correct_status` with S5 mappings:
  - `E_RETRY_INVALID_STATE -> 409`
  - `E_RETRY_NOT_ALLOWED -> 409`
  - `E_CHAPTER_NOT_FOUND -> 404`
  - `E_ARCHIVE_UNSAFE -> 400`
- Keep existing test structure and all prior assertions intact.

---

## decision ledger

| question | decision | rationale | fallback/default |
|---|---|---|---|
| Should `order_key` format be application-enforced only or DB-enforced in PR-01? | Enforce at DB layer with named check constraint `ck_epub_toc_nodes_order_key_format`. | Deterministic TOC ordering is a persisted data invariant; DB guard prevents silent parser/service drift and cross-path contract violations. | If regex portability requires adjustment, keep named constraint and equivalent strict matcher semantics in migration + tests. |
| Should PR-01 include any endpoint payload/type implementation from L2 section 2.3? | No. PR-01 excludes endpoint behavior and payload shaping. | L3 ownership maps endpoint behavior to PR-04; including 2.3 implementation here creates hidden dependency and review ambiguity. | If a type scaffold is unavoidable for compile reasons, keep it private and non-exported with no contract guarantees. |
| Should PR-01 include extraction/retry state-machine behavior? | No. Only schema and error primitive registration. | Keeps PR-01 merge-safe and dependency-clean for PR-02/PR-03 consumers. | Any discovered behavior need is deferred to owning PR per roadmap ownership ledger. |
| Should PR-01 add self-referential ORM relationships for TOC hierarchy? | No. Persist hierarchy fields only; build tree semantics in PR-04 service/query layer. | Prevents premature ORM graph complexity and keeps PR-01 data-contract focused. | If later needed for performance, introduce in owning behavior PR with dedicated tests. |
| How strict should S5 migration test orchestration be for revision proofs? | Use revision-scoped self-managed migration flow in each S5 migration test class. | Prevents false positives from shared migrated fixtures and ensures deterministic `0007 -> 0008` contract verification. | If shared helpers are introduced, they must still enforce explicit revision transitions per test. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| `epub_toc_nodes` schema constraints and deterministic ordering storage rules are available. | `migrations/alembic/versions/0008_slice5_epub_toc_nodes.py`, `python/nexus/db/models.py`, `python/nexus/db/__init__.py` | `test_0008_epub_toc_nodes_table_and_indexes_exist`, `test_0008_epub_toc_nodes_constraints_enforced`, `test_0008_order_key_format_constraint`, `test_0008_unique_media_order_key_enforced` |
| S5-specific error/status mappings are defined in the platform error model. | `python/nexus/errors.py` | `TestErrorCodeToStatus.test_error_code_maps_to_correct_status` (S5 cases) |

---

## acceptance tests

### file: `python/tests/test_migrations.py`

**test: `test_0008_epub_toc_nodes_table_and_indexes_exist`**
- input: upgrade to `head`; inspect `information_schema.tables` and `pg_indexes`.
- output: table exists; required indexes exist exactly by name.

**test: `test_0008_epub_toc_nodes_constraints_enforced`**
- input: fixture media/fragment rows and attempted invalid inserts for `node_id`, `label`, `depth`, `fragment_idx`, parent/fk semantics.
- output: each invalid insert fails with corresponding named constraint/fk.

**test: `test_0008_order_key_format_constraint`**
- input: insert representative valid and invalid `order_key` values.
- output: valid keys succeed; invalid keys fail with `ck_epub_toc_nodes_order_key_format`.

**test: `test_0008_unique_media_order_key_enforced`**
- input: insert duplicate `order_key` within same `media_id`.
- output: conflict rejected by `uix_epub_toc_nodes_media_order`.

### file: `python/tests/test_errors.py`

**test: `TestErrorCodeToStatus.test_error_code_maps_to_correct_status`**
- input: S5 error enums (`E_RETRY_INVALID_STATE`, `E_RETRY_NOT_ALLOWED`, `E_CHAPTER_NOT_FOUND`, `E_ARCHIVE_UNSAFE`).
- output: mapped statuses are `409`, `409`, `404`, `400` respectively.

---

## non-goals
- Does not implement EPUB extraction behavior (PR-02).
- Does not implement upload-init/ingest/retry endpoint behavior (PR-03).
- Does not implement chapter/TOC read endpoints or BFF transport (PR-04).
- Does not modify reader UX or highlight/chat behavior (PR-05/PR-06).

---

## constraints
- Only touch files listed in deliverables unless this spec is revised.
- Follow established alembic/model/error/test patterns already used in S4 PR-01.
- No public API behavior changes outside error registry additions.

---

## boundaries (for ai implementers)

**do**:
- Implement only storage + error primitive contract surfaces.
- Keep constraint and index names stable and explicit.
- Add tests for every behavior-changing decision.

**do not**:
- Add extraction, retry orchestration, or endpoint routing logic.
- Introduce L4 detail for future PR behavior.
- Modify unrelated migrations or reshape existing API contracts.

---

## open questions + temporary defaults

| question | temporary default behavior | owner | due |
|---|---|---|---|
| none | n/a | n/a | n/a |

---

## checklist
- [ ] every l3 acceptance bullet is in traceability matrix
- [ ] every traceability row has at least one test
- [ ] every behavior-changing decision has assertions
- [ ] only scoped files are touched
- [ ] non-goals are explicit and enforced
