# s5 pr-03 decisions

## status
working decision ledger for `docs/v1/s5/s5_prs/s5_pr03.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | `/media/{id}/ingest` must be scalable but also return deterministic validation failures at request time. | Keep extraction async via `ingest_epub`; add synchronous EPUB preflight gate (storage/type/size/archive-safety) before dispatch. | Run full extraction synchronously in API; defer all validation to async worker and return only accepted/queued responses. | Preserves lifecycle determinism and contract-level error semantics without request-path extraction latency. | Requires explicit tests for archive-unsafe fast-fail and no-dispatch assertions. | PR-03 implementer | In test/internal mode, allow non-enqueued execution path while preserving identical response/error envelope semantics. | locked |
| d-002 | Archive-safety policy can drift if PR-03 duplicates thresholds/logic from PR-02. | Expose and consume one shared archive-safety validator seam in `epub_ingest`; preflight and executor call the same validator. | Duplicate archive checks in `epub_lifecycle` or `upload` modules. | Keeps `E_ARCHIVE_UNSAFE` classification and thresholds consistent across all orchestration paths. | Requires seam-level and endpoint-level tests proving identical unsafe classification outcomes. | PR-02/03 boundary owners | If seam extraction is blocked, update PR-02 first; PR-03 cannot ship with duplicated archive policy logic. | locked |
| d-003 | Lifecycle policy is currently entangled with upload-confirm primitives and risks future maintainability drift. | Introduce `epub_lifecycle` service as C4 orchestration owner; routes call it directly. | Keep all PR-03 logic inside `upload.py`; put lifecycle policy inside routes. | Reinforces ownership boundaries (C3 vs C4), reduces coupling, and keeps route layer transport-only. | Requires route-structure and orchestration tests that assert service-owned lifecycle behavior. | PR-03 implementer | Temporary wrappers in `upload.py` allowed only during migration; final PR-03 state must centralize lifecycle in `epub_lifecycle`. | locked |
| d-004 | PR-02 added strict ingest response-key regression `{media_id, duplicate}` that conflicts with PR-03 contract extension. | Replace strict-key assertion with compatibility semantics test: legacy keys remain stable while new fields (`processing_status`, `ingest_enqueued`) are added. | Keep strict key equality and violate L2 PR-03 response contract; break legacy semantics. | Preserves backward compatibility and enables required PR-03 response shape evolution. | Requires updated ingest response tests asserting both extended shape and legacy-client compatibility. | PR-03 implementer | If compatibility risk appears, gate roll-out behind additive fields only; never remove legacy keys. | locked |
| d-005 | Retry reset references chunk/embedding cleanup, but some deployments may not have those stores implemented. | Implement strict-by-contract, idempotent-by-implementation cleanup: always clear extraction artifacts and attempt chunk/embedding cleanup with safe no-op tolerance when stores are absent. | Ignore chunk/embedding cleanup entirely; hard-fail retry when optional stores are absent. | Preserves invariant 6.10 without deployment-coupled fragility. | Requires retry reset tests for extraction artifacts and no-failure behavior when optional cleanup targets are unavailable. | PR-03 implementer + platform owner | When chunk/embedding stores are introduced, extend cleanup helper without changing endpoint contracts. | locked |
| d-006 | Terminal archive failures require explicit policy to avoid invalid in-row retries. | Enforce terminal block: failed EPUB with `last_error_code='E_ARCHIVE_UNSAFE'` returns `409 E_RETRY_NOT_ALLOWED` with no mutation or dispatch. | Permit retry for all failed states; remap archive failures to generic retry flow. | Preserves invariant 6.16 and prevents unimplementable in-row remediation behavior. | Requires dedicated terminal-retry test asserting no state changes and no dispatch call. | PR-03 implementer | Remediation remains fresh upload to a new media row. | locked |
| d-007 | Async lifecycle completion can drift if API/service and worker both mutate end-state transitions after dispatch. | Make `ingest_epub` task the authoritative completion-state owner for async EPUB runs (`extracting -> ready_for_reading|failed`), while service layer owns entry transitions and dispatch only. | Let service poll/executor-return path own completion transitions; allow mixed ownership between task and service. | Preserves deterministic state-machine behavior across async boundaries and avoids split-brain lifecycle mutations. | Requires task-lifecycle tests for success transition, failure transition, and idempotent no-op behavior when media is missing/non-extracting. | PR-03 implementer | Any sync/internal path must call the same completion-mapping helper used by task code. | locked |
| d-008 | Queue-dispatch failures can leave media stuck in `extracting` if lifecycle state is mutated before enqueue attempt. | Treat enqueue failure as transactional failure: rollback/undo pre-dispatch lifecycle mutation and return deterministic server error; never report successful enqueue on dispatch failure. | Soft-fail enqueue and keep `extracting`; return success with `ingest_enqueued=false` for queue outages. | Prevents false-positive accepted jobs and stuck lifecycle states; preserves state-machine integrity and operational observability. | Requires ingest/retry dispatch-failure tests asserting rollback/no stuck transitions. | PR-03 implementer | `ingest_enqueued=false` is valid for idempotent non-dispatch snapshots or explicit sync/internal mode, not dispatch errors. | locked |
| d-009 | Retry can become destructive if artifacts are deleted before verifying original EPUB source availability/integrity. | Add source-integrity precondition before retry cleanup/reset: missing/invalid source fails fast with deterministic error and no mutation/dispatch (including hash mismatch mapped to `E_STORAGE_MISSING`). | Cleanup first and fail later when extraction cannot read source. | Prevents irreversible state loss and supports safe operational recovery under storage drift/corruption. | Requires retry precondition-failure test asserting no cleanup/state mutation/dispatch; plus source-identity immutability assertion on successful retry. | PR-03 implementer | Caller remediates source (or re-uploads) before retry can proceed. | locked |
| d-010 | Repeated `/media/{id}/ingest` calls can cause duplicate dispatches and invalid attempt inflation if lifecycle re-entry is unspecified. | Treat post-dispatch `/ingest` as idempotent snapshot behavior for non-duplicate rows not in `pending`: no redispatch, `ingest_enqueued=false`, no attempt increment. | Re-dispatch extraction from non-pending states; throw ad-hoc errors for repeats. | Prevents duplicate work and illegal transitions during client retries and race conditions. | Requires explicit repeat-ingest idempotency test with dispatch call-count and attempt-count assertions. | PR-03 implementer | Failed rows continue to use `/retry` for remediation path (subject to terminal guard). | locked |
| d-011 | Filename-extension fallback for EPUB detection weakens trust boundary and can permit spoofed inputs. | Keep MIME+magic-byte validation authoritative; extension remains non-authoritative metadata only. | Accept extension fallback classification when bytes do not match EPUB. | Preserves byte-trust security model and avoids extension spoofing regressions. | Requires EPUB spoofed-payload regression test (`.epub` name but invalid magic -> `E_INVALID_FILE_TYPE`). | PR-03 implementer | Extension-only mismatch continues to fail as `E_INVALID_FILE_TYPE`. | locked |

## notes
- d-001, d-002, and d-003 were explicitly user-approved during PR-03 authoring.
- d-007 was explicitly user-approved during PR-03 authoring.
- d-008 was explicitly user-approved during PR-03 authoring.
- d-009, d-010, and d-011 were approved during old-spec integration hardening.
- No unresolved decision remains for PR-03 scope.
