# s5 pr-06 decisions

## status
working decision ledger for `docs/v1/s5/s5_prs/s5_pr06.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | Quote-to-chat trigger from media reader already navigates with `attach_type/attach_id`, but conversations pages do not currently consume it, so end-to-end C7 compatibility is incomplete. | Implement attach-query bridge on both `/conversations` and `/conversations/{id}` to preload composer `attachedContexts` from URL state. | Leave attach params unused; add cross-page global chat draft state. | Preserves C7 compatibility intent without changing API contracts or ownership boundaries. | Requires route-level tests proving attach query preload on both conversation routes. | PR-06 implementer | Invalid/missing attach params are ignored and chat pages remain usable. | locked |
| d-002 | Attach query parsing can drift across two conversation routes if done inline. | Add shared helper module `apps/web/src/lib/conversations/attachedContext.ts` for parse + canonicalization logic. | Duplicate parser logic in both page components. | Keeps deterministic attach behavior consistent across both routes. | Requires dedicated helper unit tests for parse and strip semantics. | PR-06 implementer | If helper extraction blocks, temporary duplication is allowed only if behavior stays byte-for-byte equivalent and is consolidated before PR close. | locked |
| d-003 | Attach parsing must be strict enough to prevent malformed context injection while preserving graceful UX. | Support `attach_type=highlight` only in v1 and require valid UUID `attach_id`; ignore unsupported/invalid values without throwing. | Accept arbitrary context types from URL; hard-fail page rendering on malformed attach params. | Reinforces invariants 6.6-6.8 by keeping attached contexts aligned with existing highlight contract. | Requires invalid-query tests on both conversation routes. | PR-06 implementer | On parse failure, no context is attached and no URL mutation is performed. | locked |
| d-004 | Attach lifecycle after send can create stale/replayed context if URL or local state is not normalized. | On successful send, clear attached contexts and remove `attach_type/attach_id` via `router.replace`; on send failure, retain attach context for retry and keep URL unchanged. | Always clear context regardless of send result; keep attach params after successful send. | Preserves deterministic one-time attach consumption while preventing accidental repeated sends after success. | Requires success-path canonicalization test and failure-path retention test. | PR-06 implementer | If send response is ambiguous, default to retention (no clear/canonicalize) until success is confirmed. | locked |
| d-005 | Route targeting semantics for quote-to-chat were previously defined in S3 and must not regress. | Keep route-determined attach target semantics; do not introduce global "focused conversation" state. | Add implicit global active-conversation target across routes. | Preserves S3 binding behavior and avoids cross-page hidden state coupling. | Requires tests proving `/conversations` opens new-chat attach path and `/conversations/{id}` attaches to current thread only. | PR-06 implementer | If route context is unavailable, default to current page semantics and no global fallback memory. | locked |
| d-006 | PR-06 could accidentally expand into auth-policy redesign in send-message context visibility. | Keep existing `_validate_context_visibility` media-level gate unchanged in PR-06; defer predicate migration hardening to follow-up planning. | Switch PR-06 to `can_read_highlight` / annotation-level predicates now. | Keeps C7 compatibility scope bounded and avoids cross-slice auth blast radius. | Requires regression tests asserting current masked-not-found behavior on invisible EPUB highlight contexts. | PR-06 implementer | Maintain current semantics until a dedicated auth hardening PR revises L2/L3 ownership. | locked |
| d-007 | EPUB compatibility could be misinterpreted as requiring new offset/anchor models. | Preserve canonical highlight anchor model `(fragment_id, start_offset, end_offset)` and existing derive logic from `fragment.canonical_text`. | EPUB-specific DOM anchor model; TOC-relative offsets. | Directly enforces invariants 6.6 and 6.8. | Requires EPUB highlight tests validating exact/prefix/suffix + fragment scoping behavior unchanged. | PR-06 implementer | Reject any change that introduces non-fragment offset semantics in this PR. | locked |
| d-008 | Existing `/media/{id}/fragments` endpoint must remain compatible for EPUB and non-EPUB callers. | Do not change route/service contract; add EPUB-targeted regression assertion for full ordered payload behavior. | Deprecate or narrow fragments endpoint in PR-06. | Preserves L2 section 4.7 compatibility promise. | Requires explicit EPUB fragments endpoint test with `idx ASC` assertions and payload-shape checks. | PR-06 implementer | If endpoint contract drift is found, stop and route to owning contract PR before merge. | locked |
| d-009 | Backend test setup is currently web-article-centric, increasing ad-hoc SQL duplication risk for EPUB compatibility tests. | Extend `python/tests/factories.py` with reusable EPUB-ready media/fragment helpers (or optional params) instead of embedding raw SQL in each new test. | Hand-write per-test insert SQL for EPUB fixtures. | Improves determinism and maintainability without changing runtime contracts. | Requires new PR-06 backend tests to consume shared factories. | PR-06 implementer | If helper expansion is blocked, temporary test-local SQL is allowed only with immediate follow-up refactor in the same PR. | locked |
| d-010 | PR-06 requires compatibility proof, not service rewrites, but no-change boundaries can drift without explicit assertions. | Keep `highlights.py`, `context_rendering.py`, and `send_message.py` behavior unchanged; prove compatibility via targeted EPUB tests. | Rewrite service logic in PR-06 for stylistic cleanup or speculative hardening. | Preserves ownership boundaries across C4/C5/C7 clusters. | Requires tests that exercise existing paths with EPUB fixtures and fail on behavioral drift. | PR-06 implementer | If a blocking defect requires code change outside scope, update L2/L3 ownership first and revise spec before implementation. | locked |
| d-011 | Public API shape stability is required by L2 section 4.7 and C7 ownership. | No request/response schema or route-shape changes for highlights, quote-to-chat contexts, or `/media/{id}/fragments` in PR-06. | Add/rename fields, alter error envelopes, or introduce new endpoints in PR-06. | Maintains backward compatibility across existing clients and prior slices. | Requires existing-client-path regression assertions in frontend and backend tests. | PR-06 implementer | Any contract evolution requires explicit follow-up slice planning and L2/L3 update. | locked |
| d-012 | Legacy EPUB implementations used a concatenated-book text domain where offsets could implicitly span chapter boundaries, which conflicts with S5 fragment-local anchor invariants. | Add explicit regression coverage that rejects legacy global offsets (`E_HIGHLIGHT_INVALID_RANGE`) and verifies quote context remains chapter-local. | Accept global/chapter-crossing offsets; silently remap legacy offsets to fragment-local ranges. | Reinforces invariants 6.6 and 6.8 with negative and boundary tests. | Requires new highlight invalid-range test and quote-context cross-chapter exclusion test in `test_send_message.py`. | PR-06 implementer | Any offset-model change requires L2 ownership revision; current PR enforces strict fragment-local offsets. | locked |
| d-013 | Legacy EPUB notes identify CSS leakage concerns, but PR-06 ownership is compatibility proof for highlights/chat, not rendering architecture redesign. | Explicitly keep CSS isolation/styling-architecture changes (iframe/shadow DOM/style-stripping pipeline) out of PR-06 scope. | Introduce style-isolation architecture changes in PR-06. | Prevents cross-cluster scope smuggling from rendering concerns into C7 compatibility PR. | No new rendering architecture tests in PR-06; retain compatibility-focused assertions only. | PR-06 implementer | Defer rendering-isolation proposals to future reader-focused hardening PR with dedicated ownership. | locked |

## notes
- d-001 and d-006 were explicitly approved by user as PR-06 boundary decisions.
- d-003 and d-004 convert implicit UI behavior into explicit deterministic contract + test requirements.
- d-007 through d-013 keep PR-06 as compatibility proof, not feature expansion.
