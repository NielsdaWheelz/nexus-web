# pr-05: s5 epub reader baseline adoption

## goal
Adopt chapter-based EPUB read contracts in the baseline media reader UX without changing backend contracts or non-EPUB behavior.

## context
- PR-05 scope in L3 is explicitly C6 UI adoption: consume chapter manifest + chapter detail contracts and handle empty/partial TOC safely (`docs/v1/s5/s5_roadmap.md:128`).
- C5 endpoint behavior is already owned by PR-04; PR-05 must consume, not redefine, chapter/toc API semantics (`docs/v1/s5/s5_roadmap_ownership.md:20`).
- L2 contracts for `/chapters`, `/chapters/{idx}`, `/toc` are already normative and deterministic (`docs/v1/s5/s5_spec.md:462`, `docs/v1/s5/s5_spec.md:505`, `docs/v1/s5/s5_spec.md:544`).
- Current reader still assumes a single active fragment by loading `/fragments` and using `fragments[0]` (`apps/web/src/app/(authenticated)/media/[id]/page.tsx:192`, `apps/web/src/app/(authenticated)/media/[id]/page.tsx:203`).
- Highlight interactions and quote-to-chat are fragment-scoped and should be preserved (`apps/web/src/app/(authenticated)/media/[id]/page.tsx:80`, `apps/web/src/app/(authenticated)/media/[id]/page.tsx:612`).
- PR-04 BFF routes are already present for chapter and TOC transport (`apps/web/src/app/api/media/[id]/chapters/route.ts:1`, `apps/web/src/app/api/media/[id]/chapters/[idx]/route.ts:1`, `apps/web/src/app/api/media/[id]/toc/route.ts:1`).
- L2 keeps advanced EPUB reader polish out of scope for S5 (`docs/v1/s5/s5_spec.md:21`).

## dependencies
- PR-04 merged (chapter + toc endpoints and BFF routes available).
- No dependency on PR-06 implementation; PR-05 must keep existing highlight and quote-to-chat behavior stable.

---

## deliverables

### `apps/web/src/lib/media/epubReader.ts`
- Add a dedicated EPUB reader-orchestration module for C6 logic (chapter manifest traversal, selected chapter resolution, TOC normalization).
- Define typed client contracts aligned to PR-04 response surfaces:
  - `EpubChapterSummary`
  - `EpubChapter`
  - `EpubTocNode`
  - `EpubChapterListResponse`
  - `EpubTocResponse`
- Expose deterministic helpers:
  - `fetchAllEpubChapterSummaries(apiFetchFn, mediaId)`
  - `resolveInitialEpubChapterIdx(chapters, requestedChapterParam)`
  - `normalizeEpubToc(nodes, chapterIdxSet)`
- Required behavior:
  - `fetchAllEpubChapterSummaries` must follow cursor pagination until exhausted (`has_more=false`) using `limit=200` and advancing cursor from `page.next_cursor`.
  - Cursor-loop safety must be explicit: if page cursors do not advance monotonically, fail deterministically to avoid infinite loops.
  - `resolveInitialEpubChapterIdx` behavior:
    - valid in-manifest chapter param -> select requested idx.
    - invalid/missing/non-numeric/out-of-manifest chapter param -> fallback to first manifest idx.
    - empty manifest -> return `null` (reader empty state, no chapter fetch).
  - `normalizeEpubToc` behavior:
    - preserve hierarchical order from API response.
    - mark each node as navigable only when `fragment_idx` maps to an existing manifest chapter idx.
    - partial/structural TOC nodes remain renderable but non-clickable.

### `apps/web/src/lib/media/epubReader.test.ts`
- Add focused unit tests for the new orchestration helpers.

Required tests:

**test: `fetch_all_epub_chapters_walks_cursor_pages_until_exhausted`**
- input:
  - mocked `apiFetch` responses for multiple `/chapters` pages with `has_more=true` then exhausted final page.
- output:
  - helper calls `/api/media/{id}/chapters` with cursor progression.
  - aggregated chapters preserve API ordering and contain no dropped/duplicated idx values.

**test: `fetch_all_epub_chapters_fails_on_non_advancing_cursor`**
- input:
  - mocked paginated response where `has_more=true` but `next_cursor` does not advance.
- output:
  - helper throws deterministic client error; no infinite loop.

**test: `resolve_initial_chapter_idx_prefers_valid_query_falls_back_to_first`**
- input:
  - chapter manifest + multiple query param forms (`"2"`, `"abc"`, missing, out-of-range).
- output:
  - valid mapped idx selected.
  - invalid values fallback to first manifest idx.

**test: `resolve_initial_chapter_idx_returns_null_for_empty_manifest`**
- input:
  - empty manifest and any query param.
- output:
  - returns `null`.

**test: `normalize_epub_toc_marks_only_mapped_nodes_as_navigable`**
- input:
  - nested TOC containing mapped, unmapped (`fragment_idx=null`), and stale fragment idx nodes.
- output:
  - mapped nodes are navigable.
  - unmapped/stale nodes are non-navigable while preserving tree shape and order.

### `apps/web/src/app/(authenticated)/media/[id]/page.tsx`
- Replace EPUB content-path assumptions from `fragments[0]` with chapter-first orchestration while preserving non-EPUB behavior.

Required behavior:
- Load flow:
  - fetch `media` first.
  - if `media.kind === 'epub'`, use chapter-path orchestration:
    1. load full chapter manifest via `/api/media/{id}/chapters` pagination.
    2. resolve active chapter idx using URL query param `chapter` and manifest fallback rules.
    3. fetch active chapter payload from `/api/media/{id}/chapters/{idx}`.
    4. fetch `/api/media/{id}/toc` and normalize navigation metadata.
  - if non-EPUB, keep existing `/api/media/{id}/fragments` flow unchanged.
- Active chapter state:
  - track active chapter idx for EPUB readers.
  - switching chapter must fetch chapter payload by idx, replace rendered content, and rebind highlights to the active chapter fragment id.
  - performance guard: render one active chapter payload at a time; do not eagerly fetch all `/chapters/{idx}` payloads during initial load.
  - chapter payload request safety: rapid chapter changes must not allow stale responses to overwrite newer selection; implement request cancellation (`AbortController`) or request-version guards.
  - chapter payload failure recovery matrix:
    - `404 E_CHAPTER_NOT_FOUND`: refetch manifest once, re-resolve active chapter idx, canonicalize URL to resolved idx, and retry chapter fetch once.
    - `409 E_MEDIA_NOT_READY`: show processing/not-ready gate and stop chapter rendering.
    - `404 E_MEDIA_NOT_FOUND`: show masked not-found state and stop reader rendering.
- URL canonicalization:
  - use query param `chapter` (`>= 0`) as canonical deep-link state for EPUB chapter selection.
  - on fallback selection (invalid/missing chapter param), update URL to resolved chapter idx via `router.replace` (no hard navigation reload).
  - on explicit user chapter navigation actions, update URL via `router.push` to preserve back/forward chapter history.
- Readability gating:
  - treat `ready_for_reading`, `embedding`, and `ready` as readable statuses in UI gating.
- TOC behavior:
  - empty TOC (`nodes=[]`) is non-error and must preserve chapter reading/navigation.
  - partial TOC nodes without mapped chapters are rendered as non-clickable entries.
  - TOC retrieval failure is non-fatal for chapter reading: render chapter navigation controls and content with TOC collapsed/empty and a non-blocking warning state.
- Highlight continuity:
  - preserve existing fragment-scoped highlight APIs/semantics.
  - on chapter change: clear selection/focus/editing state, then refetch highlights for the new active fragment id.
  - highlight request safety: rapid chapter changes must not allow stale highlight responses from prior chapter requests to overwrite active chapter highlight state.
  - quote-to-chat flow remains unchanged.
- Rendering/safety boundary:
  - render chapter content only from backend `html_sanitized` payloads via existing rendering pipeline.
  - do not introduce client-side sanitization bypasses, unsanitized HTML injection paths, or ad-hoc style/script rewrites in PR-05.
  - CSS-isolation architectures (iframe/shadow DOM) remain out of PR-05 scope unless L2/L3 ownership is revised.

### `apps/web/src/app/(authenticated)/media/[id]/page.module.css`
- Add baseline chapter-navigation styles for EPUB mode only:
  - chapter controls row (`prev`, `next`, chapter selector/title).
  - TOC block styling with clear clickable vs non-clickable states.
  - lightweight responsive behavior so controls remain usable on narrow screens.
- Preserve existing highlight pane and content layout for non-EPUB media.

### `apps/web/src/app/(authenticated)/media/[id]/page.test.tsx`
- Add reader integration tests (mocking `apiFetch` and Next navigation hooks) to verify EPUB branch adoption and regression guards.

Required tests:

**test: `epub_reader_loads_manifest_then_selected_chapter_not_fragments`**
- input:
  - media kind `epub`, mocked chapter manifest + chapter detail + toc responses.
- output:
  - requests chapter and toc endpoints.
  - does not use `/api/media/{id}/fragments` as primary EPUB content source.

**test: `non_epub_reader_preserves_fragments_flow`**
- input:
  - media kind `web` with existing fragment payload.
- output:
  - reader continues using `/api/media/{id}/fragments` behavior unchanged.

**test: `epub_reader_invalid_query_chapter_falls_back_and_canonicalizes_url`**
- input:
  - EPUB with manifest `[0,1,2]`, URL query `chapter=999` (or non-numeric).
- output:
  - first manifest chapter renders.
  - router replace canonicalizes URL query to resolved chapter idx.

**test: `epub_reader_initial_load_fetches_only_active_chapter_payload`**
- input:
  - EPUB with chapter manifest containing multiple chapter idx values.
- output:
  - reader fetches manifest and exactly one initial `/chapters/{idx}` payload for the resolved active chapter.
  - no eager N-chapter detail prefetch occurs.

**test: `epub_reader_ignores_stale_chapter_responses_on_rapid_navigation`**
- input:
  - rapid user chapter switches where an older chapter request resolves after a newer request.
- output:
  - final rendered content and highlight fetch target match the newest selected chapter only.
  - stale response is ignored/cancelled and does not overwrite active state.

**test: `epub_reader_chapter_fetch_failure_reconciles_manifest_and_recovers`**
- input:
  - chapter detail fetch returns `404 E_CHAPTER_NOT_FOUND` after initial manifest load.
- output:
  - reader refetches manifest once, resolves valid active chapter idx, canonicalizes URL, and renders recovered chapter payload.

**test: `epub_reader_chapter_fetch_not_ready_shows_processing_gate`**
- input:
  - chapter detail fetch returns `409 E_MEDIA_NOT_READY`.
- output:
  - reader shows processing/not-ready state and does not render stale chapter content.

**test: `epub_reader_chapter_fetch_not_found_shows_masked_not_found`**
- input:
  - chapter detail fetch returns `404 E_MEDIA_NOT_FOUND`.
- output:
  - reader shows masked not-found state and stops chapter rendering.

**test: `epub_reader_user_navigation_pushes_history_and_auto_canonicalization_replaces`**
- input:
  - one explicit user chapter navigation event and one invalid query-param canonicalization event.
- output:
  - user navigation uses `router.push`.
  - automatic invalid-param normalization uses `router.replace`.

**test: `epub_reader_handles_empty_toc_without_blocking_read`**
- input:
  - EPUB with valid manifest/chapter responses and TOC `{nodes: []}`.
- output:
  - chapter content renders; TOC UI shows empty/non-fatal state.

**test: `epub_reader_toc_fetch_failure_is_non_blocking`**
- input:
  - EPUB with valid manifest/chapter responses and TOC request failure.
- output:
  - chapter content still renders using manifest-driven navigation.
  - TOC renders as empty/disabled with non-blocking warning state.

**test: `epub_reader_handles_partial_toc_nodes_as_non_clickable`**
- input:
  - EPUB TOC with mixed mapped and unmapped nodes.
- output:
  - mapped nodes navigate chapters.
  - unmapped nodes do not trigger chapter fetch and do not error.

**test: `epub_reader_embedding_status_is_readable`**
- input:
  - media status `embedding` with valid EPUB chapter responses.
- output:
  - reader renders chapter content and does not show not-ready gate.

**test: `epub_reader_uses_server_sanitized_chapter_html_without_extra_client_rewrite`**
- input:
  - EPUB chapter response with representative sanitized HTML and no active highlights.
- output:
  - rendered chapter content is sourced from server `html_sanitized` through existing renderer path.
  - no additional client-side sanitization/style rewrite layer is introduced beyond the existing highlight overlay transform.

**test: `epub_reader_chapter_switch_refetches_highlights_for_new_fragment`**
- input:
  - EPUB with at least two chapters and distinct fragment ids.
- output:
  - chapter switch triggers highlight fetch for the new fragment id.
  - previous focused highlight state is cleared before new fetch render.

**test: `epub_reader_ignores_stale_highlight_responses_on_rapid_navigation`**
- input:
  - rapid chapter switches where an older chapter's highlight response resolves after the newer chapter is active.
- output:
  - only highlight data for the active chapter fragment is committed; stale highlight response is ignored.

---

## decision ledger

| question | decision | rationale | fallback/default |
|---|---|---|---|
| Should PR-05 switch all reader kinds to chapter APIs? | No. Apply chapter-first path only for `media.kind='epub'`; preserve existing non-EPUB fragment flow. | Prevents cross-kind regressions and keeps C6 scope bounded to EPUB adoption. | If kind detection is unavailable in a code path, default to existing fragment flow and log. |
| Should active chapter state live only in client memory or be URL-addressable? | Make `chapter` query param the canonical active chapter state for EPUB. | Enables durable deep links, deterministic reload behavior, and navigable browser history semantics. | Invalid/missing query param falls back deterministically to first manifest chapter and URL is canonicalized with `router.replace`. |
| Should TOC be the source of navigation truth? | No. Chapter manifest `idx` is canonical; TOC is auxiliary navigation metadata. | TOC may be empty/partial by contract; manifest guarantees contiguous chapter index set. | Without TOC, chapter controls remain fully functional. |
| How should UI readiness treat `embedding` status? | Treat `embedding` as readable in UI (`ready_for_reading|embedding|ready`). | Backend read endpoints allow readable access during embedding; UI must not regress to false not-ready states. | If status mapping expands later, centralize readable-status set in one constant. |
| Should TOC retrieval failure block reading? | No. Fail TOC soft and keep chapter reader operational with non-blocking warning state. | Reading path should remain resilient when optional navigation metadata is unavailable transiently. | Default TOC state to empty tree and preserve chapter controls/content. |
| How should chapter change affect highlight interaction state? | Clear selection/focus/edit-mode state and refetch highlights for the new fragment id before interaction resumes. | Prevents stale highlight IDs and cross-chapter selection leakage in fragment-scoped highlight model. | If highlight fetch fails, render chapter content and surface highlight-load error without breaking read flow. |
| How should full manifest load handle pagination? | Walk `/chapters` cursor pages with `limit=200` until exhausted, validating cursor progression. | Aligns with L2 pagination contract and supports large books beyond single-page manifest size. | If pagination contract breaks (non-advancing cursor), fail deterministically with explicit client error state. |
| Should PR-05 prefetch all chapter detail payloads after loading manifest? | No. Fetch/render only the active chapter payload; defer other chapter details until explicit navigation. | Avoids legacy whole-book DOM/memory regression and keeps baseline reader responsive on large books. | Future adjacent-chapter prefetch may be considered only with explicit perf budget and L2/L3 scope update. |
| How should PR-05 handle out-of-order chapter/highlight fetch responses during rapid navigation? | Apply stale-response protection using request cancellation or monotonic request-version checks before state commit for both chapter payload and highlight requests. | Prevents race-driven content/highlight desynchronization and enforces deterministic active-chapter state. | If cancellation primitives are unavailable, ignore responses whose request version is older than current selection/version token. |
| Should PR-05 add client-side style isolation/sanitization rewrites to address EPUB CSS leakage? | No. Keep rendering bound to backend `html_sanitized` contract and defer iframe/shadow-DOM isolation to future scoped work. | Maintains slice ownership boundaries and avoids introducing parallel HTML-safety logic in the client. | If severe style leakage appears, capture as follow-up hardening work item; do not ad-hoc rewrite chapter HTML in PR-05. |
| How should URL updates behave for user chapter navigation versus automatic canonicalization? | Use `router.push` for explicit user chapter changes and `router.replace` for automatic invalid/missing-param canonicalization. | Preserves expected browser history for user navigation while preventing noisy history entries from automatic normalization. | If UI control source is ambiguous, treat programmatic correction as replace and direct user control actions as push. |
| How should PR-05 recover when chapter fetch fails after manifest resolution? | Use deterministic recovery matrix: `E_CHAPTER_NOT_FOUND` -> one manifest re-sync + re-resolve + one retry; `E_MEDIA_NOT_READY` -> processing gate; `E_MEDIA_NOT_FOUND` -> masked not-found state. | Prevents dead-end reader states during retry/re-extract races and keeps error handling predictable. | Unknown/non-contract errors surface deterministic error UI and preserve currently rendered safe fallback state. |

---

## traceability matrix

| l3 acceptance item | deliverable(s) | test(s) |
|---|---|---|
| EPUB reader flow uses chapter manifest + chapter fetch contracts instead of single-fragment assumptions. | `apps/web/src/lib/media/epubReader.ts`, `apps/web/src/app/(authenticated)/media/[id]/page.tsx`, `apps/web/src/app/(authenticated)/media/[id]/page.test.tsx` | `fetch_all_epub_chapters_walks_cursor_pages_until_exhausted`, `epub_reader_loads_manifest_then_selected_chapter_not_fragments`, `epub_reader_invalid_query_chapter_falls_back_and_canonicalizes_url`, `epub_reader_initial_load_fetches_only_active_chapter_payload`, `epub_reader_ignores_stale_chapter_responses_on_rapid_navigation`, `epub_reader_chapter_fetch_failure_reconciles_manifest_and_recovers`, `epub_reader_chapter_fetch_not_ready_shows_processing_gate`, `epub_reader_chapter_fetch_not_found_shows_masked_not_found`, `epub_reader_user_navigation_pushes_history_and_auto_canonicalization_replaces`, `epub_reader_embedding_status_is_readable`, `epub_reader_chapter_switch_refetches_highlights_for_new_fragment`, `epub_reader_ignores_stale_highlight_responses_on_rapid_navigation`, `non_epub_reader_preserves_fragments_flow` |
| Empty/partial TOC behavior is handled safely without regressing basic reading and navigation. | `apps/web/src/lib/media/epubReader.ts`, `apps/web/src/app/(authenticated)/media/[id]/page.tsx`, `apps/web/src/app/(authenticated)/media/[id]/page.module.css`, `apps/web/src/app/(authenticated)/media/[id]/page.test.tsx` | `normalize_epub_toc_marks_only_mapped_nodes_as_navigable`, `epub_reader_handles_empty_toc_without_blocking_read`, `epub_reader_toc_fetch_failure_is_non_blocking`, `epub_reader_handles_partial_toc_nodes_as_non_clickable`, `epub_reader_uses_server_sanitized_chapter_html_without_extra_client_rewrite` |

---

## acceptance tests

### file: `apps/web/src/lib/media/epubReader.test.ts`

**test: `fetch_all_epub_chapters_walks_cursor_pages_until_exhausted`**
- input: mocked paginated chapter responses with cursor progression.
- output: helper calls paginated endpoint sequence correctly and returns ordered aggregate manifest.

**test: `fetch_all_epub_chapters_fails_on_non_advancing_cursor`**
- input: paginated response with `has_more=true` but repeated/non-advancing cursor.
- output: helper throws deterministic error and aborts loop.

**test: `resolve_initial_chapter_idx_prefers_valid_query_falls_back_to_first`**
- input: non-empty chapter manifest and mixed query param values.
- output: valid in-manifest idx selected; invalid values fallback to first.

**test: `resolve_initial_chapter_idx_returns_null_for_empty_manifest`**
- input: empty manifest.
- output: returns `null`.

**test: `normalize_epub_toc_marks_only_mapped_nodes_as_navigable`**
- input: nested TOC with mapped/unmapped entries.
- output: navigable flags and tree order are deterministic and safe for partial TOC.

### file: `apps/web/src/app/(authenticated)/media/[id]/page.test.tsx`

**test: `epub_reader_loads_manifest_then_selected_chapter_not_fragments`**
- input: EPUB media with chapter/toc fixtures.
- output: chapter/toc endpoints are used for content path; `/fragments` is not used as primary EPUB content source.

**test: `non_epub_reader_preserves_fragments_flow`**
- input: `web` media fixture.
- output: existing fragment-based reader path remains unchanged.

**test: `epub_reader_invalid_query_chapter_falls_back_and_canonicalizes_url`**
- input: invalid chapter query and valid chapter manifest.
- output: fallback chapter renders and URL query is canonicalized to resolved idx.

**test: `epub_reader_initial_load_fetches_only_active_chapter_payload`**
- input: EPUB media with multi-chapter manifest.
- output: only one initial chapter-detail fetch is issued for resolved active chapter; no eager all-chapter detail fetch.

**test: `epub_reader_ignores_stale_chapter_responses_on_rapid_navigation`**
- input: rapid chapter changes with out-of-order request completion.
- output: only newest chapter response is committed to render/highlight state.

**test: `epub_reader_chapter_fetch_failure_reconciles_manifest_and_recovers`**
- input: chapter detail call returns `E_CHAPTER_NOT_FOUND` during load/navigation.
- output: one manifest re-sync occurs, chapter idx is re-resolved, URL canonicalizes to valid idx, and a single chapter-fetch retry is attempted.

**test: `epub_reader_chapter_fetch_not_ready_shows_processing_gate`**
- input: chapter detail call returns `E_MEDIA_NOT_READY`.
- output: processing/not-ready state is shown and stale chapter content is not rendered as current.

**test: `epub_reader_chapter_fetch_not_found_shows_masked_not_found`**
- input: chapter detail call returns `E_MEDIA_NOT_FOUND`.
- output: masked not-found state is shown and reader flow stops chapter rendering.

**test: `epub_reader_user_navigation_pushes_history_and_auto_canonicalization_replaces`**
- input: one explicit user chapter change and one automatic invalid-param canonicalization.
- output: user action uses `router.push`; automatic normalization uses `router.replace`.

**test: `epub_reader_handles_empty_toc_without_blocking_read`**
- input: empty TOC with valid chapter responses.
- output: reader renders chapter content with non-fatal empty TOC state.

**test: `epub_reader_toc_fetch_failure_is_non_blocking`**
- input: TOC request fails while media + chapter responses are valid.
- output: reader still renders chapter content and chapter controls with non-blocking TOC warning/empty state.

**test: `epub_reader_handles_partial_toc_nodes_as_non_clickable`**
- input: TOC with `fragment_idx=null` nodes.
- output: unmapped nodes do not trigger navigation; mapped nodes still navigate.

**test: `epub_reader_embedding_status_is_readable`**
- input: EPUB media in `embedding` status with valid chapter responses.
- output: content renders and not-ready state is not shown.

**test: `epub_reader_uses_server_sanitized_chapter_html_without_extra_client_rewrite`**
- input: chapter payload with representative `html_sanitized` and no active highlights.
- output: renderer consumes server `html_sanitized` path directly; no extra client rewrite/sanitization layer beyond existing highlight overlay transform is introduced.

**test: `epub_reader_chapter_switch_refetches_highlights_for_new_fragment`**
- input: two-chapter EPUB fixture with distinct fragment ids.
- output: highlight fetch target updates to active chapter fragment and stale focus state is cleared.

**test: `epub_reader_ignores_stale_highlight_responses_on_rapid_navigation`**
- input: rapid chapter changes where stale highlight response resolves after newer chapter is active.
- output: only active chapter highlight response is committed; stale response is ignored.

---

## non-goals
- Does not modify backend chapter/toc endpoint contracts or error semantics (owned by PR-04).
- Does not modify extraction artifacts, TOC persistence semantics, retry logic, or ingestion lifecycle (owned by PR-02/PR-03).
- Does not alter highlight/quote-to-chat API contracts or add new annotation features (owned by PR-06).
- Does not add advanced EPUB reader features (search-in-book, virtualized infinite scroll, offline caching, pagination engines, EPUB.js parity).
- Does not introduce iframe/shadow-DOM CSS-isolation architecture or client-side parallel sanitization pipeline.

---

## constraints
- Only touch files listed in deliverables unless this spec is revised first.
- Follow existing client-side API pattern (`apiFetch`) and Next.js routing conventions.
- Preserve backward compatibility for non-EPUB reader behavior.
- Do not introduce direct browser->FastAPI calls; continue using BFF routes.

---

## boundaries (for ai implementers)

**do**:
- Implement EPUB chapter-first reader behavior using merged PR-04 contracts.
- Keep navigation deterministic and resilient for empty/partial TOC data.
- Preserve existing highlight semantics by rebinding interactions to active fragment ids.
- Add tests for each behavior-changing decision and both L3 acceptance bullets.

**do not**:
- Change backend endpoint behavior or response shapes.
- Remove or repurpose `/media/{id}/fragments` for non-EPUB readers.
- Add adjacent product features beyond baseline chapter navigation.
- Introduce unsanitized HTML rendering paths or ad-hoc client-side HTML/style rewrite logic.
- Rewrite unrelated highlight or conversation modules.

---

## open questions + temporary defaults

| question | temporary default behavior | owner | due |
|---|---|---|---|
| none | n/a | n/a | n/a |

---

## checklist
- [ ] every l3 acceptance bullet is in traceability matrix
- [ ] every traceability row has at least one test
- [ ] every behavior-changing decision has assertions
- [ ] only scoped files are touched
- [ ] non-goals are explicit and enforced
