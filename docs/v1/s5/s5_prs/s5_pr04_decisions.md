# s5 pr-04 decisions

## status
working decision ledger for `docs/v1/s5/s5_prs/s5_pr04.md`.

| id | problem | decision | rejected alternatives | invariant impact | test impact | owner | fallback/default | status |
|---|---|---|---|---|---|---|---|---|
| d-001 | PR-04 needs new read behavior but `media.py` already mixes multiple concerns and is growing. | Create `python/nexus/services/epub_read.py` as the C5 read-contract owner and keep PR-04 logic there. | Keep adding chapter/toc logic into `python/nexus/services/media.py`; put read policy in route handlers. | Preserves contract boundary between C3/C4/C5 and keeps read determinism isolated from lifecycle/extraction ownership. | Requires route tests to confirm transport-only handlers still call one service function each. | PR-04 implementer | Thin compatibility wrappers in `media.py` are acceptable only during migration; final ownership remains `epub_read.py`. | locked |
| d-002 | Read endpoints must enforce visibility masking while also surfacing explicit kind/readiness failures for authorized users. | Use guard order `visibility -> kind -> readiness -> resource lookup` across `/chapters`, `/chapters/{idx}`, `/toc`. | Check kind or readiness before visibility; return different not-found/forbidden variants by endpoint. | Protects masked existence semantics (`6.9`) and keeps deterministic authorized guard behavior. | Requires shared guard tests spanning all three endpoints for visibility/kind/readiness combinations. | PR-04 implementer | Additional endpoint-local checks may be appended after these three guard stages, never before visibility. | locked |
| d-003 | Cursor design differs across APIs; conversations/search use opaque cursors while chapter idx already has stable ordering semantics. | Keep chapter cursor as integer idx (`idx > cursor`) with canonical `page.next_cursor` + `page.has_more` envelope. | Introduce opaque/base64 cursor token in PR-04; offset-style pagination. | Preserves L2 contract (`4.4`) and deterministic index traversal (`6.5`, `6.14`) without introducing migration drift. | Requires paging tests that assert integer cursor behavior and no duplication across pages. | PR-04 implementer | Opaque cursor migration is deferred until an L2/L3 contract revision explicitly authorizes it. | locked |
| d-004 | Chapter title contract requires deterministic output but no chapter-title column exists in persisted artifacts. | Derive title at read time: primary mapped TOC label (node with minimum `order_key`) -> first heading (`h1..h6`) from `html_sanitized` -> `Chapter {idx+1}`. | Add new persisted chapter-title column in PR-04; rely on non-deterministic parser display labels only. | Preserves `2.3` deterministic title contract without extending C3 extraction schema in a C5 PR. | Requires chapter list/chapter detail tests for TOC-present and TOC-absent fallback branches, including multi-node TOC mapping determinism. | PR-04 implementer | If heading extraction fails due malformed HTML, deterministic fallback immediately to `Chapter {idx+1}`. | locked |
| d-005 | `/toc` requires nested deterministic output while stored representation is flat rows with parent references. | Build nested response in service layer from persisted rows sorted by `order_key ASC`; never recompute from EPUB source bytes. | Re-parse EPUB bytes at read time; recursive DB queries per node path. | Preserves immutable artifact model (`6.3`) and deterministic ordering contract (`4.6`, `6.13`). | Requires tests for nested ordering, stable parent linkage, and zero-row TOC behavior. | PR-04 implementer | Unexpected malformed parent linkage is treated as internal data integrity failure (no silent recomputation). | locked |
| d-006 | Constitution requires browser non-streaming traffic through BFF; backend-only endpoint delivery would violate topology. | Ship matching Next.js BFF transport routes and proxy tests in same PR as backend read endpoints. | Defer BFF routes to PR-05; allow direct browser calls to FastAPI for non-streaming read endpoints. | Keeps L0 request-topology compliance and avoids unsupported browser path exceptions. | Requires explicit route-proxy tests for `/api/media/{id}/chapters`, `/api/media/{id}/chapters/{idx}`, and `/api/media/{id}/toc`. | PR-04 implementer | If UI adoption is delayed, BFF route stubs still land and remain contract-complete. | locked |
| d-007 | Query/path validation can drift into framework-default behavior that obscures API contract intent. | Use explicit endpoint-domain validation for limit/cursor/idx bounds and map failures to `E_INVALID_REQUEST`. | Depend entirely on framework ge/le coercion with implicit 422 mapping behavior. | Keeps L2 error semantics explicit (`E_INVALID_REQUEST` for invalid limit/cursor/index domains). | Requires invalid-input tests for limit/cursor/index across read endpoints. | PR-04 implementer | If framework parser rejects malformed type before service entry, middleware mapping to `E_INVALID_REQUEST` remains acceptable baseline. | locked |
| d-008 | PR-04 could accidentally modify existing `/fragments` behavior while adding chapter/toc APIs. | Preserve `/media/{id}/fragments` contract untouched; add chapter/toc as additive surfaces only. | Replace fragments endpoint with chapters endpoint; add compatibility shims in frontend only. | Protects backward compatibility invariant and avoids scope leakage into PR-06 compatibility ownership. | Requires regression assertions that chapter/toc additions do not alter existing fragment endpoint expectations. | PR-04 implementer | Any future deprecation path must be explicit in a later slice with migration plan. | locked |
| d-009 | Pagination cursor can naturally exceed chapter bounds after retries or stale client state; behavior must remain deterministic. | Treat `cursor >= max_idx` as exhausted page (`200`, `data=[]`, `next_cursor=null`, `has_more=false`) rather than an error. | Return 404/400 for out-of-range cursor; clamp cursor silently to max_idx and return last page again. | Preserves deterministic, idempotent pagination contract and client retry safety without false negatives. | Requires explicit out-of-range cursor test and page-envelope assertions. | PR-04 implementer | Malformed cursor values remain `400 E_INVALID_REQUEST`; only well-formed, in-domain but out-of-range values use exhausted-page semantics. | locked |
| d-010 | Metadata-only chapter manifest can regress performance if implementation loads full chapter payloads and strips fields later. | Enforce summary-only DB projection in `/chapters` implementation; do not fetch `html_sanitized` or `canonical_text` for manifest rows. | Select full fragment rows for convenience and drop heavy fields during serialization. | Reinforces invariant `6.11` at storage-read boundary and prevents large-book memory/IO regression. | Requires explicit projection-verification test plus manifest-shape tests. | PR-04 implementer | Use explicit SQL projection if ORM convenience path pulls heavy columns by default. | locked |
| d-011 | Legacy systems often returned a single concatenated HTML blob, which would violate chapter-scoped endpoint semantics if reintroduced. | Make `/chapters/{idx}` strictly single-fragment scoped and add sentinel-content test to prevent concatenation regression. | Allow endpoint to return stitched chapter neighborhoods or whole-book HTML for fewer reads. | Protects S5 chapter-boundary architecture and deterministic per-chapter navigation guarantees. | Requires chapter-content isolation test ensuring adjacent chapter text is absent from requested chapter payload. | PR-04 implementer | Whole-book reads remain available through existing compatibility surfaces outside PR-04 endpoint contracts. | locked |

## notes
- d-001 through d-011 are aligned to L3 PR-04 ownership and non-goals.
- No unresolved decision remains for PR-04 scope.
