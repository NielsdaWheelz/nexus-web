# PR-03 Spec — Models Registry + User API Keys (Slice 3)

This PR introduces **model availability** and **secure user API key management**.
It does **not** execute LLM calls, stream tokens, or send messages. Those come later (PR-04/05).

This PR must be safe, boring, and correct: no secrets leak, no implicit behavior, no cleverness.

---

## 1) Goals

### Primary

- Allow users to:
  - View which LLM models are available to them
  - Add / update / revoke their own API keys (BYOK)
- Enforce secure-at-rest encryption for all user keys
- Correctly filter models by key availability (platform key or BYOK)

### Secondary

- Establish clean interfaces for later LLM execution (PR-04)
- Ensure no sensitive fields ever leave the backend

---

## 2) Non-Goals (Explicit)

- No LLM calls (generation or streaming)
- No token usage accounting
- No cost enforcement
- No `/keys/:id/test` endpoint (deferred to PR-04)
- No frontend UI (handled in PR-07)
- No key prefix validation (`sk-` etc.)

---

## 3) Data Model (Already Migrated in PR-01)

This PR assumes the following tables already exist from PR-01 migration.

### 3.1 `models`

| Column | Type | Notes |
|--------|------|-------|
| `id` | UUID | PK |
| `provider` | TEXT | `openai` \| `anthropic` \| `gemini` |
| `model_name` | TEXT | |
| `max_context_tokens` | INTEGER | |
| `cost_per_1k_input_tokens_usd` | INTEGER | nullable, micros |
| `cost_per_1k_output_tokens_usd` | INTEGER | nullable, micros |
| `is_available` | BOOLEAN | |

### 3.2 `user_api_key`

| Column | Type | Notes |
|--------|------|-------|
| `id` | UUID | PK |
| `user_id` | UUID | FK → users |
| `provider` | TEXT | `openai` \| `anthropic` \| `gemini` |
| `encrypted_key` | BYTEA | **nullable** (wiped on revoke) |
| `key_nonce` | BYTEA | 24 bytes, **nullable** (wiped on revoke) |
| `master_key_version` | INTEGER | **nullable** (wiped on revoke) |
| `key_fingerprint` | TEXT | last 4 chars (retained on revoke) |
| `status` | TEXT | `untested` \| `valid` \| `invalid` \| `revoked` |
| `created_at` | TIMESTAMP | |
| `last_tested_at` | TIMESTAMP | nullable |
| `revoked_at` | TIMESTAMP | nullable |

**DB invariants:**
- `UNIQUE (user_id, provider)`
- Keys are encrypted at rest
- Plaintext keys never persist or log
- `encrypted_key`, `key_nonce`, `master_key_version` are nullable to support revocation wipe

---

## 4) Model Seed Data (Required)

PR-01 migration must include seed data for the `models` table. Without this, `GET /models` is useless.

### Seed Migration

Add `0004a_seed_models.py` (or include in `0004_slice3_schema.py`):

```python
# Seed rows for models table
SEED_MODELS = [
    # OpenAI
    {"provider": "openai", "model_name": "gpt-4o-mini", "max_context_tokens": 128000, "is_available": True},
    {"provider": "openai", "model_name": "gpt-4o", "max_context_tokens": 128000, "is_available": True},
    # Anthropic
    {"provider": "anthropic", "model_name": "claude-sonnet-4-20250514", "max_context_tokens": 200000, "is_available": True},
    {"provider": "anthropic", "model_name": "claude-haiku-4-20250514", "max_context_tokens": 200000, "is_available": True},
    # Gemini
    {"provider": "gemini", "model_name": "gemini-2.0-flash", "max_context_tokens": 1000000, "is_available": True},
    {"provider": "gemini", "model_name": "gemini-2.5-pro-preview-05-06", "max_context_tokens": 1000000, "is_available": True},
]
```

**Notes:**
- Cost fields left `NULL` initially (filled in when billing is implemented)
- Model names must match what adapters use in PR-04; update if needed
- All models seeded as `is_available=True`; availability to users depends on key availability

---

## 5) Configuration

### 5.1 Required Environment Variables

| Name | Purpose |
|------|---------|
| `NEXUS_KEY_ENCRYPTION_KEY` | Base64-encoded 32-byte master key |
| `OPENAI_API_KEY` | Optional platform key |
| `ANTHROPIC_API_KEY` | Optional platform key |
| `GEMINI_API_KEY` | Optional platform key |

### 5.2 Startup Validation

- `NEXUS_KEY_ENCRYPTION_KEY` must exist and decode to exactly 32 bytes
- App must **fail fast** if missing or invalid (do not start)

---

## 6) Crypto Specification

### 6.1 Algorithm

**XChaCha20-Poly1305** via PyNaCl (`crypto_secretbox_easy`)

### 6.2 Service Functions

Define in `services/crypto.py`:

```python
def encrypt_api_key(plaintext: str) -> tuple[bytes, bytes, int, str]:
    """
    Encrypt an API key for storage.

    Returns: (ciphertext, nonce, master_key_version, fingerprint)

    - nonce is generated internally (24 random bytes) — never supplied by caller
    - fingerprint is last 4 characters of plaintext
    - master_key_version is always 1 (current version)
    """

def decrypt_api_key(ciphertext: bytes, nonce: bytes, version: int) -> str:
    """
    Decrypt an API key from storage.

    Raises:
        ApiError(E_INTERNAL): If version is unknown or decryption fails
    """
```

### 6.3 Master Key Versioning

**Current behavior (v1):**
- Encryption always writes `master_key_version = 1`
- Decryption reads version from row:
  - If version == 1 → use current master key
  - If version unknown → raise `ApiError(E_INTERNAL, "Unknown key version")`

**Deferred:**
- Multi-version key mapping (for rotation) is not implemented
- Do not pretend it exists; add when needed

### 6.4 Nonce Generation

- Nonce is generated inside `encrypt_api_key()` using `os.urandom(24)`
- Callers never supply nonce (prevents reuse)
- Each encryption produces a unique nonce

---

## 7) API Endpoints

### 7.1 Response Envelope

All success responses use the standard envelope:

```json
{ "data": <payload> }
```

All error responses use the standard error envelope:

```json
{
  "error": {
    "code": "E_*",
    "message": "...",
    "request_id": "..."
  }
}
```

### 7.2 Authentication

All endpoints in this PR require authentication:
- Missing/invalid auth → `401 E_UNAUTHENTICATED`

---

### 7.3 `GET /models`

Returns models available to the current user.

**Auth:** Required

#### Availability Rule

A model is included iff:

```
model.is_available = true AND (
  platform key exists for model.provider
  OR user has API key with status ∈ {'untested', 'valid'}
)
```

**Note:** Keys with `status = 'invalid'` or `status = 'revoked'` do NOT enable models.

#### Response (200)

```json
{
  "data": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "provider": "openai",
      "model_name": "gpt-4o-mini",
      "max_context_tokens": 128000
    },
    {
      "id": "550e8400-e29b-41d4-a716-446655440001",
      "provider": "anthropic",
      "model_name": "claude-sonnet-4-20250514",
      "max_context_tokens": 200000
    }
  ]
}
```

#### Errors

None specific — empty list is valid if no models available.

---

### 7.4 `GET /keys`

Lists the user's API keys (safe fields only).

**Auth:** Required. Returns only keys owned by the authenticated user.

#### Response (200)

```json
{
  "data": [
    {
      "id": "660e8400-e29b-41d4-a716-446655440000",
      "provider": "openai",
      "key_fingerprint": "AbC1",
      "status": "untested",
      "created_at": "2026-01-23T12:00:00Z",
      "last_tested_at": null
    }
  ]
}
```

#### Forbidden Fields (Never Present)

- `encrypted_key`
- `key_nonce`
- `master_key_version`

#### Errors

None specific — empty list is valid.

---

### 7.5 `POST /keys` (Upsert)

Adds or updates a key for a provider.

**Auth:** Required. Key is owned by the authenticated user.

#### Request

```json
{
  "provider": "openai",
  "api_key": "sk-proj-abc123..."
}
```

#### Validation Rules

1. `provider` must be one of: `openai` | `anthropic` | `gemini`
2. `api_key` validation:
   ```python
   api_key = api_key.strip()
   if len(api_key) < 20:
       raise ApiError(E_KEY_INVALID_FORMAT, "API key too short")
   if any(c.isspace() for c in api_key):
       raise ApiError(E_KEY_INVALID_FORMAT, "API key contains whitespace")
   ```

#### Behavior

- If no existing key for `(user_id, provider)` → **create**
- If key exists for `(user_id, provider)` → **overwrite**
- Always:
  - Generate new nonce
  - Re-encrypt with new ciphertext
  - Set `status = 'untested'`
  - Update `key_fingerprint` (last 4 chars)
  - Clear `last_tested_at`
  - Clear `revoked_at`

#### Response (201 Created — new key)

```json
{
  "data": {
    "id": "660e8400-e29b-41d4-a716-446655440000",
    "provider": "openai",
    "key_fingerprint": "AbC1",
    "status": "untested",
    "created_at": "2026-01-23T12:00:00Z",
    "last_tested_at": null
  }
}
```

#### Response (200 OK — updated key)

Same shape as 201.

#### Errors

| Code | Status | When |
|------|--------|------|
| `E_KEY_PROVIDER_INVALID` | 400 | Unknown provider |
| `E_KEY_INVALID_FORMAT` | 400 | Key too short or contains whitespace |

---

### 7.6 `DELETE /keys/:id`

Revokes a key.

**Auth:** Required. Only operates on keys owned by the authenticated user; otherwise `404 E_KEY_NOT_FOUND`.

#### Behavior

**Secure revocation (wipe ciphertext):**
- Set `status = 'revoked'`
- Set `revoked_at = now()`
- Set `encrypted_key = NULL`
- Set `key_nonce = NULL`
- Set `master_key_version = NULL`
- **Retain** `key_fingerprint` for audit trail

**Rationale:** Wiping ciphertext reduces blast radius if DB leaks. Fingerprint + timestamps provide sufficient audit trail.

**Idempotency:** Deleting an already-revoked key returns `204` (no error).

#### Response

`204 No Content`

#### Errors

| Code | Status | When |
|------|--------|------|
| `E_KEY_NOT_FOUND` | 404 | Key doesn't exist OR not owned by viewer |

---

## 8) Service-Layer Rules

### 8.1 Provider Normalization

- Lowercase only: `openai`, `anthropic`, `gemini`
- Reject others with `E_KEY_PROVIDER_INVALID`

### 8.2 Status Semantics

| Status | Meaning | Enables Models? |
|--------|---------|-----------------|
| `untested` | Newly added or overwritten | Yes |
| `valid` | Last provider call succeeded | Yes |
| `invalid` | Last provider call failed auth (401/403) | No |
| `revoked` | User explicitly revoked | No |

### 8.3 Key Usability

A key is "usable" (counts for model availability) iff:
- `status ∈ {'untested', 'valid'}`
- `revoked_at IS NULL`

---

## 9) Error Codes

| Code | HTTP | When |
|------|------|------|
| `E_KEY_PROVIDER_INVALID` | 400 | Unknown provider in request |
| `E_KEY_INVALID_FORMAT` | 400 | Key too short (<20 chars) or contains whitespace |
| `E_KEY_NOT_FOUND` | 404 | Key doesn't exist or not owned by viewer |
| `E_UNAUTHENTICATED` | 401 | Missing or invalid authentication |
| `E_INTERNAL` | 500 | Unknown master key version or crypto failure |

---

## 10) Tests (Required)

### Crypto Tests

- Encrypt/decrypt round-trip succeeds
- Ciphertext differs from plaintext
- Two encryptions of same plaintext produce different ciphertexts (unique nonces)
- Decryption with unknown version raises `E_INTERNAL`

### API Safety Tests

- `GET /keys` response never includes `encrypted_key`, `key_nonce`, `master_key_version`
- Fingerprint is exactly last 4 chars of original key

### Validation Tests (Negative)

- `POST /keys` with invalid provider → `400 E_KEY_PROVIDER_INVALID`
- `POST /keys` with key < 20 chars → `400 E_KEY_INVALID_FORMAT`
- `POST /keys` with key containing space → `400 E_KEY_INVALID_FORMAT`
- `POST /keys` with key containing tab → `400 E_KEY_INVALID_FORMAT`
- `POST /keys` with key containing newline → `400 E_KEY_INVALID_FORMAT`

### Upsert Semantics Tests

- Same `(user_id, provider)` upsert returns same row id
- Ciphertext changes on overwrite (new nonce)
- Status resets to `untested` on overwrite
- `last_tested_at` cleared on overwrite

### Model Filtering Tests

- No keys + no platform key → empty model list
- Platform key present for provider → that provider's models appear
- BYOK with `status='untested'` → provider models appear
- BYOK with `status='valid'` → provider models appear
- BYOK with `status='invalid'` → provider models do NOT appear
- BYOK with `status='revoked'` → provider models do NOT appear

### Revocation Tests

- `DELETE /keys/:id` sets `status='revoked'` and `revoked_at`
- `DELETE /keys/:id` wipes `encrypted_key`, `key_nonce`, `master_key_version` to NULL
- `DELETE /keys/:id` retains `key_fingerprint`
- Revoked key no longer enables provider models
- Deleting already-revoked key returns `204` (idempotent)
- Deleting another user's key returns `404 E_KEY_NOT_FOUND`

### Auth Tests

- `GET /models` without auth → `401 E_UNAUTHENTICATED`
- `GET /keys` without auth → `401 E_UNAUTHENTICATED`
- `POST /keys` without auth → `401 E_UNAUTHENTICATED`
- `DELETE /keys/:id` without auth → `401 E_UNAUTHENTICATED`

---

## 11) Out of Scope (Deferred)

- `/keys/:id/test` (PR-04)
- Provider adapters (PR-04)
- LLM calls (PR-04/05)
- Streaming (PR-08)
- Billing enforcement
- Multi-version master key rotation

---

## 12) Acceptance Criteria

- [ ] No secret ever leaves backend
- [ ] Keys encrypted at rest with XChaCha20-Poly1305
- [ ] Ciphertext wiped on revoke (NULL in DB)
- [ ] `/models` filtered correctly by key status
- [ ] Upsert semantics correct (same provider = same row)
- [ ] All validation tests pass (provider, length, whitespace)
- [ ] Tests pass without network access
- [ ] Model seed data exists and `GET /models` returns rows
- [ ] No coupling to later LLM execution logic
