# Nexus Frontend

Next.js web application for Nexus. This is the BFF (Backend for Frontend) that proxies requests to FastAPI.

## Architecture

```
Browser → Next.js (this app) → FastAPI → Database
```

The browser **never** calls FastAPI directly. All requests go through Next.js route handlers which:
1. Extract the Supabase access token from the session
2. Generate or forward `X-Request-ID` header for tracing
3. Attach `Authorization: Bearer <token>` header
4. Attach `X-Nexus-Internal` header (BFF authentication)
5. Forward the request to FastAPI
6. Filter response headers via allowlist
7. Return the response to the browser with `X-Request-ID`

### Request Tracing

Every request has an `X-Request-ID` for debugging:
- Generated by BFF if not present in browser request
- Forwarded to FastAPI for correlation
- Included in all responses (success and error)
- Error responses include `request_id` in the body for easy copy/paste

### Response Header Security

The BFF filters FastAPI response headers via allowlist:
- **Allowed**: `X-Request-ID`, `Content-Type`, `Content-Length`
- **Blocked**: `Authorization`, `X-Nexus-Internal`, `Set-Cookie`, `X-Internal-*`

## Setup

The `.env.local` file is created automatically by `make setup`. If you need to create it manually:

```bash
# From repo root
make setup
```

Or create `apps/web/.env.local` manually with:

```bash
# Required: FastAPI backend URL
FASTAPI_BASE_URL=http://localhost:8000

# Required: Supabase local configuration (from supabase status)
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>

# Optional: Environment (default: local)
NEXUS_ENV=local

# Required in staging/prod: Internal API secret
# NEXUS_INTERNAL_SECRET=your-secret
```

To get your Supabase local credentials:
```bash
supabase status
```

## Development

```bash
# Install dependencies
npm install

# Start the development server
npm run dev

# Or from repo root
make web
```

The app runs at http://localhost:3000 by default.

**Prerequisites**:
- Supabase local must be running (`supabase start`)
- FastAPI server must be running (`make api`)

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `FASTAPI_BASE_URL` | Yes | FastAPI server URL |
| `NEXT_PUBLIC_SUPABASE_URL` | Yes | Supabase project URL (local: `http://127.0.0.1:54321`) |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Yes | Supabase anon key |
| `NEXUS_ENV` | No | Environment (default: `local`) |
| `NEXUS_INTERNAL_SECRET` | staging/prod | Internal API secret |

## Project Structure

```
src/
├── app/                    # Next.js app router
│   ├── api/                # BFF proxy routes (mirror FastAPI paths)
│   │   ├── me/
│   │   ├── libraries/
│   │   └── media/
│   ├── (authenticated)/    # Protected pages (require login)
│   │   ├── libraries/
│   │   └── media/
│   ├── login/              # Login page
│   └── auth/               # Auth callbacks
├── components/             # React components
│   ├── HtmlRenderer.tsx    # ONLY place with dangerouslySetInnerHTML
│   ├── Navbar.tsx
│   ├── Pane.tsx
│   └── ...
├── lib/                    # Utilities
│   ├── api/
│   │   └── proxy.ts        # BFF proxy helper (proxyToFastAPI)
│   ├── highlights/         # Highlight utilities (pure, no DOM)
│   │   └── segmenter.ts    # Overlap segmentation algorithm
│   └── supabase/
│       ├── server.ts       # Server-side Supabase client
│       └── middleware.ts   # Session refresh + auth redirects
└── middleware.ts           # Auth redirect + CSP
```

## Key Constraints

### Security

- **No tokens in localStorage**: Access tokens exist only in server runtime
- **Single HtmlRenderer**: Only component allowed to use `dangerouslySetInnerHTML`
- **BFF only**: All browser → backend traffic goes through Next.js

### Route Handlers

Each route handler must:
- Be 3-10 lines of actual logic
- Delegate to `proxyToFastAPI()` for all backend communication
- NOT perform custom request shaping beyond path parameters
- NOT add business logic (that belongs in FastAPI)

Example:
```typescript
export async function GET(req: Request, { params }: { params: { id: string } }) {
  const { id } = await params;
  return proxyToFastAPI(req, `/libraries/${id}`);
}
```

## Testing

```bash
# Run tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests for CI
npm run test:ci

# Run TypeScript type checking
npm run typecheck
```

## Highlight Libraries

### `lib/highlights/segmenter.ts`

A pure, deterministic overlap segmenter for highlights. This module:

- Takes a text length (codepoints) and list of highlight ranges
- Produces disjoint segments annotated with active highlight IDs
- Determines the "topmost" highlight using `(created_at_ms DESC, id ASC)` ordering
- Has no DOM or backend dependencies (used by rendering and interaction code)

```typescript
import { segmentHighlights, NormalizedHighlight, HIGHLIGHT_COLORS } from '@/lib/highlights/segmenter';

const result = segmentHighlights(textLen, highlights);
// result.segments: Segment[] - disjoint highlighted ranges
// result.droppedIds: string[] - invalid highlights that were ignored
```

**Invariants guaranteed:**
1. Segments are strictly ordered (non-overlapping)
2. No zero-width segments
3. Each segment has at least one active highlight
4. `topmostId` is the first element of `activeIds`
5. Output is deterministic regardless of input order
6. No adjacent segments with identical active sets
7. Coverage equals union of valid highlight ranges

## Linting

```bash
npm run lint
```

## Building

```bash
npm run build
npm start
```
