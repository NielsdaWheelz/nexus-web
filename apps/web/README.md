# Nexus Frontend

Next.js web application for Nexus. This is the BFF (Backend for Frontend) that proxies requests to FastAPI.

## Architecture

```
Browser → Next.js (this app) → FastAPI → Database
```

The browser **never** calls FastAPI directly. All requests go through Next.js route handlers which:
1. Extract the Supabase access token from the session
2. Generate or forward `X-Request-ID` header for tracing
3. Attach `Authorization: Bearer <token>` header
4. Attach `X-Nexus-Internal` header (BFF authentication)
5. Forward the request to FastAPI
6. Filter response headers via allowlist
7. Return the response to the browser with `X-Request-ID`

### Request Tracing

Every request has an `X-Request-ID` for debugging:
- Generated by BFF if not present in browser request
- Forwarded to FastAPI for correlation
- Included in all responses (success and error)
- Error responses include `request_id` in the body for easy copy/paste

### Response Header Security

The BFF filters FastAPI response headers via allowlist:
- **Allowed**: `X-Request-ID`, `Content-Type`, `Content-Length`
- **Blocked**: `Authorization`, `X-Nexus-Internal`, `Set-Cookie`, `X-Internal-*`

## Setup

The `.env.local` file is created automatically by `make setup`. If you need to create it manually:

```bash
# From repo root
make setup
```

Or create `apps/web/.env.local` manually with:

```bash
# Required: FastAPI backend URL
FASTAPI_BASE_URL=http://localhost:8000

# Required: Supabase local configuration (from supabase status)
NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>

# Optional: Environment (default: local)
NEXUS_ENV=local

# Required in staging/prod: Internal API secret
# NEXUS_INTERNAL_SECRET=your-secret
```

To get your Supabase local credentials:
```bash
supabase status
```

## Development

```bash
# Install dependencies
npm install

# Start the development server
npm run dev

# Or from repo root
make web
```

The app runs at http://localhost:3000 by default.

**Prerequisites**:
- Supabase local must be running (`supabase start`)
- FastAPI server must be running (`make api`)

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `FASTAPI_BASE_URL` | Yes | FastAPI server URL |
| `NEXT_PUBLIC_SUPABASE_URL` | Yes | Supabase project URL (local: `http://127.0.0.1:54321`) |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Yes | Supabase anon key |
| `NEXUS_ENV` | No | Environment (default: `local`) |
| `NEXUS_INTERNAL_SECRET` | staging/prod | Internal API secret |

## Project Structure

```
src/
├── app/                    # Next.js app router
│   ├── api/                # BFF proxy routes (mirror FastAPI paths)
│   │   ├── me/
│   │   ├── libraries/
│   │   └── media/
│   ├── (authenticated)/    # Protected pages (require login)
│   │   ├── libraries/
│   │   └── media/
│   ├── login/              # Login page
│   └── auth/               # Auth callbacks
├── components/             # React components
│   ├── HtmlRenderer.tsx    # ONLY place with dangerouslySetInnerHTML
│   ├── Navbar.tsx
│   ├── Pane.tsx
│   └── ...
├── lib/                    # Utilities
│   ├── api/
│   │   └── proxy.ts        # BFF proxy helper (proxyToFastAPI)
│   ├── highlights/         # Highlight rendering utilities
│   │   ├── index.ts        # Module exports
│   │   ├── segmenter.ts    # Overlap segmentation algorithm (PR-07)
│   │   ├── canonicalCursor.ts  # DOM-to-canonical-text mapping (PR-08)
│   │   ├── applySegments.ts    # Highlight DOM application (PR-08)
│   │   └── highlights.css     # Highlight styles
│   └── supabase/
│       ├── server.ts       # Server-side Supabase client
│       └── middleware.ts   # Session refresh + auth redirects
└── middleware.ts           # Auth redirect + CSP
```

## Key Constraints

### Security

- **No tokens in localStorage**: Access tokens exist only in server runtime
- **Single HtmlRenderer**: Only component allowed to use `dangerouslySetInnerHTML`
- **BFF only**: All browser → backend traffic goes through Next.js

### Route Handlers

Each route handler must:
- Be 3-10 lines of actual logic
- Delegate to `proxyToFastAPI()` for all backend communication
- NOT perform custom request shaping beyond path parameters
- NOT add business logic (that belongs in FastAPI)

Example:
```typescript
export async function GET(req: Request, { params }: { params: { id: string } }) {
  const { id } = await params;
  return proxyToFastAPI(req, `/libraries/${id}`);
}
```

## Testing

```bash
# Run tests
npm test

# Run tests in watch mode
npm run test:watch

# Run tests for CI
npm run test:ci

# Run TypeScript type checking
npm run typecheck
```

## Highlight Libraries

The highlights module (`lib/highlights/`) provides everything needed for rendering highlights on web articles.

### Module Overview

```typescript
// Import everything from the module index
import {
  // Segmenter (PR-07)
  segmentHighlights,
  HIGHLIGHT_COLORS,
  type NormalizedHighlight,
  type Segment,
  
  // Canonical cursor (PR-08)
  buildCanonicalCursor,
  validateCanonicalText,
  codepointLength,
  BLOCK_ELEMENTS,
  
  // Apply highlights (PR-08)
  applyHighlightsToHtml,
  applyHighlightsToHtmlMemoized,
  clearHighlightCache,
  type HighlightInput,
} from '@/lib/highlights';
```

### `segmenter.ts` - Overlap Segmentation (PR-07)

A pure, deterministic overlap segmenter for highlights. This module:

- Takes a text length (codepoints) and list of highlight ranges
- Produces disjoint segments annotated with active highlight IDs
- Determines the "topmost" highlight using `(created_at_ms DESC, id ASC)` ordering
- Has no DOM or backend dependencies (used by rendering and interaction code)

```typescript
const result = segmentHighlights(textLen, highlights);
// result.segments: Segment[] - disjoint highlighted ranges
// result.droppedIds: string[] - invalid highlights that were ignored
```

**Invariants guaranteed:**
1. Segments are strictly ordered (non-overlapping)
2. No zero-width segments
3. Each segment has at least one active highlight
4. `topmostId` is the first element of `activeIds`
5. Output is deterministic regardless of input order
6. No adjacent segments with identical active sets
7. Coverage equals union of valid highlight ranges

### `canonicalCursor.ts` - DOM-to-Offset Mapping (PR-08)

Builds a mapping from DOM text nodes to codepoint offsets in canonical text. **Must match backend canonicalization exactly** (`python/nexus/services/canonicalize.py`).

```typescript
const result = buildCanonicalCursor(rootElement);
// result.nodes: CanonicalNode[] - text nodes with start/end offsets
// result.emitted: string - reconstructed canonical text
// result.length: number - codepoint length

// Validate against backend canonical_text
const isValid = validateCanonicalText(result, fragment.canonical_text, fragmentId);
```

**Canonicalization rules (matching backend):**
- Unicode NFC normalization
- Whitespace collapse (all Unicode whitespace → single space)
- Block boundaries insert `\n`
- `<br>` inserts `\n`
- Exclude `script`, `style`, hidden elements, `aria-hidden="true"`

### `applySegments.ts` - Highlight Rendering (PR-08)

Applies highlight segments to sanitized HTML by wrapping text in `<span>` elements.

```typescript
// Simple usage
const result = applyHighlightsToHtml(
  fragment.html_sanitized,
  fragment.canonical_text,
  fragment.id,
  highlights
);
// result.html: string - transformed HTML with highlight spans
// result.failedIds: string[] - highlights that couldn't be rendered
// result.validationPassed: boolean - canonical text matched

// With memoization (recommended for React)
const result = applyHighlightsToHtmlMemoized(
  fragment.html_sanitized,
  fragment.canonical_text,
  fragment.id,
  highlights
);
```

**HTML output:**
```html
<!-- Highlight spans -->
<span data-highlight-ids="h1,h2" data-highlight-top="h1" class="hl-yellow">
  highlighted text
</span>

<!-- Highlight anchors (for positioning) -->
<span data-highlight-anchor="h1"></span>
```

### `highlights.css` - Styles (PR-08)

CSS classes for highlight colors:
- `.hl-yellow` - Default yellow highlight
- `.hl-green` - Green highlight
- `.hl-blue` - Blue highlight
- `.hl-pink` - Pink highlight
- `.hl-purple` - Purple highlight

Anchors are invisible zero-width spans used for positioning the linked-items pane.

## Linting

```bash
npm run lint
```

## Building

```bash
npm run build
npm start
```
